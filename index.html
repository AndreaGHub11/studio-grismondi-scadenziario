<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scadenziario Studio Grismondi - SharePoint</title>
    
    <!-- MSAL.js Library per Azure AD Authentication -->
    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .login-container h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .login-container p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .login-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .app-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-name {
            text-align: right;
        }
        
        .user-name small {
            opacity: 0.8;
            display: block;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: white;
            color: #667eea;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #333;
        }
        
        select, input[type="month"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        select:focus, input[type="month"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .content {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .comune-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .comune-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .comune-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            cursor: pointer;
            user-select: none;
        }
        
        .comune-header:hover {
            background: #ecf0f1;
        }
        
        .comune-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        
        .comune-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .stat-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .stat-badge.scaduti {
            background: #e74c3c;
        }
        
        .stat-badge.prossimi {
            background: #f39c12;
        }
        
        .expand-icon {
            transition: transform 0.3s;
        }
        
        .expand-icon.open {
            transform: rotate(180deg);
        }
        
        .adempimenti-list {
            display: none;
            padding: 20px;
        }
        
        .adempimenti-list.open {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-badge.completato {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.in-corso {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.non-iniziato {
            background: #f8d7da;
            color: #721c24;
        }
        
        .priority-high {
            color: #e74c3c;
            font-weight: 700;
        }
        
        .priority-medium {
            color: #f39c12;
            font-weight: 700;
        }
        
        .priority-low {
            color: #95a5a6;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            transition: transform 0.2s;
        }
        
        .icon-btn:hover {
            transform: scale(1.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.open {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .modal-header h2 {
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .admin-only {
            display: none;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <h1>üè¢ Studio Grismondi</h1>
        <p>Sistema Scadenziario Integrato</p>
        <button class="login-btn" id="loginBtn">
            üîê Accedi con Microsoft
        button>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <div class="header">
            <h1>üìÖ Scadenziario Studio Grismondi</h1>
            <div class="user-info">
                <div class="user-name">
                    <strong id="userName">Utente</strong>
                    <small id="userRole">Caricamento...</small>
                </div>
                <div class="adempimenti-list">
                    <table>
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Descrizione</th>
                                <th>Scadenza</th>
                                <th>Priorit√†</th>
                                <th>Stato</th>
                                <th>Note</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${adempimenti.map(a => createAdempimentoRow(a)).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            return card;
        }

        function createAdempimentoRow(adempimento) {
            const scadenza = new Date(adempimento.Scadenza);
            const oggi = new Date();
            const diff = Math.floor((scadenza - oggi) / (1000 * 60 * 60 * 24));
            
            let scadenzaClass = '';
            if (diff < 0 && adempimento.Stato !== 'Completato') {
                scadenzaClass = 'priority-high';
            } else if (diff >= 0 && diff <= 7) {
                scadenzaClass = 'priority-medium';
            }

            const priorityClass = adempimento.Priorita === 'Alta' ? 'priority-high' : 
                                 adempimento.Priorita === 'Media' ? 'priority-medium' : 'priority-low';

            const statoClass = adempimento.Stato === 'Completato' ? 'completato' :
                              adempimento.Stato === 'In Corso' ? 'in-corso' : 'non-iniziato';

            return `
                <tr>
                    <td>${adempimento.Categoria}</td>
                    <td>${adempimento.Title}</td>
                    <td class="${scadenzaClass}">${formatDate(adempimento.Scadenza)}</td>
                    <td class="${priorityClass}">${adempimento.Priorita}</td>
                    <td><span class="status-badge ${statoClass}">${adempimento.Stato}</span></td>
                    <td>${adempimento.Note || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="icon-btn btn-edit-adempimento" data-id="${adempimento.ID}" title="Modifica">‚úèÔ∏è</button>
                            <button class="icon-btn btn-delete-adempimento" data-id="${adempimento.ID}" title="Elimina">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function toggleComune(header) {
            // Funzione rimossa - ora gestita da event listener in renderComuni()
        }

        // ============================================
        // CRUD ADEMPIMENTI
        // ============================================
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Nuovo Adempimento';
            document.getElementById('adempimentoForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('adempimentoModal').classList.add('open');
        }

        async function editAdempimento(id) {
            const adempimento = allAdempimenti.find(a => a.ID === id);
            if (!adempimento) return;

            document.getElementById('modalTitle').textContent = 'Modifica Adempimento';
            document.getElementById('editId').value = id;
            document.getElementById('formComune').value = adempimento.EnteId;
            document.getElementById('formCategoria').value = adempimento.Categoria;
            document.getElementById('formDescrizione').value = adempimento.Title;
            document.getElementById('formScadenza').value = adempimento.Scadenza.split('T')[0];
            document.getElementById('formPriorita').value = adempimento.Priorita;
            document.getElementById('formStato').value = adempimento.Stato;
            document.getElementById('formNote').value = adempimento.Note || '';

            document.getElementById('adempimentoModal').classList.add('open');
        }

        async function deleteAdempimento(id) {
            if (!confirm('Sei sicuro di voler eliminare questo adempimento?')) return;

            try {
                showLoading(true);
                
                await callSharePointAPI(
                    `web/lists/getbytitle('${LISTS.ADEMPIMENTI}')/items(${id})`,
                    'DELETE'
                );

                showAlert('Adempimento eliminato con successo', 'success');
                await loadAllData();
                
            } catch (error) {
                console.error('Error deleting:', error);
                showAlert('Errore durante l\'eliminazione', 'error');
                showLoading(false);
            }
        }

        document.getElementById('adempimentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const editId = document.getElementById('editId').value;
            const data = {
                __metadata: { type: 'SP.Data.AdempimentiListItem' },
                Title: document.getElementById('formDescrizione').value,
                EnteId: parseInt(document.getElementById('formComune').value),
                Categoria: document.getElementById('formCategoria').value,
                Scadenza: document.getElementById('formScadenza').value,
                Priorita: document.getElementById('formPriorita').value,
                Stato: document.getElementById('formStato').value,
                Note: document.getElementById('formNote').value
            };

            try {
                showLoading(true);

                if (editId) {
                    // Update
                    await callSharePointAPI(
                        `web/lists/getbytitle('${LISTS.ADEMPIMENTI}')/items(${editId})`,
                        'POST',
                        {
                            ...data,
                            __metadata: { 
                                ...data.__metadata,
                                type: 'SP.Data.AdempimentiListItem'
                            }
                        }
                    );
                    showAlert('Adempimento aggiornato con successo', 'success');
                } else {
                    // Create
                    await callSharePointAPI(
                        `web/lists/getbytitle('${LISTS.ADEMPIMENTI}')/items`,
                        'POST',
                        data
                    );
                    showAlert('Adempimento creato con successo', 'success');
                }

                closeModal();
                await loadAllData();

            } catch (error) {
                console.error('Error saving:', error);
                showAlert('Errore durante il salvataggio', 'error');
                showLoading(false);
            }
        });

        function closeModal() {
            document.getElementById('adempimentoModal').classList.remove('open');
        }

        // ============================================
        // GESTIONE ENTI (ADMIN ONLY)
        // ============================================
        async function openGestioneEnti() {
            if (userRole !== 'Admin') {
                showAlert('Solo gli amministratori possono gestire gli enti', 'error');
                return;
            }

            const entiList = document.getElementById('entiList');
            entiList.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Nome Comune</th>
                            <th>Provincia</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allEnti.map(ente => `
                            <tr>
                                <td>${ente.Title}</td>
                                <td>${ente.Provincia}</td>
                                <td>${ente.Attivo ? '‚úÖ Attivo' : '‚ùå Disattivo'}</td>
                                <td>
                                    <button class="btn btn-sm btn-toggle-ente" data-id="${ente.ID}" data-attivo="${ente.Attivo}">
                                        ${ente.Attivo ? 'Disattiva' : 'Attiva'}
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // Aggiungi event listeners per toggle enti
            document.querySelectorAll('.btn-toggle-ente').forEach(btn => {
                btn.addEventListener('click', function() {
                    toggleEnteStatus(parseInt(this.dataset.id));
                });
            });

            document.getElementById('entiModal').classList.add('open');
        }

        async function openAddEnteModal() {
            const nome = prompt('Nome Comune:');
            if (!nome) return;

            const provincia = prompt('Sigla Provincia (es. MI, BG, BS):');
            if (!provincia) return;

            try {
                showLoading(true);

                await callSharePointAPI(
                    `web/lists/getbytitle('${LISTS.ENTI}')/items`,
                    'POST',
                    {
                        __metadata: { type: 'SP.Data.EntiListItem' },
                        Title: nome,
                        Provincia: provincia.toUpperCase(),
                        Attivo: true
                    }
                );

                showAlert('Ente aggiunto con successo', 'success');
                await loadAllData();
                openGestioneEnti();

            } catch (error) {
                console.error('Error adding ente:', error);
                showAlert('Errore durante l\'aggiunta dell\'ente', 'error');
                showLoading(false);
            }
        }

        async function toggleEnteStatus(id) {
            const ente = allEnti.find(e => e.ID === id);
            if (!ente) return;

            try {
                showLoading(true);

                await callSharePointAPI(
                    `web/lists/getbytitle('${LISTS.ENTI}')/items(${id})`,
                    'POST',
                    {
                        __metadata: { type: 'SP.Data.EntiListItem' },
                        Attivo: !ente.Attivo
                    }
                );

                showAlert('Stato ente aggiornato', 'success');
                await loadAllData();
                openGestioneEnti();

            } catch (error) {
                console.error('Error updating ente:', error);
                showAlert('Errore durante l\'aggiornamento', 'error');
                showLoading(false);
            }
        }

        function closeEntiModal() {
            document.getElementById('entiModal').classList.remove('open');
        }

        // ============================================
        // EXPORT CSV (ADMIN ONLY)
        // ============================================
        function exportCSV() {
            if (userRole !== 'Admin') {
                showAlert('Solo gli amministratori possono esportare i dati', 'error');
                return;
            }

            const headers = ['Comune', 'Provincia', 'Categoria', 'Descrizione', 'Scadenza', 'Priorit√†', 'Stato', 'Note'];
            const rows = [];

            allAdempimenti.forEach(adempimento => {
                const ente = allEnti.find(e => e.ID === adempimento.EnteId);
                if (!ente) return;

                rows.push([
                    ente.Title,
                    ente.Provincia,
                    adempimento.Categoria,
                    adempimento.Title,
                    formatDate(adempimento.Scadenza),
                    adempimento.Priorita,
                    adempimento.Stato,
                    adempimento.Note || ''
                ]);
            });

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `scadenziario_${formatDate(new Date())}.csv`;
            link.click();

            showAlert('Export completato con successo', 'success');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function filterData() {
            renderComuni();
        }

        async function syncData() {
            showAlert('Sincronizzazione in corso...', 'info');
            await loadAllData();
            showAlert('Dati sincronizzati con successo', 'success');
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('comuniContainer').style.display = show ? 'none' : 'block';
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('load', async () => {
            console.log('üöÄ Applicazione caricata');
            console.log('üì¶ MSAL Instance:', msalInstance);
            console.log('üîë MSAL Config:', msalConfig);
            
            try {
                await msalInstance.initialize();
                console.log('‚úÖ MSAL inizializzato');
                
                const accounts = msalInstance.getAllAccounts();
                console.log('üë• Account trovati:', accounts.length);
                
                if (accounts.length > 0) {
                    console.log('üîÑ Account esistente, auto-login...');
                    await handleAuthentication();
                } else {
                    console.log('üìù Nessun account, mostra schermata login');
                }
            } catch (error) {
                console.error('‚ùå Errore inizializzazione MSAL:', error);
                alert('Errore inizializzazione: ' + error.message);
            }

            // ============================================
            // EVENT LISTENERS
            // ============================================
            
            // Login/Logout
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Filtri
            document.getElementById('filterComune').addEventListener('change', filterData);
            document.getElementById('filterCategoria').addEventListener('change', filterData);
            document.getElementById('filterStato').addEventListener('change', filterData);
            document.getElementById('filterMese').addEventListener('change', filterData);
            
            // Bottoni azioni
            document.getElementById('btnAddAdempimento').addEventListener('click', openAddModal);
            document.getElementById('btnExport').addEventListener('click', exportCSV);
            document.getElementById('btnManageEnti').addEventListener('click', openGestioneEnti);
            document.getElementById('btnSync').addEventListener('click', syncData);
            
            // Modal
            document.getElementById('btnCloseModal').addEventListener('click', closeModal);
            document.getElementById('btnCloseEntiModal').addEventListener('click', closeEntiModal);
            document.getElementById('btnAddEnte').addEventListener('click', openAddEnteModal);
            
            console.log('‚úÖ Event listeners registrati');
        });
    </script>
</body>
</html>
                <button class="logout-btn" id="logoutBtn">Esci</button>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <label>üìç Comune:</label>
                <select id="filterComune">
                    <option value="">Tutti i comuni</option>
                </select>
            </div>

            <div class="filter-group">
                <label>üìÇ Categoria:</label>
                <select id="filterCategoria">
                    <option value="">Tutte</option>
                    <option value="Contabilit√†">Contabilit√†</option>
                    <option value="Tributi">Tributi</option>
                    <option value="Personale">Personale</option>
                    <option value="Altro">Altro</option>
                </select>
            </div>

            <div class="filter-group">
                <label>‚ö†Ô∏è Stato:</label>
                <select id="filterStato">
                    <option value="">Tutti</option>
                    <option value="Non Iniziato">Non Iniziato</option>
                    <option value="In Corso">In Corso</option>
                    <option value="Completato">Completato</option>
                </select>
            </div>

            <div class="filter-group">
                <label>üìÖ Mese:</label>
                <input type="month" id="filterMese">
            </div>

            <button class="btn btn-success" id="btnAddAdempimento">
                ‚ûï Nuovo Adempimento
            </button>

            <button class="btn admin-only" id="btnExport">
                üìä Esporta CSV
            </button>

            <button class="btn admin-only" id="btnManageEnti">
                üèõÔ∏è Gestisci Enti
            </button>

            <button class="btn" id="btnSync">
                üîÑ Sincronizza
            </button>
        </div>

        <div class="content">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Caricamento dati da SharePoint...</p>
            </div>

            <div id="alertContainer"></div>

            <div id="comuniContainer"></div>
        </div>
    </div>

    <!-- Modal Nuovo/Modifica Adempimento -->
    <div id="adempimentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuovo Adempimento</h2>
            </div>
            <form id="adempimentoForm">
                <input type="hidden" id="editId">
                
                <div class="form-group">
                    <label>Comune *</label>
                    <select id="formComune" required>
                        <option value="">Seleziona comune...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Categoria *</label>
                    <select id="formCategoria" required>
                        <option value="Contabilit√†">Contabilit√†</option>
                        <option value="Tributi">Tributi</option>
                        <option value="Personale">Personale</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Descrizione *</label>
                    <textarea id="formDescrizione" required></textarea>
                </div>

                <div class="form-group">
                    <label>Scadenza *</label>
                    <input type="date" id="formScadenza" required>
                </div>

                <div class="form-group">
                    <label>Priorit√† *</label>
                    <select id="formPriorita" required>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Bassa">Bassa</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Stato *</label>
                    <select id="formStato" required>
                        <option value="Non Iniziato">Non Iniziato</option>
                        <option value="In Corso">In Corso</option>
                        <option value="Completato">Completato</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Note</label>
                    <textarea id="formNote"></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Salva</button>
                    <button type="button" class="btn" id="btnCloseModal">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestione Enti (Admin Only) -->
    <div id="entiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üèõÔ∏è Gestione Enti</h2>
            </div>
            <div id="entiContent">
                <button class="btn btn-success" id="btnAddEnte" style="margin-bottom: 15px;">
                    ‚ûï Nuovo Ente
                </button>
                <div id="entiList"></div>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn" id="btnCloseEntiModal">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAZIONE AZURE AD & SharePoint
        // ============================================
        const msalConfig = {
            auth: {
                clientId: '49aa6405-1925-418e-a707-6a41979edba6',
                authority: 'https://login.microsoftonline.com/7f07be7a-b1c7-42ca-8f8b-ff793e29b450',
                redirectUri: 'https://andreagHub11.github.io/studio-grismondi-scadenziario/'
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: true
            }
        };

        const loginRequest = {
            scopes: ['User.Read', 'Sites.ReadWrite.All']
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // SharePoint Configuration
        const SHAREPOINT_SITE = 'https://studiogrismondi.sharepoint.com/sites/SitodiComunicazione';
        
        // Liste SharePoint
        const LISTS = {
            ENTI: 'Enti',
            ADEMPIMENTI: 'Adempimenti',
            CATEGORIE: 'Categorie',
            UTENTI: 'Utenti'
        };

        // Stato globale
        let currentUser = null;
        let userRole = null;
        let accessToken = null;
        let allEnti = [];
        let allAdempimenti = [];

        // ============================================
        // AUTENTICAZIONE
        // ============================================
        async function login() {
            console.log('üîê Tentativo di login...');
            try {
                console.log('üìã Login request:', loginRequest);
                console.log('‚öôÔ∏è MSAL Config:', msalConfig);
                
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                console.log('‚úÖ Login response:', loginResponse);
                
                currentUser = loginResponse.account;
                await handleAuthentication();
            } catch (error) {
                console.error('‚ùå Login error completo:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                alert('ERRORE LOGIN: ' + error.message + '\n\nControlla la console (F12) per dettagli');
                showAlert('Errore durante il login: ' + error.message, 'error');
            }
        }

        async function handleAuthentication() {
            try {
                const account = msalInstance.getAllAccounts()[0];
                if (!account) {
                    return;
                }

                currentUser = account;

                // Ottieni access token
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    ...loginRequest,
                    account: currentUser
                });
                
                accessToken = tokenResponse.accessToken;

                // Carica ruolo utente
                await loadUserRole();

                // Mostra applicazione
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                
                document.getElementById('userName').textContent = currentUser.name || currentUser.username;
                document.getElementById('userRole').textContent = userRole === 'Admin' ? 'üëë Amministratore' : 'üë§ Utente';

                // Mostra/nascondi funzioni admin
                if (userRole === 'Admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                }

                // Carica dati
                await loadAllData();

            } catch (error) {
                console.error('Auth error:', error);
                showAlert('Errore di autenticazione. Riprova.', 'error');
            }
        }

        async function logout() {
            await msalInstance.logoutPopup();
            location.reload();
        }

        // ============================================
        // SHAREPOINT API CALLS
        // ============================================
        async function callSharePointAPI(endpoint, method = 'GET', body = null) {
            const url = `${SHAREPOINT_SITE}/_api/${endpoint}`;
            
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'Accept': 'application/json;odata=verbose',
                'Content-Type': 'application/json;odata=verbose'
            };

            const options = {
                method,
                headers
            };

            if (body && method !== 'GET') {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(url, options);
            
            if (!response.ok) {
                throw new Error(`SharePoint API error: ${response.status}`);
            }

            if (method === 'DELETE') {
                return { success: true };
            }

            return await response.json();
        }

        async function loadUserRole() {
            try {
                // Cerca utente nella lista Utenti SharePoint
                const userEmail = currentUser.username;
                const result = await callSharePointAPI(
                    `web/lists/getbytitle('${LISTS.UTENTI}')/items?$filter=Email eq '${userEmail}'`
                );

                if (result.d.results && result.d.results.length > 0) {
                    userRole = result.d.results[0].Ruolo || 'User';
                } else {
                    // Se utente non trovato, crea entry con ruolo User
                    userRole = 'User';
                    await addUserToSharePoint(userEmail);
                }
            } catch (error) {
                console.error('Error loading user role:', error);
                userRole = 'User';
            }
        }

        async function addUserToSharePoint(email) {
            try {
                await callSharePointAPI(
                    `web/lists/getbytitle('${LISTS.UTENTI}')/items`,
                    'POST',
                    {
                        __metadata: { type: 'SP.Data.UtentiListItem' },
                        Title: currentUser.name || email,
                        Email: email,
                        Ruolo: 'User'
                    }
                );
            } catch (error) {
                console.error('Error adding user:', error);
            }
        }

        async function loadAllData() {
            try {
                showLoading(true);

                // Carica Enti
                const entiResult = await callSharePointAPI(
                    `web/lists/getbytitle('${LISTS.ENTI}')/items?$select=ID,Title,Provincia,Attivo`
                );
                allEnti = entiResult.d.results;

                // Popola dropdown comuni
                populateComuneDropdowns();

                // Carica Adempimenti
                const adempimentiResult = await callSharePointAPI(
                    `web/lists/getbytitle('${LISTS.ADEMPIMENTI}')/items?$select=ID,Title,EnteId,Categoria,Scadenza,Priorita,Stato,Note`
                );
                allAdempimenti = adempimentiResult.d.results;

                // Renderizza dati
                renderComuni();
                showLoading(false);

            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Errore nel caricamento dei dati. Controlla la console.', 'error');
                showLoading(false);
            }
        }

        // ============================================
        // RENDERING
        // ============================================
        function populateComuneDropdowns() {
            const entiAttivi = allEnti.filter(e => e.Attivo === true || e.Attivo === 'true');
            
            const filterSelect = document.getElementById('filterComune');
            const formSelect = document.getElementById('formComune');

            filterSelect.innerHTML = '<option value="">Tutti i comuni</option>';
            formSelect.innerHTML = '<option value="">Seleziona comune...</option>';

            entiAttivi.forEach(ente => {
                const option1 = document.createElement('option');
                option1.value = ente.ID;
                option1.textContent = `${ente.Title} (${ente.Provincia})`;
                filterSelect.appendChild(option1);

                const option2 = option1.cloneNode(true);
                formSelect.appendChild(option2);
            });
        }

        function renderComuni() {
            const container = document.getElementById('comuniContainer');
            container.innerHTML = '';

            const filters = {
                comune: document.getElementById('filterComune').value,
                categoria: document.getElementById('filterCategoria').value,
                stato: document.getElementById('filterStato').value,
                mese: document.getElementById('filterMese').value
            };

            let filteredEnti = allEnti.filter(e => e.Attivo === true || e.Attivo === 'true');

            if (filters.comune) {
                filteredEnti = filteredEnti.filter(e => e.ID == filters.comune);
            }

            filteredEnti.forEach(ente => {
                const adempimenti = getAdempimentiForEnte(ente.ID, filters);
                
                if (adempimenti.length === 0 && filters.comune === '') return;

                const card = createComuneCard(ente, adempimenti);
                container.appendChild(card);
            });

            if (container.children.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Nessun adempimento trovato con i filtri selezionati.</div>';
            }

            // Aggiungi event listeners per toggle e azioni dopo il rendering
            document.querySelectorAll('.comune-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const card = this.parentElement;
                    const list = card.querySelector('.adempimenti-list');
                    const icon = this.querySelector('.expand-icon');
                    
                    list.classList.toggle('open');
                    icon.classList.toggle('open');
                });
            });

            document.querySelectorAll('.btn-edit-adempimento').forEach(btn => {
                btn.addEventListener('click', function() {
                    editAdempimento(parseInt(this.dataset.id));
                });
            });

            document.querySelectorAll('.btn-delete-adempimento').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteAdempimento(parseInt(this.dataset.id));
                });
            });
        }

        function getAdempimentiForEnte(enteId, filters) {
            let adempimenti = allAdempimenti.filter(a => a.EnteId == enteId);

            if (filters.categoria) {
                adempimenti = adempimenti.filter(a => a.Categoria === filters.categoria);
            }

            if (filters.stato) {
                adempimenti = adempimenti.filter(a => a.Stato === filters.stato);
            }

            if (filters.mese) {
                const [year, month] = filters.mese.split('-');
                adempimenti = adempimenti.filter(a => {
                    if (!a.Scadenza) return false;
                    const scadenzaDate = new Date(a.Scadenza);
                    return scadenzaDate.getFullYear() == year && 
                           (scadenzaDate.getMonth() + 1) == month;
                });
            }

            return adempimenti;
        }

        function createComuneCard(ente, adempimenti) {
            const card = document.createElement('div');
            card.className = 'comune-card';

            const oggi = new Date();
            const scaduti = adempimenti.filter(a => {
                const scadenza = new Date(a.Scadenza);
                return scadenza < oggi && a.Stato !== 'Completato';
            }).length;

            const prossimi = adempimenti.filter(a => {
                const scadenza = new Date(a.Scadenza);
                const diff = (scadenza - oggi) / (1000 * 60 * 60 * 24);
                return diff >= 0 && diff <= 7 && a.Stato !== 'Completato';
            }).length;

            card.innerHTML = `
                <div class="comune-header" onclick="toggleComune(this)">
                    <div class="comune-name">${ente.Title} (${ente.Provincia})</div>
                    <div class="comune-stats">
                        <span class="stat-badge">${adempimenti.length} totali</span>
                        ${scaduti > 0 ? `<span class="stat-badge scaduti">${scaduti} scaduti</span>` : ''}
                        ${prossimi > 0 ? `<span class="stat-badge prossimi">${prossimi} prossimi</span>` : ''}
                        <span class="expand-icon">‚ñº</span>
                    </div>
                </div>
