<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scadenziario Studio Grismondi V16.2</title>
    
    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #90ee90 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(79, 172, 254, 0.3);
            text-align: center;
        }
        
        .logo { font-size: 60px; margin-bottom: 20px; }
        .login-container h1 { color: #4facfe; margin-bottom: 10px; font-size: 28px; }
        .login-container p { color: #666; margin-bottom: 35px; font-size: 16px; }
        
        .login-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.4);
            width: 100%;
        }
        
        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(79, 172, 254, 0.6);
        }
        
        .app-container {
            display: none;
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(79, 172, 254, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { font-size: 24px; }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-name { text-align: right; }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .logout-btn:hover { background: white; color: #4facfe; }
        
        .controls {
            padding: 20px 40px;
            background: #f8f9fa;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.3);
        }
        
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.5); 
        }
        
        .btn-success { 
            background: linear-gradient(135deg, #90ee90 0%, #7bed9f 100%); 
            box-shadow: 0 3px 10px rgba(144, 238, 144, 0.3);
        }
        
        .btn-success:hover { box-shadow: 0 5px 15px rgba(144, 238, 144, 0.5); }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        select, input { 
            padding: 8px 12px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px; 
        }
        
        select:focus, input:focus { outline: none; border-color: #4facfe; }
        
        .content { padding: 40px; min-height: 400px; }
        .loading { text-align: center; padding: 60px; color: #666; }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .adempimento-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .adempimento-card:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.15);
        }
        
        .adempimento-header {
            padding: 18px 25px;
            background: linear-gradient(to right, #f8f9ff 0%, #f0fff4 100%);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .adempimento-header:hover {
            background: linear-gradient(to right, #eef0ff 0%, #e0ffe0 100%);
        }
        
        .adempimento-titolo {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .adempimento-meta {
            font-size: 13px;
            color: #6b7280;
        }
        
        .adempimento-stats {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .stat-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .stat-badge.totali { background: #dbeafe; color: #1e40af; }
        .stat-badge.non-gestiti { background: #fee2e2; color: #991b1b; }
        .stat-badge.in-corso { background: #fef3c7; color: #92400e; }
        .stat-badge.completati { background: #d1fae5; color: #065f46; }
        
        .expand-icon {
            font-size: 18px;
            transition: transform 0.3s;
            margin-left: 10px;
        }
        
        .expand-icon.open { transform: rotate(180deg); }
        
        .comuni-list {
            display: none;
            padding: 20px;
            background: #fafbfc;
        }
        
        .comuni-list.open { display: block; }
        
        .comune-row {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .comune-row:hover {
            border-color: #4facfe;
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.1);
        }
        
        .comune-info { flex: 1; }
        .comune-nome { font-weight: 600; color: #1f2937; margin-bottom: 5px; }
        .comune-note { font-size: 12px; color: #6b7280; font-style: italic; }
        
        .comune-stato {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .stato-non-gestito { background: #fee2e2; color: #991b1b; }
        .stato-in-corso { background: #fef3c7; color: #92400e; }
        .stato-completato { background: #d1fae5; color: #065f46; }
        
        .progress-bar {
            width: 100px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #90ee90 100%);
            transition: width 0.3s;
        }
        
        .comune-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px 8px;
            transition: transform 0.2s;
            border-radius: 4px;
        }
        
        .icon-btn:hover {
            transform: scale(1.2);
            background: #f3f4f6;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.open { display: flex; }
        
        .modal-content {
            background: white;
            padding: 35px;
            border-radius: 20px;
            max-width: 650px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 70px rgba(0,0,0,0.3);
        }
        
        .modal-header { 
            margin-bottom: 25px; 
            padding-bottom: 20px; 
            border-bottom: 2px solid #e0f2fe; 
        }
        
        .modal-header h2 { color: #4facfe; font-size: 24px; }
        
        .form-group { margin-bottom: 20px; }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-actions { display: flex; gap: 12px; margin-top: 30px; flex-wrap: wrap; }
        
        .checkbox-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 6px;
        }
        
        .checkbox-header-title {
            font-weight: 600;
            color: #1f2937;
        }
        
        .checkbox-header-actions {
            display: flex;
            gap: 8px;
        }
        
        .checkbox-group {
            max-height: 250px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafbfc;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            transition: background 0.2s;
            background: white;
            border: 1px solid #e5e7eb;
        }
        
        .checkbox-item:hover { 
            background: #f0f9ff;
            border-color: #4facfe;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }
        
        .alert {
            padding: 18px 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .empty-state { 
            text-align: center; 
            padding: 80px 20px; 
            color: #9ca3af; 
        }
        
        .empty-state-icon { font-size: 80px; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { color: #6b7280; margin-bottom: 10px; font-size: 20px; }
        .empty-state p { color: #9ca3af; }
        
        .quick-add-comune {
            display: flex;
            gap: 10px;
            padding: 12px;
            background: #fff7ed;
            border: 2px dashed #fb923c;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .quick-add-comune input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .quick-add-comune input:focus {
            border-color: #fb923c;
            outline: none;
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <div class="logo">üè¢</div>
        <h1>Studio Grismondi</h1>
        <p>Sistema Scadenziario V16.2</p>
        <button class="login-btn" id="loginBtn">üîê Accedi con Microsoft</button>
    </div>

    <div id="appContainer" class="app-container">
        <div class="header">
            <h1>üìÖ Scadenziario Studio Grismondi</h1>
            <div class="user-info">
                <div class="user-name">
                    <strong id="userName">Utente</strong>
                    <small id="userRole">Caricamento...</small>
                </div>
                <button class="logout-btn" id="logoutBtn">Esci</button>
            </div>
        </div>

        <div class="controls">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-weight: 600;">üìÖ Mese:</label>
                <select id="filterMese" style="min-width: 180px;">
                    <option value="">Tutti i mesi</option>
                </select>
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-weight: 600;">üìÇ Tipologia:</label>
                <select id="filterTipologia">
                    <option value="">Tutte</option>
                    <option value="Contabilit√†">Contabilit√†</option>
                    <option value="Tributi">Tributi</option>
                    <option value="Personale">Personale</option>
                    <option value="Altro">Altro</option>
                </select>
            </div>

            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-weight: 600;">‚ö†Ô∏è Stato:</label>
                <select id="filterStato">
                    <option value="">Tutti</option>
                    <option value="Non Gestito">Non Gestito</option>
                    <option value="In Corso">In Corso</option>
                    <option value="Completato">Completato</option>
                </select>
            </div>

            <button class="btn btn-success" id="btnAddAdempimento">
                ‚ûï Nuovo Adempimento
            </button>

            <button class="btn" id="btnSync">
                üîÑ Sincronizza
            </button>
        </div>

        <div class="content">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Caricamento dati da SharePoint...</p>
            </div>

            <div id="alertContainer"></div>
            <div id="adempimentiContainer"></div>
        </div>
    </div>

    <!-- Modal Nuovo Adempimento -->
    <div id="adempimentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Nuovo Adempimento</h2>
            </div>
            <form id="adempimentoForm">
                <div class="form-group">
                    <label>Mese *</label>
                    <input type="month" id="formMese" required>
                </div>

                <div class="form-group">
                    <label>Titolo *</label>
                    <input type="text" id="formTitolo" required placeholder="es. Versamento IMU">
                </div>

                <div class="form-group">
                    <label>Descrizione</label>
                    <textarea id="formDescrizione" placeholder="Descrivi l'adempimento..."></textarea>
                </div>

                <div class="form-group">
                    <label>Tipologia *</label>
                    <select id="formTipologia" required>
                        <option value="">Seleziona...</option>
                        <option value="Contabilit√†">Contabilit√†</option>
                        <option value="Tributi">Tributi</option>
                        <option value="Personale">Personale</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Data Scadenza *</label>
                    <input type="date" id="formDataScadenza" required>
                </div>

                <div class="form-group">
                    <label>Comuni da assegnare *</label>
                    
                    <!-- Quick Add Comune -->
                    <div class="quick-add-comune">
                        <input type="text" id="quickAddComuneNome" placeholder="Nome Comune (es. Milano)">
                        <input type="text" id="quickAddComuneProvincia" placeholder="Provincia (es. MI)" maxlength="2" style="width: 80px; text-transform: uppercase;">
                        <button type="button" class="btn btn-success btn-small" onclick="quickAddComune()">
                            ‚ûï Aggiungi
                        </button>
                    </div>
                    
                    <!-- Checkbox Header con Seleziona/Deseleziona Tutti -->
                    <div class="checkbox-header">
                        <span class="checkbox-header-title" id="comuniSelectedCount">0 comuni selezionati</span>
                        <div class="checkbox-header-actions">
                            <button type="button" class="btn btn-small" onclick="selectAllComuni()">
                                ‚úÖ Seleziona Tutti
                            </button>
                            <button type="button" class="btn btn-small" onclick="deselectAllComuni()">
                                ‚ùå Deseleziona Tutti
                            </button>
                        </div>
                    </div>
                    
                    <div class="checkbox-group" id="adempimentoComuniCheckboxes">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">üíæ Crea Adempimento</button>
                    <button type="button" class="btn" id="btnCloseAdempimentoModal">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Note -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Note - <span id="noteComune"></span></h2>
            </div>
            <form id="noteForm">
                <input type="hidden" id="noteRecordId">
                
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="formNote" rows="6" placeholder="Aggiungi note per questo comune..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">üíæ Salva Note</button>
                    <button type="button" class="btn" id="btnCloseNoteModal">‚ùå Chiudi</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('üöÄ Scadenziario V16.2 - Con RETRY e DELAY');

        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: '931c14fe-e538-4ae3-a336-0d3a9fd75c49',
                authority: 'https://login.microsoftonline.com/7f07be7a-b1c7-42ca-8f8b-ff793e29b450',
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: true }
        };

        const loginRequest = { scopes: ['User.Read', 'Sites.Read.All', 'Sites.ReadWrite.All'] };
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        // SharePoint Config
        const SHAREPOINT_HOSTNAME = 'studiogrismondi.sharepoint.com';
        const SITE_PATH = '/';
        const LISTS = {
            COMUNI: 'Scadenziario_Comuni',
            ADEMPIMENTI: 'Scadenziario_Adempimenti',
            ENTI: 'Scadenziario_Enti'
        };
        const ADMIN_EMAIL = 'info@studiogrismondisrl.it';

        // Global variables
        let currentUser, userRole, accessToken, siteId;
        let allComuni = [], allAdempimenti = [], allEnti = [];
        let meseCorrente = null;

        // Authentication Functions
        async function login() {
            console.log('Login initiated');
            try {
                await msalInstance.initialize();
                const resp = await msalInstance.loginPopup(loginRequest);
                currentUser = resp.account;
                await handleAuth();
            } catch (err) {
                console.error('Login error:', err);
                alert('Errore login: ' + err.message);
            }
        }

        async function handleAuth() {
            try {
                const account = msalInstance.getAllAccounts()[0];
                if (!account) return;

                currentUser = account;
                const tokenResp = await msalInstance.acquireTokenSilent({ 
                    ...loginRequest, 
                    account: currentUser 
                });
                accessToken = tokenResp.accessToken;
                
                userRole = currentUser.username.toLowerCase() === ADMIN_EMAIL.toLowerCase() ? 'Admin' : 'User';
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userName').textContent = currentUser.name || currentUser.username;
                document.getElementById('userRole').textContent = userRole === 'Admin' ? 'üëë Amministratore' : 'üë§ Utente';

                console.log('Auth successful, loading data...');
                await loadData();
            } catch (err) {
                console.error('Auth error:', err);
                if (err.name === 'InteractionRequiredAuthError') {
                    await login();
                } else {
                    showAlert('Errore autenticazione: ' + err.message, 'error');
                }
            }
        }

        async function logout() {
            await msalInstance.logoutPopup();
            location.reload();
        }

        // Graph API Functions
        async function callGraph(endpoint, method = 'GET', body = null) {
            const url = `https://graph.microsoft.com/v1.0/${endpoint}`;
            const options = {
                method,
                headers: { 
                    'Authorization': `Bearer ${accessToken}`, 
                    'Content-Type': 'application/json' 
                }
            };

            if (body && (method === 'POST' || method === 'PATCH')) {
                options.body = JSON.stringify(body);
            }

            const resp = await fetch(url, options);
            if (!resp.ok) {
                const errorText = await resp.text();
                console.error('API Error:', resp.status, errorText);
                throw new Error(`API Error: ${resp.status}`);
            }
            if (method === 'DELETE' || resp.status === 204) return { success: true };
            return await resp.json();
        }

        async function getSiteId() {
            if (siteId) return siteId;
            console.log('Getting site ID for:', SHAREPOINT_HOSTNAME, SITE_PATH);
            const result = await callGraph(`sites/${SHAREPOINT_HOSTNAME}:${SITE_PATH}`);
            siteId = result.id;
            console.log('‚úÖ Site ID:', siteId);
            return siteId;
        }

        async function getListItems(listName) {
            const site = await getSiteId();
            console.log(`üì• Loading items from list: ${listName}`);
            const result = await callGraph(`sites/${site}/lists/${listName}/items?expand=fields&$top=5000`);
            console.log(`‚úÖ Loaded ${result.value.length} items from ${listName}`);
            return result.value.map(item => ({ ID: item.id, ...item.fields }));
        }

        async function createItem(listName, data) {
            const site = await getSiteId();
            console.log(`‚ûï Creating item in ${listName}:`, data);
            return await callGraph(`sites/${site}/lists/${listName}/items`, 'POST', { fields: data });
        }

        async function updateItem(listName, itemId, data) {
            const site = await getSiteId();
            console.log(`‚úèÔ∏è Updating item ${itemId} in ${listName}:`, data);
            return await callGraph(`sites/${site}/lists/${listName}/items/${itemId}/fields`, 'PATCH', data);
        }

        // Data Loading
        async function loadData() {
            try {
                showLoading(true);
                console.log('üîÑ Loading data from SharePoint...');
                
                allComuni = (await getListItems(LISTS.COMUNI)).filter(c => c.StatoEnte === 'Attivo');
                console.log(`‚úÖ Loaded ${allComuni.length} comuni:`, allComuni);
                
                allAdempimenti = await getListItems(LISTS.ADEMPIMENTI);
                console.log(`‚úÖ Loaded ${allAdempimenti.length} adempimenti`);
                
                allEnti = await getListItems(LISTS.ENTI);
                console.log(`‚úÖ Loaded ${allEnti.length} enti assignments`);
                
                populateFilterMesi();
                renderAdempimenti();
                
                showLoading(false);
                showAlert('‚úÖ Dati caricati con successo!', 'success');
            } catch (err) {
                console.error('‚ùå Load error:', err);
                showAlert('‚ùå Errore caricamento: ' + err.message, 'error');
                showLoading(false);
            }
        }

        function populateComuniSelectors() {
            console.log('üîÑ Popolamento checkbox comuni...');
            const container = document.getElementById('adempimentoComuniCheckboxes');
            if (!container) {
                console.error('‚ùå Container checkbox comuni non trovato!');
                return;
            }
            
            container.innerHTML = '';
            
            if (allComuni.length === 0) {
                console.warn('‚ö†Ô∏è Nessun comune trovato!');
                container.innerHTML = `
                    <div style="color: #666; padding: 20px; text-align: center;">
                        <p style="margin-bottom: 10px;">‚ö†Ô∏è Nessun comune attivo trovato.</p>
                        <p style="font-size: 12px;">Usa "Aggiungi" qui sopra per creare un nuovo comune!</p>
                    </div>
                `;
                return;
            }
            
            console.log(`üìã Creazione ${allComuni.length} checkbox...`);
            allComuni.forEach((comune, index) => {
                const comuneNome = comune.Title || comune.Comune || 'Sconosciuto';
                const provincia = comune.Provincia || '';
                
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" 
                           id="comune_${comune.ID}" 
                           value="${comuneNome}" 
                           onchange="updateComuniCount()">
                    <label for="comune_${comune.ID}">
                        <strong>${comuneNome}</strong> ${provincia ? `<span style="color: #6b7280;">(${provincia})</span>` : ''}
                    </label>
                `;
                container.appendChild(div);
                console.log(`‚úÖ Checkbox ${index + 1} creata: ${comuneNome}`);
            });
            
            console.log(`‚úÖ Popolate ${allComuni.length} checkbox comuni!`);
            updateComuniCount();
        }

        function updateComuniCount() {
            const checked = document.querySelectorAll('#adempimentoComuniCheckboxes input[type="checkbox"]:checked').length;
            const total = document.querySelectorAll('#adempimentoComuniCheckboxes input[type="checkbox"]').length;
            const countEl = document.getElementById('comuniSelectedCount');
            if (countEl) {
                countEl.textContent = `${checked} di ${total} comuni selezionati`;
            }
        }

        function selectAllComuni() {
            document.querySelectorAll('#adempimentoComuniCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateComuniCount();
            console.log('‚úÖ Tutti i comuni selezionati');
        }

        function deselectAllComuni() {
            document.querySelectorAll('#adempimentoComuniCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateComuniCount();
            console.log('‚ùå Tutti i comuni deselezionati');
        }

        async function quickAddComune() {
            const nome = document.getElementById('quickAddComuneNome').value.trim();
            const provincia = document.getElementById('quickAddComuneProvincia').value.trim().toUpperCase();
            
            if (!nome) {
                showAlert('‚ö†Ô∏è Inserisci il nome del comune!', 'error');
                return;
            }
            
            try {
                console.log(`‚ûï Aggiunta rapida comune: ${nome} (${provincia})`);
                
                const newComune = await createItem(LISTS.COMUNI, {
                    Title: nome,
                    Provincia: provincia,
                    StatoEnte: 'Attivo'
                });
                
                console.log('‚úÖ Comune aggiunto:', newComune);
                showAlert(`‚úÖ Comune "${nome}" aggiunto con successo!`, 'success');
                
                // Ricarica comuni
                allComuni = (await getListItems(LISTS.COMUNI)).filter(c => c.StatoEnte === 'Attivo');
                populateComuniSelectors();
                
                // Pulisci campi
                document.getElementById('quickAddComuneNome').value = '';
                document.getElementById('quickAddComuneProvincia').value = '';
                
            } catch (err) {
                console.error('‚ùå Errore aggiunta comune:', err);
                showAlert('‚ùå Errore: ' + err.message, 'error');
            }
        }

        function populateFilterMesi() {
            const select = document.getElementById('filterMese');
            if (!select) return;
            
            const mesi = new Set();
            allAdempimenti.forEach(a => {
                if (a.AnnoMese) mesi.add(a.AnnoMese);
            });
            
            const sortedMesi = Array.from(mesi).sort().reverse();
            
            select.innerHTML = '<option value="">Tutti i mesi</option>';
            sortedMesi.forEach(mese => {
                const option = document.createElement('option');
                option.value = mese;
                option.textContent = formatMese(mese);
                select.appendChild(option);
            });
            
            if (sortedMesi.length > 0) {
                meseCorrente = sortedMesi[0];
                select.value = meseCorrente;
            }
        }

        function renderAdempimenti() {
            const container = document.getElementById('adempimentiContainer');
            if (!container) return;
            
            const filterMese = document.getElementById('filterMese')?.value || '';
            const filterTipologia = document.getElementById('filterTipologia')?.value || '';
            const filterStato = document.getElementById('filterStato')?.value || '';
            
            let filtered = [...allAdempimenti];
            
            if (filterMese) {
                filtered = filtered.filter(a => a.AnnoMese === filterMese);
            }
            
            if (filterTipologia) {
                filtered = filtered.filter(a => a.Tipologia === filterTipologia);
            }
            
            if (filterStato) {
                filtered = filtered.filter(a => {
                    const entiAdempimento = allEnti.filter(e => e.AdempimentoID == a.ID);
                    return entiAdempimento.some(e => e.StatoEnte === filterStato);
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>Nessun adempimento trovato</h3>
                        <p>Usa "Nuovo Adempimento" per iniziare!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(a => createAdempimentoCard(a)).join('');
            
            // Attach toggle listeners
            document.querySelectorAll('.adempimento-toggle').forEach(el => {
                el.addEventListener('click', function() {
                    const card = this.closest('.adempimento-card');
                    const list = card.querySelector('.comuni-list');
                    const icon = this.querySelector('.expand-icon');
                    
                    list.classList.toggle('open');
                    icon.classList.toggle('open');
                });
            });
        }

        function createAdempimentoCard(adempimento) {
            const enti = allEnti.filter(e => e.AdempimentoID == adempimento.ID);
            
            const totali = enti.length;
            const nonGestiti = enti.filter(e => !e.StatoEnte || e.StatoEnte === 'Non Gestito').length;
            const inCorso = enti.filter(e => e.StatoEnte === 'In Corso').length;
            const completati = enti.filter(e => e.StatoEnte === 'Completato').length;
            
            const scadenza = adempimento.DataScadenza ? 
                new Date(adempimento.DataScadenza).toLocaleDateString('it-IT') : '-';
            
            return `
                <div class="adempimento-card">
                    <div class="adempimento-header adempimento-toggle">
                        <div>
                            <div class="adempimento-titolo">${adempimento.Title}</div>
                            <div class="adempimento-meta">
                                üìÖ ${formatMese(adempimento.AnnoMese)} | 
                                üìÇ ${adempimento.Tipologia} | 
                                ‚è∞ Scad: ${scadenza}
                            </div>
                        </div>
                        <div class="adempimento-stats">
                            <span class="stat-badge totali">${totali} totali</span>
                            ${nonGestiti > 0 ? `<span class="stat-badge non-gestiti">üî¥ ${nonGestiti}</span>` : ''}
                            ${inCorso > 0 ? `<span class="stat-badge in-corso">üü° ${inCorso}</span>` : ''}
                            ${completati > 0 ? `<span class="stat-badge completati">üü¢ ${completati}</span>` : ''}
                            <span class="expand-icon">‚ñº</span>
                        </div>
                    </div>
                    
                    <div class="comuni-list">
                        ${enti.length > 0 ? enti.map(e => createComuneRow(e)).join('') : '<p style="text-align: center; padding: 20px; color: #9ca3af;">Nessun comune assegnato</p>'}
                    </div>
                </div>
            `;
        }

        function createComuneRow(ente) {
            const stato = ente.StatoEnte || 'Non Gestito';
            const progress = ente.ProgressEnte || 0;
            const note = ente.NoteEnte || '';
            
            let statoClass = 'stato-non-gestito';
            if (stato === 'In Corso') statoClass = 'stato-in-corso';
            if (stato === 'Completato') statoClass = 'stato-completato';
            
            return `
                <div class="comune-row">
                    <div class="comune-info">
                        <div class="comune-nome">${ente.Comune}</div>
                        ${note ? `<div class="comune-note">üìù ${note}</div>` : ''}
                    </div>
                    
                    <span class="comune-stato ${statoClass}">${stato}</span>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    
                    <span style="font-size: 12px; font-weight: 600; color: #6b7280; min-width: 45px;">
                        ${progress}%
                    </span>
                    
                    <div class="comune-actions">
                        <button class="icon-btn" onclick="cambiaStato(${ente.ID})" title="Cambia stato">
                            ‚úÖ
                        </button>
                        <button class="icon-btn" onclick="openNoteModal(${ente.ID}, '${ente.Comune}')" title="Note">
                            üìù
                        </button>
                    </div>
                </div>
            `;
        }

        // Cambia Stato
        window.cambiaStato = async function(enteId) {
            try {
                const ente = allEnti.find(e => e.ID == enteId);
                if (!ente) return;
                
                let nuovoStato, nuovoProgress;
                
                if (!ente.StatoEnte || ente.StatoEnte === 'Non Gestito') {
                    nuovoStato = 'In Corso';
                    nuovoProgress = 50;
                } else if (ente.StatoEnte === 'In Corso') {
                    nuovoStato = 'Completato';
                    nuovoProgress = 100;
                } else {
                    nuovoStato = 'Non Gestito';
                    nuovoProgress = 0;
                }
                
                showLoading(true);
                await updateItem(LISTS.ENTI, enteId, {
                    StatoEnte: nuovoStato,
                    ProgressEnte: nuovoProgress
                });
                
                showAlert('‚úÖ Stato aggiornato!', 'success');
                await loadData();
            } catch (err) {
                console.error('Errore cambio stato:', err);
                showAlert('Errore: ' + err.message, 'error');
                showLoading(false);
            }
        };

        // Open Note Modal
        window.openNoteModal = function(enteId, comune) {
            const ente = allEnti.find(e => e.ID == enteId);
            if (!ente) return;
            
            document.getElementById('noteRecordId').value = enteId;
            document.getElementById('noteComune').textContent = comune;
            document.getElementById('formNote').value = ente.NoteEnte || '';
            document.getElementById('noteModal').classList.add('open');
        };

        // Form Handlers - V16.2 CON RETRY
        document.getElementById('adempimentoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                Title: document.getElementById('formTitolo').value,
                Descrizione: document.getElementById('formDescrizione').value,
                Tipologia: document.getElementById('formTipologia').value,
                DataScadenza: new Date(document.getElementById('formDataScadenza').value).toISOString(),
                AnnoMese: document.getElementById('formMese').value,
                StatoMese: 'Aperto'
            };
            
            const comuniSelezionati = Array.from(
                document.querySelectorAll('#adempimentoComuniCheckboxes input:checked')
            ).map(cb => cb.value);
            
            if (comuniSelezionati.length === 0) {
                showAlert('‚ö†Ô∏è Seleziona almeno un comune!', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                const newAdempimento = await createItem(LISTS.ADEMPIMENTI, data);
                console.log('‚úÖ Adempimento creato:', newAdempimento);
                
                // ‚úÖ NUOVO: Crea comuni con RETRY e DELAY
                let successCount = 0;
                for (let i = 0; i < comuniSelezionati.length; i++) {
                    const comune = comuniSelezionati[i];
                    
                    showAlert(`‚è≥ Creazione comune ${i + 1}/${comuniSelezionati.length}: ${comune}...`, 'info');
                    
                    let created = false;
                    let attempts = 0;
                    const maxAttempts = 3;
                    
                    while (!created && attempts < maxAttempts) {
                        try {
                            attempts++;
                            console.log(`üîÑ Tentativo ${attempts}/${maxAttempts} per ${comune}`);
                            
                            await createItem(LISTS.ENTI, {
                                AdempimentoID: parseInt(newAdempimento.id),
                                Comune: comune,
                                StatoEnte: 'Non Gestito',
                                ProgressEnte: 0
                            });
                            
                            created = true;
                            successCount++;
                            console.log(`‚úÖ Comune ${comune} creato con successo`);
                            
                            // Delay di 500ms tra una richiesta e l'altra
                            if (i < comuniSelezionati.length - 1) {
                                await new Promise(resolve => setTimeout(resolve, 500));
                            }
                            
                        } catch (err) {
                            console.error(`‚ùå Tentativo ${attempts} fallito per ${comune}:`, err);
                            
                            if (attempts < maxAttempts) {
                                console.log(`‚è≥ Attendo 1 secondo prima del prossimo tentativo...`);
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            } else {
                                console.error(`‚ùå ${comune} non creato dopo ${maxAttempts} tentativi`);
                            }
                        }
                    }
                }
                
                if (successCount === comuniSelezionati.length) {
                    showAlert(`‚úÖ Adempimento creato con ${successCount} comuni!`, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è Adempimento creato ma solo ${successCount}/${comuniSelezionati.length} comuni salvati. Riprova!`, 'error');
                }
                
                document.getElementById('adempimentoModal').classList.remove('open');
                this.reset();
                await loadData();
            } catch (err) {
                console.error('Errore creazione:', err);
                showAlert('Errore: ' + err.message, 'error');
                showLoading(false);
            }
        });

        document.getElementById('noteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const enteId = document.getElementById('noteRecordId').value;
            const note = document.getElementById('formNote').value;
            
            try {
                showLoading(true);
                await updateItem(LISTS.ENTI, enteId, { NoteEnte: note });
                
                showAlert('‚úÖ Note salvate!', 'success');
                document.getElementById('noteModal').classList.remove('open');
                await loadData();
            } catch (err) {
                console.error('Errore salvataggio note:', err);
                showAlert('Errore: ' + err.message, 'error');
                showLoading(false);
            }
        });

        // UI Functions
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('adempimentiContainer').style.display = show ? 'none' : 'block';
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function formatMese(yearMonth) {
            if (!yearMonth) return '';
            const [year, month] = yearMonth.split('-');
            const mesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                         'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            return `${mesi[parseInt(month) - 1]} ${year}`;
        }

        function getCurrentYearMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        // Event Listeners
        window.addEventListener('load', async function() {
            console.log('üìÑ Page loaded');
            
            try {
                await msalInstance.initialize();
                const accounts = msalInstance.getAllAccounts();
                
                if (accounts.length > 0) {
                    console.log('‚úÖ Existing account found');
                    currentUser = accounts[0];
                    await handleAuth();
                } else {
                    console.log('‚ÑπÔ∏è No existing account');
                }
            } catch (err) {
                console.error('‚ùå Init error:', err);
            }

            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', login);
                console.log('‚úÖ Login button ready');
            }
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            const btnAddAdempimento = document.getElementById('btnAddAdempimento');
            if (btnAddAdempimento) {
                btnAddAdempimento.addEventListener('click', function() {
                    console.log('üîÑ Opening modal, populating comuni...');
                    document.getElementById('formMese').value = meseCorrente || getCurrentYearMonth();
                    populateComuniSelectors();
                    document.getElementById('adempimentoModal').classList.add('open');
                });
            }
            
            const btnCloseAdempimentoModal = document.getElementById('btnCloseAdempimentoModal');
            if (btnCloseAdempimentoModal) {
                btnCloseAdempimentoModal.addEventListener('click', function() {
                    document.getElementById('adempimentoModal').classList.remove('open');
                });
            }
            
            const btnCloseNoteModal = document.getElementById('btnCloseNoteModal');
            if (btnCloseNoteModal) {
                btnCloseNoteModal.addEventListener('click', function() {
                    document.getElementById('noteModal').classList.remove('open');
                });
            }
            
            const btnSync = document.getElementById('btnSync');
            if (btnSync) {
                btnSync.addEventListener('click', loadData);
            }
            
            const filterMese = document.getElementById('filterMese');
            if (filterMese) {
                filterMese.addEventListener('change', renderAdempimenti);
            }
            
            const filterTipologia = document.getElementById('filterTipologia');
            if (filterTipologia) {
                filterTipologia.addEventListener('change', renderAdempimenti);
            }
            
            const filterStato = document.getElementById('filterStato');
            if (filterStato) {
                filterStato.addEventListener('change', renderAdempimenti);
            }
            
            console.log('‚úÖ All event listeners attached');
        });
        
        // Expose functions to global scope
        window.selectAllComuni = selectAllComuni;
        window.deselectAllComuni = deselectAllComuni;
        window.quickAddComune = quickAddComune;
        window.updateComuniCount = updateComuniCount;
    </script>
</body>
</html>
