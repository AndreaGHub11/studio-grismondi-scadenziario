<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scadenziario Studio Grismondi V21</title>
    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #90ee90 100%);
            min-height: 100vh; padding: 20px;
        }
        .login-container {
            max-width: 500px; margin: 100px auto; background: white;
            padding: 50px; border-radius: 20px;
            box-shadow: 0 25px 70px rgba(79,172,254,0.3); text-align: center;
        }
        .logo { font-size: 60px; margin-bottom: 20px; }
        .login-container h1 { color: #4facfe; margin-bottom: 10px; font-size: 28px; }
        .login-container p { color: #666; margin-bottom: 35px; font-size: 16px; }
        .login-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white; border: none; padding: 18px 50px; border-radius: 10px;
            font-size: 17px; font-weight: 600; cursor: pointer;
            transition: all 0.3s; box-shadow: 0 5px 20px rgba(79,172,254,0.4);
        }
        .login-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(79,172,254,0.6); }
        .app-container {
            display: none; max-width: 1800px; margin: 0 auto;
            background: white; border-radius: 20px;
            box-shadow: 0 25px 70px rgba(79,172,254,0.3); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white; padding: 20px 40px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }
        .header h1 { font-size: 24px; display: flex; align-items: center; gap: 12px; }
        .header-right { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .session-timer { font-size: 12px; opacity: 0.85; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-name { text-align: right; }
        .user-name strong { font-size: 15px; }
        .user-name small { opacity: 0.9; display: block; font-size: 12px; }
        .logout-btn, .sync-btn-header {
            background: rgba(255,255,255,0.2); color: white;
            border: 2px solid white; padding: 8px 20px; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 13px;
        }
        .logout-btn:hover, .sync-btn-header:hover { background: white; color: #4facfe; }
        .sync-btn-header.syncing { animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Dashboard */
        .dashboard {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px; padding: 20px 40px;
            background: linear-gradient(to right, #f0f7ff 0%, #f0fff4 100%);
            border-bottom: 2px solid #e0f2fe;
        }
        .dash-card {
            background: white; border-radius: 12px; padding: 15px; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06); border-left: 4px solid #4facfe;
        }
        .dash-card .dash-num { font-size: 28px; font-weight: 800; color: #2c3e50; }
        .dash-card .dash-label { font-size: 11px; color: #666; margin-top: 4px; font-weight: 600; }
        .dash-card.scaduti { border-left-color: #ff6b6b; }
        .dash-card.urgenti { border-left-color: #feca57; }
        .dash-card.completati { border-left-color: #90ee90; }
        .dash-card.attesa { border-left-color: #ff9f43; }

        /* Controls */
        .controls {
            padding: 15px 40px;
            background: linear-gradient(to right, #f8fbff 0%, #f0fff4 100%);
            border-bottom: 2px solid #e0f2fe;
            display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
        }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-weight: 600; color: #333; font-size: 13px; }
        select, input[type="month"], input[type="text"], input[type="date"], input[type="number"], textarea {
            padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px;
            font-size: 13px; transition: all 0.3s;
        }
        select:focus, input:focus, textarea:focus {
            outline: none; border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79,172,254,0.1);
        }
        .quick-filters { display: flex; gap: 8px; flex-wrap: wrap; }
        .quick-filter {
            padding: 6px 14px; border-radius: 20px; font-size: 12px;
            font-weight: 600; cursor: pointer; border: 2px solid #ddd;
            background: white; transition: all 0.3s; color: #555;
        }
        .quick-filter:hover { border-color: #4facfe; color: #4facfe; }
        .quick-filter.active { background: #4facfe; color: white; border-color: #4facfe; }
        .quick-filter.active-red { background: #ff6b6b; color: white; border-color: #ff6b6b; }
        .quick-filter.active-orange { background: #feca57; color: #333; border-color: #feca57; }
        .quick-filter.active-green { background: #90ee90; color: #155724; border-color: #90ee90; }
        .quick-filter.active-attesa { background: #ff9f43; color: white; border-color: #ff9f43; }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white; border: none; padding: 9px 20px; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: all 0.3s;
            font-size: 13px; box-shadow: 0 3px 10px rgba(79,172,254,0.3);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79,172,254,0.5); }
        .btn-success { background: linear-gradient(135deg, #90ee90 0%, #7bed9f 100%); box-shadow: 0 3px 10px rgba(144,238,144,0.3); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); }
        .btn-sm { padding: 5px 12px; font-size: 12px; }
        .admin-only { display: none; }

        .content { padding: 25px 40px; }
        .loading { text-align: center; padding: 60px; color: #666; }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #4facfe;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin: 0 auto 25px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Adempimento Cards */
        .ademp-card {
            background: white; border: 2px solid #e0f2fe;
            border-radius: 15px; margin-bottom: 15px; overflow: hidden; transition: all 0.3s;
        }
        .ademp-card:hover { border-color: #4facfe; box-shadow: 0 5px 20px rgba(79,172,254,0.12); }
        .ademp-card.completato { border-color: #90ee90; background: linear-gradient(to right, #f0fff4, white); }
        .ademp-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; cursor: pointer; user-select: none;
            background: linear-gradient(to right, #f8fbff 0%, #f0fff4 100%);
            transition: all 0.3s;
        }
        .ademp-header:hover { background: linear-gradient(to right, #e0f2fe 0%, #d4f4dd 100%); }
        .ademp-title { font-size: 17px; font-weight: 700; color: #2c3e50; }
        .ademp-meta { font-size: 12px; color: #666; margin-top: 4px; display: flex; gap: 12px; flex-wrap: wrap; }
        .ademp-meta span { display: flex; align-items: center; gap: 4px; }
        .ademp-right { display: flex; align-items: center; gap: 12px; }
        .badge-fasi {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            color: white; padding: 4px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 700;
        }
        .progress-bar-wrap {
            width: 120px; height: 8px; background: #e0e0e0;
            border-radius: 10px; overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%; border-radius: 10px; transition: width 0.5s;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
        }
        .progress-bar-fill.complete { background: linear-gradient(90deg, #90ee90, #7bed9f); }
        .progress-text { font-size: 13px; font-weight: 700; color: #333; min-width: 40px; text-align: right; }
        .expand-icon { transition: transform 0.3s; font-size: 18px; }
        .expand-icon.open { transform: rotate(180deg); }

        /* Scadenza alerts */
        .scad-alert { padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .scad-green { background: #d4edda; color: #155724; }
        .scad-orange { background: #fff3cd; color: #856404; }
        .scad-red { background: #f8d7da; color: #721c24; animation: blink 1.5s infinite; }
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Actions buttons */
        .ademp-actions { display: flex; gap: 6px; }
        .icon-btn {
            background: none; border: none; cursor: pointer;
            font-size: 18px; padding: 4px; transition: transform 0.2s;
        }
        .icon-btn:hover { transform: scale(1.25); }

        /* Expanded content */
        .ademp-body { display: none; padding: 0; }
        .ademp-body.open { display: block; }

        /* Istruzioni operative */
        .istruzioni-box {
            background: #fffde7; border-left: 4px solid #feca57;
            padding: 12px 18px; margin: 12px 20px; border-radius: 8px;
            font-size: 13px; color: #5d4e37; line-height: 1.6;
        }
        .istruzioni-box strong { color: #856404; }

        /* Fase section */
        .fase-section { border-top: 1px solid #e0e0e0; }
        .fase-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 25px; cursor: pointer; transition: background 0.2s;
            background: #fafbfc;
        }
        .fase-header:hover { background: #f0f4ff; }
        .fase-info { flex: 1; }
        .fase-name { font-size: 14px; font-weight: 700; color: #5b21b6; }
        .fase-meta { font-size: 11px; color: #888; margin-top: 3px; }
        .fase-progress {
            width: 100px; height: 6px; background: #e0e0e0;
            border-radius: 10px; overflow: hidden; margin: 0 15px;
        }
        .fase-progress-fill {
            height: 100%; border-radius: 10px;
            background: linear-gradient(90deg, #a855f7, #7c3aed);
            transition: width 0.5s;
        }
        .fase-progress-text { font-size: 12px; font-weight: 700; color: #5b21b6; min-width: 35px; text-align: right; }

        /* Note Fase (Istruzioni per fase) - V21 NEW */
        .fase-note-box {
            background: #f3e8ff; border-left: 4px solid #a855f7;
            padding: 10px 18px; margin: 0 25px 8px 40px; border-radius: 8px;
            font-size: 12px; color: #4c1d95; line-height: 1.5;
            white-space: pre-wrap; cursor: pointer; transition: all 0.2s;
        }
        .fase-note-box:hover { background: #ede9fe; }
        .fase-note-box .note-label { font-weight: 700; color: #7c3aed; margin-bottom: 4px; }
        .fase-note-edit {
            width: 100%; min-height: 140px; max-height: 300px;
            resize: vertical; font-family: inherit; font-size: 13px;
            padding: 10px; border: 2px solid #a855f7; border-radius: 8px;
            background: white; color: #333; line-height: 1.5;
        }
        .fase-note-actions { display: flex; gap: 8px; margin-top: 6px; justify-content: flex-end; }

        /* Comuni grid inside fase or adempimento */
        .comuni-container { padding: 10px 20px 15px; }
        .comuni-sort { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .comuni-sort label { font-size: 12px; color: #666; font-weight: 600; }
        .comuni-sort select { font-size: 12px; padding: 4px 8px; }
        .comuni-search { padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; width: 180px; }
        .comuni-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
        }
        .comune-tile {
            border: 2px solid #e0e0e0; border-radius: 10px; padding: 12px;
            background: white; transition: all 0.2s;
        }
        .comune-tile:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.08); }
        .comune-tile-name { font-weight: 700; font-size: 14px; color: #2c3e50; margin-bottom: 6px; }
        .comune-tile-progress {
            width: 100%; height: 6px; background: #e0e0e0;
            border-radius: 10px; overflow: hidden; margin: 6px 0;
        }
        .comune-tile-progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s; }

        /* Stati comuni */
        .stato-btn {
            display: inline-block; padding: 4px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 700; cursor: pointer; border: none;
            transition: all 0.2s; margin: 2px;
        }
        .stato-btn:hover { transform: scale(1.05); }
        .stato-dafare { background: #f8d7da; color: #721c24; }
        .stato-incorso { background: #fff3cd; color: #856404; }
        .stato-completato { background: #d4edda; color: #155724; }
        .stato-nongestito { background: #e2e3e5; color: #383d41; }
        .stato-attesaente { background: #ffe0b2; color: #e65100; }
        .stato-selector { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
        .note-btn {
            background: none; border: none; cursor: pointer; font-size: 16px;
            padding: 2px; transition: transform 0.2s;
        }
        .note-btn:hover { transform: scale(1.2); }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px;
            max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 25px 70px rgba(0,0,0,0.3);
        }
        .modal-header { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0f2fe; }
        .modal-header h2 { color: #4facfe; font-size: 22px; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block; margin-bottom: 6px; font-weight: 600;
            color: #333; font-size: 13px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px 12px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 13px; transition: all 0.3s;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-actions { display: flex; gap: 12px; margin-top: 25px; }

        /* Fasi form */
        .fasi-form-container {
            background: #f3e8ff; border: 2px solid #d8b4fe;
            border-radius: 12px; padding: 15px; margin-top: 10px;
        }
        .fase-form-item {
            background: white; border-radius: 8px; padding: 12px;
            margin-bottom: 10px; border: 1px solid #e0e0e0;
        }
        .fase-form-item .form-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        .fase-form-item .form-row > div { flex: 1; min-width: 150px; }
        .fase-form-item .form-row label { font-size: 11px; }
        .fase-form-item .form-row input, .fase-form-item .form-row textarea { font-size: 12px; padding: 6px 8px; }
        .remove-fase-btn { color: #ff6b6b; cursor: pointer; font-size: 20px; font-weight: 700; border: none; background: none; }

        /* Checkbox responsabili */
        .resp-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .resp-check { display: flex; align-items: center; gap: 6px; }
        .resp-check input { width: auto; }
        .resp-check label { font-size: 13px; cursor: pointer; }

        /* Note modal */
        .note-modal-textarea {
            width: 100%; min-height: 140px; resize: vertical;
            padding: 12px; font-size: 14px; line-height: 1.5;
            border: 2px solid #ddd; border-radius: 8px;
        }
        .note-history { margin-top: 12px; font-size: 12px; color: #888; max-height: 150px; overflow-y: auto; }

        /* Alert */
        .alert {
            padding: 14px 18px; margin-bottom: 15px; border-radius: 10px;
            font-weight: 500; font-size: 13px; position: relative;
        }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state-icon { font-size: 80px; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { color: #4facfe; margin-bottom: 10px; }

        /* Back to top */
        .back-to-top {
            position: fixed; bottom: 30px; right: 30px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white; border: none; border-radius: 50%;
            width: 50px; height: 50px; font-size: 22px;
            cursor: pointer; display: none; z-index: 999;
            box-shadow: 0 5px 20px rgba(79,172,254,0.4);
            transition: all 0.3s;
        }
        .back-to-top:hover { transform: translateY(-3px); }
        .back-to-top.show { display: block; }

        /* Toggle switch */
        .toggle-container { display: flex; align-items: center; gap: 10px; }
        .toggle-switch {
            position: relative; width: 48px; height: 26px;
            background: #ccc; border-radius: 13px; cursor: pointer; transition: 0.3s;
        }
        .toggle-switch.active { background: #7c3aed; }
        .toggle-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 20px; height: 20px; background: white;
            border-radius: 50%; transition: 0.3s;
        }
        .toggle-switch.active::after { left: 25px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 15px 20px; }
            .header h1 { font-size: 18px; }
            .controls { padding: 12px 20px; }
            .content { padding: 15px 20px; }
            .dashboard { padding: 12px 20px; grid-template-columns: repeat(3, 1fr); }
            .comuni-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginContainer" class="login-container">
        <div class="logo">üè¢</div>
        <h1>Studio Grismondi</h1>
        <p>Sistema Scadenziario V21</p>
        <button class="login-btn" id="loginBtn">üîê Accedi con Microsoft</button>
    </div>

    <!-- APP -->
    <div id="appContainer" class="app-container">
        <!-- HEADER -->
        <div class="header">
            <h1><span>üìÖ</span>Scadenziario Studio Grismondi</h1>
            <div class="header-right">
                <div class="session-timer" id="sessionTimer"></div>
                <button class="sync-btn-header" id="btnSyncHeader" title="Sincronizza dati">üîÑ Sincronizza</button>
                <div class="user-info">
                    <div class="user-name">
                        <strong id="userName">Utente</strong>
                        <small id="userRole">Caricamento...</small>
                    </div>
                    <button class="logout-btn" id="logoutBtn">Esci</button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div class="dashboard" id="dashboard">
            <div class="dash-card"><div class="dash-num" id="dashTotAdempimenti">0</div><div class="dash-label">ADEMPIMENTI</div></div>
            <div class="dash-card"><div class="dash-num" id="dashTotComuni">0</div><div class="dash-label">COMUNI TOTALI</div></div>
            <div class="dash-card completati"><div class="dash-num" id="dashCompletati">0</div><div class="dash-label">COMPLETATI</div></div>
            <div class="dash-card scaduti"><div class="dash-num" id="dashScaduti">0</div><div class="dash-label">SCADUTI</div></div>
            <div class="dash-card urgenti"><div class="dash-num" id="dashUrgenti">0</div><div class="dash-label">URGENTI (&lt;7gg)</div></div>
            <div class="dash-card attesa"><div class="dash-num" id="dashAttesa">0</div><div class="dash-label">IN ATTESA ENTE</div></div>
        </div>

        <!-- CONTROLS -->
        <div class="controls">
            <div class="filter-group">
                <label>üìÖ</label>
                <input type="month" id="filterMese">
            </div>
            <div class="filter-group">
                <label>üìÇ</label>
                <select id="filterTipologia"><option value="">Tutte</option></select>
            </div>
            <div class="filter-group">
                <label>üë§</label>
                <select id="filterResponsabile"><option value="">Tutti</option></select>
            </div>
            <div class="filter-group">
                <label>‚ö†Ô∏è</label>
                <select id="filterStato">
                    <option value="">Tutti</option>
                    <option value="Aperto">Aperto</option>
                    <option value="Chiuso">Chiuso</option>
                </select>
            </div>
            <div class="quick-filters">
                <button class="quick-filter active" data-filter="tutti">Tutti</button>
                <button class="quick-filter" data-filter="scaduti">üî¥ Scaduti</button>
                <button class="quick-filter" data-filter="urgenti">üü° Urgenti</button>
                <button class="quick-filter" data-filter="attesa">üü† In Attesa</button>
                <button class="quick-filter" data-filter="completati">üü¢ Completati</button>
            </div>
            <div style="margin-left: auto; display: flex; gap: 8px;">
                <button class="btn btn-success" id="btnAddAdempimento">‚ûï Nuovo Adempimento</button>
                <button class="btn admin-only" id="btnAddComune">üèõÔ∏è Nuovo Comune</button>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="content">
            <div id="loadingIndicator" class="loading" style="display:none;">
                <div class="spinner"></div>
                <p>Caricamento dati da SharePoint...</p>
            </div>
            <div id="alertContainer"></div>
            <div id="adempimentiContainer"></div>
        </div>
    </div>

    <!-- MODAL: Adempimento -->
    <div id="adempimentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuovo Adempimento</h2>
            </div>
            <div id="adempimentoFormContainer">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label>Titolo Adempimento *</label>
                    <input type="text" id="formTitle" required placeholder="es. Rendiconto di Gestione 2025">
                </div>
                <div class="form-group">
                    <label>Descrizione</label>
                    <textarea id="formDescrizione" placeholder="Descrivi l'adempimento..."></textarea>
                </div>
                <div class="form-group">
                    <label>Tipologia *</label>
                    <select id="formTipologia" required>
                        <option value="">Seleziona...</option>
                        <option value="Contabilit√†">Contabilit√†</option>
                        <option value="Tributi">Tributi</option>
                        <option value="Personale">Personale</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mese di riferimento *</label>
                    <input type="month" id="formAnnoMese" required>
                </div>
                <div class="form-group">
                    <label>Data Scadenza *</label>
                    <input type="date" id="formScadenza" required>
                </div>
                <div class="form-group">
                    <label>Responsabili</label>
                    <div class="resp-grid" id="respGrid">
                        <div class="resp-check"><input type="checkbox" id="resp_Andrea" value="Andrea"><label for="resp_Andrea">Andrea</label></div>
                        <div class="resp-check"><input type="checkbox" id="resp_Roberta" value="Roberta"><label for="resp_Roberta">Roberta</label></div>
                        <div class="resp-check"><input type="checkbox" id="resp_Nicoletta" value="Nicoletta"><label for="resp_Nicoletta">Nicoletta</label></div>
                        <div class="resp-check"><input type="checkbox" id="resp_Miriana" value="Miriana"><label for="resp_Miriana">Miriana</label></div>
                    </div>
                </div>
                <!-- TOGGLE FASI -->
                <div class="form-group">
                    <div class="toggle-container">
                        <div class="toggle-switch" id="toggleFasi"></div>
                        <label style="cursor:pointer; font-weight:600;" onclick="document.getElementById('toggleFasi').click()">‚ö° Usa sistema Fasi</label>
                    </div>
                </div>
                <!-- FASI CONTAINER -->
                <div id="fasiFormContainer" style="display:none;">
                    <div class="fasi-form-container">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <strong style="color:#5b21b6;">üìã Fasi dell'adempimento</strong>
                            <button type="button" class="btn btn-sm" onclick="addFaseForm()" style="background:#7c3aed;">‚ûï Aggiungi Fase</button>
                        </div>
                        <div id="fasiFormList"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-success" id="btnSaveAdempimento">üíæ Salva</button>
                    <button type="button" class="btn" id="btnCloseModal">‚ùå Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Nuovo Comune -->
    <div id="comuneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>üèõÔ∏è Nuovo Comune</h2></div>
            <div class="form-group">
                <label>Nome Comune *</label>
                <input type="text" id="formComuneNome" required placeholder="es. Milano, Bergamo...">
            </div>
            <div class="form-group">
                <label>Provincia</label>
                <input type="text" id="formComuneProv" placeholder="es. MI, BG..." maxlength="2" style="text-transform:uppercase;">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-success" id="btnSaveComune">üíæ Crea Comune</button>
                <button type="button" class="btn" id="btnCloseComuneModal">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Note Comune -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="noteModalTitle">üìù Note</h2></div>
            <textarea class="note-modal-textarea" id="noteModalText" placeholder="Scrivi le note per questo comune..."></textarea>
            <div class="note-history" id="noteHistory"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-success" id="btnSaveNote">üíæ Salva Note</button>
                <button type="button" class="btn" id="btnCloseNoteModal">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Note Fase (Istruzioni) V21 -->
    <div id="faseNoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="faseNoteModalTitle">üìã Istruzioni Fase</h2></div>
            <p style="font-size:12px; color:#666; margin-bottom:10px;">Scrivi le istruzioni operative per questa fase. Lo spazio √® sufficiente per appunti dettagliati.</p>
            <textarea id="faseNoteModalText" style="width:100%; min-height:180px; max-height:400px; resize:vertical; padding:12px; font-size:14px; line-height:1.6; border:2px solid #a855f7; border-radius:8px; font-family:inherit;" placeholder="Inserisci qui le istruzioni per questa fase...&#10;&#10;Es: Richiedere il conto del tesoriere via PEC&#10;Verificare quadratura con mandati e reversali&#10;Controllare partite aperte..."></textarea>
            <div class="form-actions">
                <button type="button" class="btn btn-success" id="btnSaveFaseNote" style="background:#7c3aed;">üíæ Salva Istruzioni</button>
                <button type="button" class="btn" id="btnCloseFaseNoteModal">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Back to top -->
    <button class="back-to-top" id="backToTop">‚¨Ü</button>

    <script>
        console.log('üöÄ Studio Grismondi V21');

        // ===== CONFIG =====
        const msalConfig = {
            auth: {
                clientId: '931c14fe-e538-4ae3-a336-0d3a9fd75c49',
                authority: 'https://login.microsoftonline.com/7f07be7a-b1c7-42ca-8f8b-ff793e29b450',
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: true }
        };
        const loginRequest = { scopes: ['User.Read', 'Sites.Read.All', 'Sites.ReadWrite.All'] };
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const SHAREPOINT_HOSTNAME = 'studiogrismondi.sharepoint.com';
        const SITE_PATH = '/sites/SitodiComunicazione';
        const LISTS = {
            COMUNI: 'Scadenziario_Comuni',
            ADEMPIMENTI: 'Scadenziario_Adempimenti',
            ENTI: 'Scadenziario_Enti',
            FASI: 'Scadenziario_Fasi',
            COMUNI_FASI: 'Scadenziario_Comuni_Fasi'
        };
        const ADMIN_EMAILS = ['info@studiogrismondisrl.it'];
        const RESPONSABILI = ['Andrea', 'Roberta', 'Nicoletta', 'Miriana'];
        const STATI_ENTE = ['Da Fare', 'In Corso', 'In Attesa Ente', 'Completato', 'Non Gestito'];
        const STATO_COLORS = {
            'Da Fare': { bg: '#f8d7da', color: '#721c24', icon: 'üî¥' },
            'In Corso': { bg: '#fff3cd', color: '#856404', icon: 'üü°' },
            'In Attesa Ente': { bg: '#ffe0b2', color: '#e65100', icon: 'üü†' },
            'Completato': { bg: '#d4edda', color: '#155724', icon: 'üü¢' },
            'Non Gestito': { bg: '#e2e3e5', color: '#383d41', icon: '‚ö´' }
        };

        // V21: Sync ogni 10 minuti (600000ms) invece di 1 minuto
        const SYNC_INTERVAL = 600000;

        let currentUser, userRole, accessToken, siteId;
        let allComuni = [], allAdempimenti = [], allEntiAdemp = [], allFasi = [], allComuniFasi = [];
        let activeQuickFilter = 'tutti';
        let syncTimer = null;
        let sessionStart = null;

        // ===== AUTH =====
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('logoutBtn').addEventListener('click', logout);

        async function login() {
            try {
                const resp = await msalInstance.loginPopup({ ...loginRequest, prompt: 'select_account' });
                currentUser = resp.account;
                await handleAuth();
            } catch (err) {
                console.error('Login error:', err);
                showAlert('Errore login: ' + err.message, 'error');
            }
        }

        async function handleAuth() {
            try {
                const account = msalInstance.getAllAccounts()[0];
                if (!account) return;
                currentUser = account;
                const tokenResp = await msalInstance.acquireTokenSilent({ ...loginRequest, account: currentUser });
                accessToken = tokenResp.accessToken;
                userRole = ADMIN_EMAILS.includes(currentUser.username.toLowerCase()) ? 'Admin' : 'User';
                sessionStart = Date.now();

                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userName').textContent = currentUser.name || currentUser.username;
                document.getElementById('userRole').textContent = userRole === 'Admin' ? 'üëë Amministratore' : 'üë§ Operatore';

                if (userRole === 'Admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
                }

                updateSessionTimer();
                setInterval(updateSessionTimer, 60000);

                await loadAllData();
                startAutoSync();
            } catch (err) {
                if (err.name === 'InteractionRequiredAuthError') {
                    await login();
                } else {
                    showAlert('Errore autenticazione: ' + err.message, 'error');
                }
            }
        }

        function updateSessionTimer() {
            if (!sessionStart) return;
            const elapsed = Math.floor((Date.now() - sessionStart) / 60000);
            const h = Math.floor(elapsed / 60);
            const m = elapsed % 60;
            document.getElementById('sessionTimer').textContent = `‚è± Sessione: ${h}h ${m}m`;
        }

        async function logout() {
            await msalInstance.logoutPopup();
            location.reload();
        }

        // ===== API =====
        async function callGraph(endpoint, method = 'GET', body = null) {
            const url = `https://graph.microsoft.com/v1.0/${endpoint}`;
            const options = {
                method,
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
            };
            if (body && (method === 'POST' || method === 'PATCH')) {
                options.body = JSON.stringify(body);
            }
            const resp = await fetch(url, options);
            if (!resp.ok) throw new Error(`API ${resp.status}: ${endpoint}`);
            if (method === 'DELETE' || resp.status === 204) return { success: true };
            return await resp.json();
        }

        async function getSiteId() {
            if (siteId) return siteId;
            const result = await callGraph(`sites/${SHAREPOINT_HOSTNAME}:${SITE_PATH}`);
            siteId = result.id;
            return siteId;
        }

        async function getListItems(listName) {
            const site = await getSiteId();
            let items = [];
            let url = `sites/${site}/lists/${listName}/items?expand=fields&$top=500`;
            while (url) {
                const result = await callGraph(url);
                items = items.concat(result.value.map(item => ({ ID: item.id, ...item.fields })));
                url = result['@odata.nextLink'] ? result['@odata.nextLink'].replace('https://graph.microsoft.com/v1.0/', '') : null;
            }
            return items;
        }

        async function createItem(listName, data) {
            const site = await getSiteId();
            return await callGraph(`sites/${site}/lists/${listName}/items`, 'POST', { fields: data });
        }

        async function updateItem(listName, itemId, data) {
            const site = await getSiteId();
            return await callGraph(`sites/${site}/lists/${listName}/items/${itemId}/fields`, 'PATCH', data);
        }

        async function deleteItem(listName, itemId) {
            const site = await getSiteId();
            return await callGraph(`sites/${site}/lists/${listName}/items/${itemId}`, 'DELETE');
        }

        // ===== DATA LOADING =====
        async function loadAllData() {
            try {
                showLoading(true);
                [allComuni, allAdempimenti, allEntiAdemp, allFasi, allComuniFasi] = await Promise.all([
                    getListItems(LISTS.COMUNI),
                    getListItems(LISTS.ADEMPIMENTI),
                    getListItems(LISTS.ENTI),
                    getListItems(LISTS.FASI),
                    getListItems(LISTS.COMUNI_FASI)
                ]);
                allComuni = allComuni.filter(c => c.StatoEnte !== 'Disattivo');
                populateFilters();
                renderAll();
                showLoading(false);
                showAlert('‚úÖ Dati caricati!', 'success');
            } catch (err) {
                console.error('Load error:', err);
                showAlert('Errore caricamento: ' + err.message, 'error');
                showLoading(false);
            }
        }

        // V21: Auto-sync ogni 10 minuti + pulsante manuale per tutti
        function startAutoSync() {
            if (syncTimer) clearInterval(syncTimer);
            syncTimer = setInterval(() => {
                console.log('Auto-sync...');
                loadAllData();
            }, SYNC_INTERVAL);
        }

        document.getElementById('btnSyncHeader').addEventListener('click', async function() {
            this.classList.add('syncing');
            this.textContent = 'üîÑ Sincronizzazione...';
            try {
                await loadAllData();
            } finally {
                this.classList.remove('syncing');
                this.textContent = 'üîÑ Sincronizza';
            }
        });

        // ===== FILTERS =====
        function populateFilters() {
            const tipSet = new Set(), respSet = new Set();
            allAdempimenti.forEach(a => {
                if (a.Tipologia) tipSet.add(a.Tipologia);
                if (a.Responsabile) {
                    a.Responsabile.split(';').map(r => r.trim()).filter(Boolean).forEach(r => respSet.add(r));
                }
            });
            const tipSel = document.getElementById('filterTipologia');
            tipSel.innerHTML = '<option value="">Tutte</option>';
            [...tipSet].sort().forEach(t => { tipSel.innerHTML += `<option value="${t}">${t}</option>`; });

            const respSel = document.getElementById('filterResponsabile');
            respSel.innerHTML = '<option value="">Tutti</option>';
            [...respSet].sort().forEach(r => { respSel.innerHTML += `<option value="${r}">${r}</option>`; });
        }

        document.getElementById('filterMese').addEventListener('change', renderAll);
        document.getElementById('filterTipologia').addEventListener('change', renderAll);
        document.getElementById('filterResponsabile').addEventListener('change', renderAll);
        document.getElementById('filterStato').addEventListener('change', renderAll);

        document.querySelectorAll('.quick-filter').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.quick-filter').forEach(b => b.className = 'quick-filter');
                activeQuickFilter = this.dataset.filter;
                const classes = { tutti: 'active', scaduti: 'active-red', urgenti: 'active-orange', completati: 'active-green', attesa: 'active-attesa' };
                this.classList.add(classes[activeQuickFilter] || 'active');
                renderAll();
            });
        });

        // ===== RENDER =====
        function renderAll() {
            renderDashboard();
            renderAdempimenti();
        }

        function renderDashboard() {
            const now = new Date();
            let totAdemp = 0, totComuni = 0, completati = 0, scaduti = 0, urgenti = 0, attesa = 0;

            allAdempimenti.forEach(a => {
                if (a.StatoMese === 'Chiuso') return;
                totAdemp++;
                const enti = allEntiAdemp.filter(e => String(e.AdempimentoID) === String(a.ID));
                const fasi = allFasi.filter(f => String(f.AdempimentoID) === String(a.ID));
                let comuniList = [];
                if (fasi.length > 0) {
                    comuniList = allComuniFasi.filter(cf => String(cf.AdempimentoID) === String(a.ID));
                } else {
                    comuniList = enti;
                }
                totComuni += comuniList.length;
                comuniList.forEach(c => {
                    if (c.StatoEnte === 'Completato') completati++;
                    if (c.StatoEnte === 'In Attesa Ente') attesa++;
                });

                const scad = new Date(a.DataScadenza);
                const diff = Math.floor((scad - now) / 86400000);
                if (diff < 0) scaduti++;
                else if (diff <= 7) urgenti++;
            });

            document.getElementById('dashTotAdempimenti').textContent = totAdemp;
            document.getElementById('dashTotComuni').textContent = totComuni;
            document.getElementById('dashCompletati').textContent = completati;
            document.getElementById('dashScaduti').textContent = scaduti;
            document.getElementById('dashUrgenti').textContent = urgenti;
            document.getElementById('dashAttesa').textContent = attesa;
        }

        function renderAdempimenti() {
            const container = document.getElementById('adempimentiContainer');
            container.innerHTML = '';

            const filterMese = document.getElementById('filterMese').value;
            const filterTip = document.getElementById('filterTipologia').value;
            const filterResp = document.getElementById('filterResponsabile').value;
            const filterStato = document.getElementById('filterStato').value;
            const now = new Date();

            let filtered = allAdempimenti.filter(a => {
                if (filterMese && a.AnnoMese !== filterMese) return false;
                if (filterTip && a.Tipologia !== filterTip) return false;
                if (filterResp) {
                    const resps = (a.Responsabile || '').split(';').map(r => r.trim());
                    if (!resps.includes(filterResp)) return false;
                }
                if (filterStato && a.StatoMese !== filterStato) return false;
                return true;
            });

            // Quick filters
            if (activeQuickFilter !== 'tutti') {
                filtered = filtered.filter(a => {
                    const scad = new Date(a.DataScadenza);
                    const diff = Math.floor((scad - now) / 86400000);
                    if (activeQuickFilter === 'scaduti') return diff < 0;
                    if (activeQuickFilter === 'urgenti') return diff >= 0 && diff <= 7;
                    if (activeQuickFilter === 'completati') {
                        return isAdempimentoCompleto(a);
                    }
                    if (activeQuickFilter === 'attesa') {
                        return hasAttesaEnte(a);
                    }
                    return true;
                });
            }

            // Sort by scadenza
            filtered.sort((a, b) => new Date(a.DataScadenza) - new Date(b.DataScadenza));

            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìÇ</div><h3>Nessun adempimento trovato</h3><p>Modifica i filtri o crea un nuovo adempimento.</p></div>`;
                return;
            }

            filtered.forEach(a => {
                container.appendChild(createAdempimentoCard(a));
            });
        }

        function isAdempimentoCompleto(a) {
            const fasi = allFasi.filter(f => String(f.AdempimentoID) === String(a.ID));
            let comuniList;
            if (fasi.length > 0) {
                comuniList = allComuniFasi.filter(cf => String(cf.AdempimentoID) === String(a.ID));
            } else {
                comuniList = allEntiAdemp.filter(e => String(e.AdempimentoID) === String(a.ID));
            }
            return comuniList.length > 0 && comuniList.every(c => c.StatoEnte === 'Completato' || c.StatoEnte === 'Non Gestito');
        }

        // V21: Check if any comune is "In Attesa Ente"
        function hasAttesaEnte(a) {
            const fasi = allFasi.filter(f => String(f.AdempimentoID) === String(a.ID));
            let comuniList;
            if (fasi.length > 0) {
                comuniList = allComuniFasi.filter(cf => String(cf.AdempimentoID) === String(a.ID));
            } else {
                comuniList = allEntiAdemp.filter(e => String(e.AdempimentoID) === String(a.ID));
            }
            return comuniList.some(c => c.StatoEnte === 'In Attesa Ente');
        }

        function createAdempimentoCard(a) {
            const card = document.createElement('div');
            const isComplete = isAdempimentoCompleto(a);
            card.className = `ademp-card${isComplete ? ' completato' : ''}`;

            const fasi = allFasi.filter(f => String(f.AdempimentoID) === String(a.ID)).sort((x, y) => (x.OrdineFase || 0) - (y.OrdineFase || 0));
            const hasFasi = fasi.length > 0;

            let totalComuni = 0, totalProgress = 0;
            if (hasFasi) {
                const cf = allComuniFasi.filter(c => String(c.AdempimentoID) === String(a.ID));
                totalComuni = cf.length;
                totalProgress = totalComuni > 0 ? Math.round(cf.reduce((s, c) => s + (c.ProgressEnte || 0), 0) / totalComuni) : 0;
            } else {
                const enti = allEntiAdemp.filter(e => String(e.AdempimentoID) === String(a.ID));
                totalComuni = enti.length;
                totalProgress = totalComuni > 0 ? Math.round(enti.reduce((s, e) => s + (e.ProgressEnte || 0), 0) / totalComuni) : 0;
            }

            const scad = new Date(a.DataScadenza);
            const now = new Date();
            const diff = Math.floor((scad - now) / 86400000);
            let scadClass = 'scad-green', scadText = `${diff}gg`;
            if (diff < 0) { scadClass = 'scad-red'; scadText = `SCADUTO ${Math.abs(diff)}gg`; }
            else if (diff <= 7) { scadClass = 'scad-orange'; scadText = `‚ö°${diff}gg`; }

            const resps = (a.Responsabile || '').split(';').map(r => r.trim()).filter(Boolean).join(', ');

            card.innerHTML = `
                <div class="ademp-header" data-id="${a.ID}">
                    <div>
                        <div class="ademp-title">${isComplete ? '‚úÖ ' : ''}${a.Title || 'Adempimento'}</div>
                        <div class="ademp-meta">
                            <span>üìÖ ${a.AnnoMese || ''}</span>
                            <span>üìÇ ${a.Tipologia || ''}</span>
                            <span>‚è∞ ${scad.toLocaleDateString('it-IT')}</span>
                            <span class="scad-alert ${scadClass}">${scadText}</span>
                            ${resps ? `<span>üë§ ${resps}</span>` : ''}
                        </div>
                    </div>
                    <div class="ademp-right">
                        ${hasFasi ? `<span class="badge-fasi">‚ö° ${fasi.length} FASI</span>` : ''}
                        <span class="progress-text">${totalComuni} enti</span>
                        <div class="progress-bar-wrap">
                            <div class="progress-bar-fill ${totalProgress === 100 ? 'complete' : ''}" style="width:${totalProgress}%"></div>
                        </div>
                        <span class="progress-text">${totalProgress}%</span>
                        <div class="ademp-actions">
                            <button class="icon-btn btn-edit-ademp" data-id="${a.ID}" title="Modifica" onclick="event.stopPropagation()">‚úèÔ∏è</button>
                            <button class="icon-btn btn-dup-ademp" data-id="${a.ID}" title="Duplica" onclick="event.stopPropagation()">üìã</button>
                            ${userRole === 'Admin' ? `<button class="icon-btn btn-del-ademp" data-id="${a.ID}" title="Elimina" onclick="event.stopPropagation()">üóëÔ∏è</button>` : ''}
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                </div>
                <div class="ademp-body" id="body-${a.ID}">
                    ${a.Descrizione ? `<div class="istruzioni-box"><strong>üìå Istruzioni:</strong> ${a.Descrizione}</div>` : ''}
                    ${hasFasi ? renderFasiHTML(a, fasi) : renderEntiHTML(a)}
                </div>
            `;

            // Toggle expand
            card.querySelector('.ademp-header').addEventListener('click', () => {
                const body = card.querySelector('.ademp-body');
                const icon = card.querySelector('.expand-icon');
                body.classList.toggle('open');
                icon.classList.toggle('open');
            });

            // Edit
            card.querySelector('.btn-edit-ademp').addEventListener('click', () => editAdempimento(a));
            // Duplicate
            card.querySelector('.btn-dup-ademp').addEventListener('click', () => duplicateAdempimento(a));
            // Delete
            const delBtn = card.querySelector('.btn-del-ademp');
            if (delBtn) delBtn.addEventListener('click', () => deleteAdempimento(a));

            return card;
        }

        // ===== RENDER FASI (with V21 NoteFase) =====
        function renderFasiHTML(a, fasi) {
            let html = '';
            fasi.forEach(fase => {
                const comuniFase = allComuniFasi.filter(cf => String(cf.FaseID) === String(fase.ID) && String(cf.AdempimentoID) === String(a.ID));
                const progress = comuniFase.length > 0 ? Math.round(comuniFase.reduce((s, c) => s + (c.ProgressEnte || 0), 0) / comuniFase.length) : 0;
                const scadFase = fase.DataScadenzaFase ? new Date(fase.DataScadenzaFase) : null;
                let scadInfo = '';
                if (scadFase) {
                    const now = new Date();
                    const diff = Math.floor((scadFase - now) / 86400000);
                    let cls = 'scad-green', txt = `${diff}gg`;
                    if (diff < 0) { cls = 'scad-red'; txt = `SCADUTO ${Math.abs(diff)}gg`; }
                    else if (diff <= 7) { cls = 'scad-orange'; txt = `üî•(${diff}gg)`; }
                    scadInfo = `<span class="scad-alert ${cls}" style="margin-left:8px;">${txt}</span>`;
                }

                const noteFase = fase.NoteFase || '';
                const noteFaseHTML = noteFase ?
                    `<div class="fase-note-box" onclick="openFaseNoteModal('${fase.ID}', '${escapeAttr(fase.Title)}')">
                        <div class="note-label">üìã Istruzioni:</div>${escapeHtml(noteFase)}
                    </div>` :
                    `<div class="fase-note-box" onclick="openFaseNoteModal('${fase.ID}', '${escapeAttr(fase.Title)}')" style="opacity:0.5; font-style:italic;">
                        <div class="note-label">üìã Clicca per aggiungere istruzioni...</div>
                    </div>`;

                html += `
                    <div class="fase-section">
                        <div class="fase-header" data-fase-id="${fase.ID}">
                            <div class="fase-info">
                                <div class="fase-name">[${fase.OrdineFase || ''}] ${fase.Title || ''}</div>
                                <div class="fase-meta">
                                    ${scadFase ? `üìÖ ${scadFase.toLocaleDateString('it-IT')}` : 'Nessuna scadenza'}
                                    ${scadInfo}
                                    | ${comuniFase.length} comuni
                                </div>
                            </div>
                            <div class="fase-progress">
                                <div class="fase-progress-fill" style="width:${progress}%"></div>
                            </div>
                            <span class="fase-progress-text">${progress}%</span>
                            <span class="expand-icon" style="margin-left:8px;">‚ñº</span>
                        </div>
                        ${noteFaseHTML}
                        <div class="comuni-container" style="display:none;" id="fase-comuni-${fase.ID}">
                            ${renderComuniGridHTML(comuniFase, 'comunifasi')}
                        </div>
                    </div>
                `;
            });

            // Bind fase toggle after render via setTimeout
            setTimeout(() => {
                document.querySelectorAll('.fase-header').forEach(fh => {
                    fh.addEventListener('click', function() {
                        const faseId = this.dataset.faseId;
                        const container = document.getElementById(`fase-comuni-${faseId}`);
                        const icon = this.querySelector('.expand-icon');
                        if (container) {
                            const isOpen = container.style.display === 'block';
                            container.style.display = isOpen ? 'none' : 'block';
                            icon.classList.toggle('open', !isOpen);
                        }
                    });
                });
            }, 0);

            return html;
        }

        // ===== RENDER ENTI (no fasi) =====
        function renderEntiHTML(a) {
            const enti = allEntiAdemp.filter(e => String(e.AdempimentoID) === String(a.ID));
            return `<div class="comuni-container">${renderComuniGridHTML(enti, 'enti')}</div>`;
        }

        function renderComuniGridHTML(items, type) {
            if (items.length === 0) return '<p style="color:#999; padding:10px; font-size:13px;">Nessun comune assegnato.</p>';

            const gridId = `grid-${type}-${Date.now()}-${Math.random().toString(36).substr(2,5)}`;

            let html = `
                <div class="comuni-sort">
                    <input type="text" class="comuni-search" placeholder="üîç Cerca comune..." oninput="filterComuniGrid(this, '${gridId}')">
                    <label>Ordina:</label>
                    <select onchange="sortComuniGrid(this.value, '${gridId}')">
                        <option value="nome">Nome</option>
                        <option value="stato">Stato</option>
                        <option value="progress">Progress</option>
                    </select>
                </div>
                <div class="comuni-grid" id="${gridId}">
            `;

            items.forEach(item => {
                const stato = item.StatoEnte || 'Da Fare';
                const progress = item.ProgressEnte || 0;
                const sc = STATO_COLORS[stato] || STATO_COLORS['Da Fare'];
                const listName = type === 'comunifasi' ? LISTS.COMUNI_FASI : LISTS.ENTI;

                html += `
                    <div class="comune-tile" data-name="${(item.Comune || '').toLowerCase()}" data-stato="${stato}" data-progress="${progress}">
                        <div class="comune-tile-name">${sc.icon} ${item.Comune || item.Title || ''}</div>
                        <div class="comune-tile-progress">
                            <div class="comune-tile-progress-fill" style="width:${progress}%; background:${sc.bg.replace('0.', '')}; background: linear-gradient(90deg, ${sc.color}33, ${sc.color}88);"></div>
                        </div>
                        <div style="font-size:11px; color:#666; margin-bottom:6px;">${progress}%</div>
                        <div class="stato-selector">
                            ${STATI_ENTE.map(s => {
                                const active = s === stato;
                                const sClass = s.replace(/\s/g, '').toLowerCase();
                                return `<button class="stato-btn stato-${sClass === 'inattesaente' ? 'attesaente' : sClass}${active ? '' : ''}" style="${active ? 'outline:2px solid #333; outline-offset:1px;' : 'opacity:0.5;'}" onclick="changeStato('${item.ID}', '${s}', '${listName}', '${item.Comune || ''}')">${STATO_COLORS[s].icon}${s === 'In Attesa Ente' ? ' Attesa' : s === 'Non Gestito' ? ' N.G.' : ' ' + s}</button>`;
                            }).join('')}
                        </div>
                        <div style="margin-top:6px;">
                            <button class="note-btn" onclick="openNoteModal('${item.ID}', '${escapeAttr(item.Comune || '')}', '${listName}')" title="Note">üìù</button>
                            ${item.NoteEnte ? `<span style="font-size:11px; color:#888; vertical-align:middle;">Nota presente</span>` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // ===== STATO CHANGE =====
        async function changeStato(itemId, newStato, listName, comuneName) {
            try {
                const updateData = { StatoEnte: newStato };

                // V21: Auto-progress based on state
                if (newStato === 'Completato') updateData.ProgressEnte = 100;
                else if (newStato === 'Da Fare') updateData.ProgressEnte = 0;
                else if (newStato === 'Non Gestito') updateData.ProgressEnte = 0;

                // V21: Auto-note for "In Attesa Ente"
                if (newStato === 'In Attesa Ente') {
                    const now = new Date();
                    const dataOra = now.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const autoNote = `Inviata richiesta all'ente, in attesa di risposta - ${dataOra}`;

                    // Get current note and prepend the new auto-note
                    const currentItem = [...allEntiAdemp, ...allComuniFasi].find(i => String(i.ID) === String(itemId));
                    const existingNote = currentItem ? (currentItem.NoteEnte || '') : '';
                    updateData.NoteEnte = existingNote ? `${autoNote}\n---\n${existingNote}` : autoNote;
                }

                await updateItem(listName, itemId, updateData);

                // Update local data
                const localArrays = [allEntiAdemp, allComuniFasi];
                localArrays.forEach(arr => {
                    const item = arr.find(i => String(i.ID) === String(itemId));
                    if (item) {
                        Object.assign(item, updateData);
                    }
                });

                renderAll();
                showAlert(`‚úÖ ${comuneName}: ${newStato}`, 'success');
            } catch (err) {
                showAlert('Errore aggiornamento stato: ' + err.message, 'error');
            }
        }

        // ===== NOTES =====
        let currentNoteItemId = null, currentNoteListName = null;

        function openNoteModal(itemId, comuneName, listName) {
            currentNoteItemId = itemId;
            currentNoteListName = listName;
            document.getElementById('noteModalTitle').textContent = `üìù Note - ${comuneName}`;
            const item = [...allEntiAdemp, ...allComuniFasi].find(i => String(i.ID) === String(itemId));
            document.getElementById('noteModalText').value = item ? (item.NoteEnte || '') : '';
            document.getElementById('noteModal').classList.add('open');
        }

        document.getElementById('btnSaveNote').addEventListener('click', async () => {
            if (!currentNoteItemId) return;
            const noteText = document.getElementById('noteModalText').value;
            try {
                await updateItem(currentNoteListName, currentNoteItemId, { NoteEnte: noteText });
                const localArrays = [allEntiAdemp, allComuniFasi];
                localArrays.forEach(arr => {
                    const item = arr.find(i => String(i.ID) === String(currentNoteItemId));
                    if (item) item.NoteEnte = noteText;
                });
                document.getElementById('noteModal').classList.remove('open');
                renderAll();
                showAlert('‚úÖ Note salvate!', 'success');
            } catch (err) {
                showAlert('Errore salvataggio note: ' + err.message, 'error');
            }
        });

        document.getElementById('btnCloseNoteModal').addEventListener('click', () => {
            document.getElementById('noteModal').classList.remove('open');
        });

        // ===== V21: FASE NOTE (Istruzioni per fase) =====
        let currentFaseNoteId = null;

        function openFaseNoteModal(faseId, faseName) {
            currentFaseNoteId = faseId;
            document.getElementById('faseNoteModalTitle').textContent = `üìã Istruzioni - ${faseName}`;
            const fase = allFasi.find(f => String(f.ID) === String(faseId));
            document.getElementById('faseNoteModalText').value = fase ? (fase.NoteFase || '') : '';
            document.getElementById('faseNoteModal').classList.add('open');
        }

        document.getElementById('btnSaveFaseNote').addEventListener('click', async () => {
            if (!currentFaseNoteId) return;
            const noteText = document.getElementById('faseNoteModalText').value;
            try {
                await updateItem(LISTS.FASI, currentFaseNoteId, { NoteFase: noteText });
                const fase = allFasi.find(f => String(f.ID) === String(currentFaseNoteId));
                if (fase) fase.NoteFase = noteText;
                document.getElementById('faseNoteModal').classList.remove('open');
                renderAll();
                showAlert('‚úÖ Istruzioni fase salvate!', 'success');
            } catch (err) {
                showAlert('Errore salvataggio istruzioni: ' + err.message, 'error');
            }
        });

        document.getElementById('btnCloseFaseNoteModal').addEventListener('click', () => {
            document.getElementById('faseNoteModal').classList.remove('open');
        });

        // ===== COMUNI GRID SORT/FILTER =====
        function filterComuniGrid(input, gridId) {
            const query = input.value.toLowerCase();
            document.querySelectorAll(`#${gridId} .comune-tile`).forEach(tile => {
                tile.style.display = tile.dataset.name.includes(query) ? '' : 'none';
            });
        }

        function sortComuniGrid(sortBy, gridId) {
            const grid = document.getElementById(gridId);
            if (!grid) return;
            const tiles = [...grid.querySelectorAll('.comune-tile')];
            tiles.sort((a, b) => {
                if (sortBy === 'nome') return a.dataset.name.localeCompare(b.dataset.name);
                if (sortBy === 'stato') return a.dataset.stato.localeCompare(b.dataset.stato);
                if (sortBy === 'progress') return parseInt(b.dataset.progress) - parseInt(a.dataset.progress);
                return 0;
            });
            tiles.forEach(t => grid.appendChild(t));
        }

        // ===== ADEMPIMENTO CRUD =====
        let usaFasi = false;
        let faseFormCounter = 0;

        document.getElementById('toggleFasi').addEventListener('click', function() {
            usaFasi = !usaFasi;
            this.classList.toggle('active', usaFasi);
            document.getElementById('fasiFormContainer').style.display = usaFasi ? 'block' : 'none';
            if (usaFasi && document.getElementById('fasiFormList').children.length === 0) {
                addFaseForm();
            }
        });

        function addFaseForm() {
            faseFormCounter++;
            const div = document.createElement('div');
            div.className = 'fase-form-item';
            div.id = `faseForm-${faseFormCounter}`;
            div.innerHTML = `
                <div class="form-row">
                    <div style="flex:2;">
                        <label>Nome Fase ${faseFormCounter}</label>
                        <input type="text" class="fase-nome" placeholder="es. Spunta conto tesoriere">
                    </div>
                    <div>
                        <label>Scadenza Fase</label>
                        <input type="date" class="fase-scadenza">
                    </div>
                    <div style="flex:0 0 30px; display:flex; align-items:flex-end;">
                        <button type="button" class="remove-fase-btn" onclick="this.closest('.fase-form-item').remove()">‚úï</button>
                    </div>
                </div>
                <div style="margin-top:8px;">
                    <label style="font-size:11px;">Istruzioni Fase (opzionale)</label>
                    <textarea class="fase-note" style="width:100%; min-height:100px; max-height:200px; resize:vertical; font-size:12px; padding:8px; border:1px solid #d8b4fe; border-radius:6px; line-height:1.5;" placeholder="Inserisci istruzioni operative per questa fase...&#10;Lo spazio √® sufficiente per 6-7 righe di appunti."></textarea>
                </div>
            `;
            document.getElementById('fasiFormList').appendChild(div);
        }

        document.getElementById('btnAddAdempimento').addEventListener('click', () => {
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').textContent = 'Nuovo Adempimento';
            document.getElementById('formTitle').value = '';
            document.getElementById('formDescrizione').value = '';
            document.getElementById('formTipologia').value = '';
            document.getElementById('formAnnoMese').value = '';
            document.getElementById('formScadenza').value = '';
            document.querySelectorAll('#respGrid input').forEach(cb => cb.checked = false);
            usaFasi = false;
            document.getElementById('toggleFasi').classList.remove('active');
            document.getElementById('fasiFormContainer').style.display = 'none';
            document.getElementById('fasiFormList').innerHTML = '';
            faseFormCounter = 0;
            document.getElementById('adempimentoModal').classList.add('open');
        });

        document.getElementById('btnCloseModal').addEventListener('click', () => {
            document.getElementById('adempimentoModal').classList.remove('open');
        });

        function editAdempimento(a) {
            document.getElementById('editId').value = a.ID;
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è Modifica Adempimento';
            document.getElementById('formTitle').value = a.Title || '';
            document.getElementById('formDescrizione').value = a.Descrizione || '';
            document.getElementById('formTipologia').value = a.Tipologia || '';
            document.getElementById('formAnnoMese').value = a.AnnoMese || '';
            document.getElementById('formScadenza').value = a.DataScadenza ? a.DataScadenza.split('T')[0] : '';
            const resps = (a.Responsabile || '').split(';').map(r => r.trim());
            document.querySelectorAll('#respGrid input').forEach(cb => {
                cb.checked = resps.includes(cb.value);
            });
            // Don't show fasi form in edit mode (fasi are managed inline)
            usaFasi = false;
            document.getElementById('toggleFasi').classList.remove('active');
            document.getElementById('fasiFormContainer').style.display = 'none';
            document.getElementById('fasiFormList').innerHTML = '';
            faseFormCounter = 0;
            document.getElementById('adempimentoModal').classList.add('open');
        }

        document.getElementById('btnSaveAdempimento').addEventListener('click', async () => {
            const editId = document.getElementById('editId').value;
            const title = document.getElementById('formTitle').value.trim();
            const desc = document.getElementById('formDescrizione').value.trim();
            const tip = document.getElementById('formTipologia').value;
            const annoMese = document.getElementById('formAnnoMese').value;
            const scadenza = document.getElementById('formScadenza').value;
            const resps = [...document.querySelectorAll('#respGrid input:checked')].map(cb => cb.value).join('; ');

            if (!title || !tip || !annoMese || !scadenza) {
                showAlert('Compila tutti i campi obbligatori!', 'error');
                return;
            }

            try {
                const data = {
                    Title: title, Descrizione: desc, Tipologia: tip,
                    AnnoMese: annoMese, DataScadenza: scadenza,
                    Responsabile: resps, StatoMese: 'Aperto',
                    HasFasi: usaFasi
                };

                if (editId) {
                    await updateItem(LISTS.ADEMPIMENTI, editId, data);
                    showAlert('‚úÖ Adempimento aggiornato!', 'success');
                } else {
                    const result = await createItem(LISTS.ADEMPIMENTI, data);
                    const newId = result.id;

                    if (usaFasi) {
                        // Create fasi
                        const fasiItems = document.querySelectorAll('.fase-form-item');
                        let ordine = 1;
                        for (const fi of fasiItems) {
                            const nome = fi.querySelector('.fase-nome').value.trim();
                            const scad = fi.querySelector('.fase-scadenza').value;
                            const note = fi.querySelector('.fase-note').value.trim();
                            if (!nome) continue;
                            const faseResult = await createItem(LISTS.FASI, {
                                Title: nome,
                                AdempimentoID: parseInt(newId),
                                OrdineFase: ordine++,
                                DataScadenzaFase: scad || null,
                                NoteFase: note || ''
                            });
                            const faseId = faseResult.id;
                            // Create comuni for this fase
                            for (const comune of allComuni) {
                                await createItem(LISTS.COMUNI_FASI, {
                                    Title: `${nome} - ${comune.Title}`,
                                    FaseID: parseInt(faseId),
                                    AdempimentoID: parseInt(newId),
                                    Comune: comune.Title,
                                    StatoEnte: 'Da Fare',
                                    ProgressEnte: 0,
                                    NoteEnte: '',
                                    Attivo: true
                                });
                            }
                        }
                    } else {
                        // Create enti for this adempimento
                        for (const comune of allComuni) {
                            await createItem(LISTS.ENTI, {
                                Title: `${title} - ${comune.Title}`,
                                AdempimentoID: parseInt(newId),
                                Comune: comune.Title,
                                StatoEnte: 'Da Fare',
                                ProgressEnte: 0,
                                NoteEnte: ''
                            });
                        }
                    }
                    showAlert('‚úÖ Adempimento creato con tutti i comuni!', 'success');
                }

                document.getElementById('adempimentoModal').classList.remove('open');
                await loadAllData();
            } catch (err) {
                showAlert('Errore salvataggio: ' + err.message, 'error');
            }
        });

        async function deleteAdempimento(a) {
            if (!confirm(`Eliminare "${a.Title}"?\nVerranno eliminati anche tutti gli enti, fasi e comuni associati.`)) return;
            try {
                // Delete comuni_fasi
                const cf = allComuniFasi.filter(c => String(c.AdempimentoID) === String(a.ID));
                for (const item of cf) await deleteItem(LISTS.COMUNI_FASI, item.ID);
                // Delete fasi
                const fasi = allFasi.filter(f => String(f.AdempimentoID) === String(a.ID));
                for (const item of fasi) await deleteItem(LISTS.FASI, item.ID);
                // Delete enti
                const enti = allEntiAdemp.filter(e => String(e.AdempimentoID) === String(a.ID));
                for (const item of enti) await deleteItem(LISTS.ENTI, item.ID);
                // Delete adempimento
                await deleteItem(LISTS.ADEMPIMENTI, a.ID);
                showAlert('‚úÖ Adempimento eliminato!', 'success');
                await loadAllData();
            } catch (err) {
                showAlert('Errore eliminazione: ' + err.message, 'error');
            }
        }

        async function duplicateAdempimento(a) {
            const nextMonth = getNextMonth(a.AnnoMese);
            if (!confirm(`Duplicare "${a.Title}" su ${nextMonth}?`)) return;
            try {
                const newData = {
                    Title: a.Title, Descrizione: a.Descrizione, Tipologia: a.Tipologia,
                    AnnoMese: nextMonth, DataScadenza: shiftDateMonth(a.DataScadenza),
                    Responsabile: a.Responsabile, StatoMese: 'Aperto',
                    HasFasi: a.HasFasi || false
                };
                const result = await createItem(LISTS.ADEMPIMENTI, newData);
                const newId = result.id;

                const fasi = allFasi.filter(f => String(f.AdempimentoID) === String(a.ID));
                if (fasi.length > 0) {
                    for (const fase of fasi) {
                        const faseResult = await createItem(LISTS.FASI, {
                            Title: fase.Title,
                            AdempimentoID: parseInt(newId),
                            OrdineFase: fase.OrdineFase,
                            DataScadenzaFase: null,
                            NoteFase: fase.NoteFase || ''
                        });
                        const newFaseId = faseResult.id;
                        const comuniFase = allComuniFasi.filter(cf => String(cf.FaseID) === String(fase.ID));
                        for (const cf of comuniFase) {
                            await createItem(LISTS.COMUNI_FASI, {
                                Title: `${fase.Title} - ${cf.Comune}`,
                                FaseID: parseInt(newFaseId),
                                AdempimentoID: parseInt(newId),
                                Comune: cf.Comune,
                                StatoEnte: 'Da Fare', ProgressEnte: 0,
                                NoteEnte: '', Attivo: cf.Attivo
                            });
                        }
                    }
                } else {
                    const enti = allEntiAdemp.filter(e => String(e.AdempimentoID) === String(a.ID));
                    for (const ente of enti) {
                        await createItem(LISTS.ENTI, {
                            Title: `${a.Title} - ${ente.Comune}`,
                            AdempimentoID: parseInt(newId),
                            Comune: ente.Comune,
                            StatoEnte: 'Da Fare', ProgressEnte: 0, NoteEnte: ''
                        });
                    }
                }

                showAlert(`‚úÖ Duplicato su ${nextMonth}!`, 'success');
                await loadAllData();
            } catch (err) {
                showAlert('Errore duplicazione: ' + err.message, 'error');
            }
        }

        function getNextMonth(annoMese) {
            if (!annoMese) return '';
            const [y, m] = annoMese.split('-').map(Number);
            const next = m === 12 ? `${y + 1}-01` : `${y}-${String(m + 1).padStart(2, '0')}`;
            return next;
        }

        function shiftDateMonth(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            d.setMonth(d.getMonth() + 1);
            return d.toISOString().split('T')[0];
        }

        // ===== COMUNE CRUD =====
        document.getElementById('btnAddComune').addEventListener('click', () => {
            document.getElementById('formComuneNome').value = '';
            document.getElementById('formComuneProv').value = '';
            document.getElementById('comuneModal').classList.add('open');
        });

        document.getElementById('btnCloseComuneModal').addEventListener('click', () => {
            document.getElementById('comuneModal').classList.remove('open');
        });

        document.getElementById('btnSaveComune').addEventListener('click', async () => {
            const nome = document.getElementById('formComuneNome').value.trim();
            const prov = document.getElementById('formComuneProv').value.trim().toUpperCase();
            if (!nome) { showAlert('Inserisci il nome del comune!', 'error'); return; }
            try {
                await createItem(LISTS.COMUNI, { Title: nome, Provincia: prov, StatoEnte: 'Attivo' });
                document.getElementById('comuneModal').classList.remove('open');
                showAlert(`‚úÖ Comune "${nome}" creato!`, 'success');
                await loadAllData();
            } catch (err) {
                showAlert('Errore creazione comune: ' + err.message, 'error');
            }
        });

        // ===== UTILITIES =====
        function showAlert(msg, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'}`;
            alert.textContent = msg;
            container.prepend(alert);
            setTimeout(() => alert.remove(), 4000);
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function escapeHtml(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function escapeAttr(str) {
            return String(str).replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // ===== BACK TO TOP =====
        window.addEventListener('scroll', () => {
            document.getElementById('backToTop').classList.toggle('show', window.scrollY > 300);
        });
        document.getElementById('backToTop').addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // ===== INIT =====
        (async function init() {
            try {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    currentUser = accounts[0];
                    await handleAuth();
                }
            } catch (err) {
                console.log('No cached session');
            }
        })();
    </script>
</body>
</html>
