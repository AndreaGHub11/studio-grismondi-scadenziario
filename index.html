<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scadenziario Studio Grismondi - Sistema Completo Adempimenti</title>
    <meta name="description" content="Sistema per la gestione degli adempimenti contabili e tributari per 19 comuni lombardi - Studio Grismondi srl">
    <meta name="keywords" content="scadenziario, adempimenti, contabilit√†, tributi, studio grismondi, comuni lombardi">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .user-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .user-details h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .user-details .role {
            color: #7f8c8d;
            font-size: 14px;
        }

        .role.admin {
            color: #e74c3c;
            font-weight: bold;
        }

        .role.user {
            color: #27ae60;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-number.total { color: #3498db; }
        .stat-number.pending { color: #f39c12; }
        .stat-number.completed { color: #27ae60; }
        .stat-number.overdue { color: #e74c3c; }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #ecf0f1;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .progress-fill.total { background: linear-gradient(90deg, #3498db, #2980b9); }
        .progress-fill.pending { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .progress-fill.completed { background: linear-gradient(90deg, #27ae60, #229954); }
        .progress-fill.overdue { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        .filters {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        select, input {
            padding: 10px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .adempimenti-list {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .adempimenti-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 25px;
        }

        .adempimenti-header h2 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .adempimenti-content {
            padding: 25px;
        }

        .adempimento-item {
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .adempimento-item:hover {
            border-color: #3498db;
            transform: translateX(5px);
        }

        .adempimento-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px;
            background: #f8f9fa;
            flex-wrap: wrap;
            gap: 15px;
        }

        .adempimento-title {
            flex: 1;
        }

        .adempimento-title h4 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .adempimento-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .adempimento-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .priority {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority.alta { background: #fee; color: #e74c3c; }
        .priority.media { background: #fff3e0; color: #f39c12; }
        .priority.bassa { background: #e8f5e8; color: #27ae60; }

        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status.non-iniziato { background: #f8f9fa; color: #6c757d; }
        .status.in-corso { background: #fff3e0; color: #f39c12; }
        .status.completato { background: #e8f5e8; color: #27ae60; }
        .status.in-ritardo { background: #fee; color: #e74c3c; }

        .adempimento-content {
            padding: 0 20px 20px;
        }

        .adempimento-description {
            color: #7f8c8d;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .comuni-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            color: #2c3e50;
            font-weight: 500;
            padding: 10px 0;
        }

        .comuni-toggle:hover {
            color: #3498db;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 18px;
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }

        .comuni-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .comuni-grid.expanded {
            max-height: 1000px;
            padding-bottom: 15px;
        }

        .comune-card {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .comune-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .comune-card.non-iniziato { border-left: 4px solid #6c757d; }
        .comune-card.in-corso { border-left: 4px solid #f39c12; }
        .comune-card.completato { border-left: 4px solid #27ae60; }
        .comune-card.in-ritardo { border-left: 4px solid #e74c3c; }

        .comune-card h5 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .comune-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .comune-progress-bar {
            flex: 1;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }

        .comune-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .comune-status {
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .comune-status.non-iniziato { background: #f8f9fa; color: #6c757d; }
        .comune-status.in-corso { background: #fff3e0; color: #f39c12; }
        .comune-status.completato { background: #e8f5e8; color: #27ae60; }
        .comune-status.in-ritardo { background: #fee; color: #e74c3c; }

        .comune-note {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h2 {
            color: #2c3e50;
            font-size: 24px;
        }

        .close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .enti-selection {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .enti-selection h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .enti-options {
            margin-bottom: 15px;
        }

        .enti-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .enti-grid-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
            border-radius: 6px;
            padding: 15px;
        }

        .enti-grid-form label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            padding: 5px 0;
        }

        .enti-grid-form input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .progress-modal {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            margin: 0 auto;
        }

        .progress-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #ecf0f1;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .hidden {
            display: none !important;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            font-weight: 500;
            max-width: 350px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.warning {
            background: #f39c12;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .user-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .action-buttons {
                justify-content: center;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .adempimento-header {
                flex-direction: column;
                align-items: stretch;
            }

            .comuni-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 5% auto;
                width: 95%;
                padding: 20px;
            }

            .enti-grid-form {
                grid-template-columns: 1fr;
            }
        }
        /* Fix visualizzazione adempimenti */
.card {
    background-color: white !important;
    color: black !important;
    border: 1px solid #ddd !important;
    padding: 15px !important;
    margin-bottom: 15px !important;
    font-size: 14px !important;
}

.card * {
    color: black !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.card h5, .card-title {
    color: black !important;
    font-weight: bold !important;
}

    </style>
</head>
<body>
    <div class="container">
        <!-- Header con controlli utente -->
        <header class="header">
            <h1>üèõÔ∏è Studio Grismondi srl</h1>
            <p class="subtitle">Sistema Completo di Gestione Adempimenti Contabili e Tributari</p>
            
            <div class="user-controls">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">AG</div>
                    <div class="user-details">
                        <h3 id="userName">Andrea Grismondi</h3>
                        <span class="role admin" id="userRole">Administrator</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="openCreateModal()" id="btnCreate">
                        ‚ú® Nuovo Adempimento
                    </button>
                    <button class="btn btn-primary" onclick="refreshData()">
                        üîÑ Aggiorna Dati
                    </button>
                    <button class="btn btn-primary" onclick="showAdvancedOptions()" id="btnAdvanced">
                        ‚öôÔ∏è Opzioni Avanzate
                    </button>
                    <button class="btn btn-warning" onclick="openEntiManager()" id="btnEntiManager">
                        üèõÔ∏è Gestisci Enti
                    </button>
                    <button class="btn btn-secondary" onclick="switchUser()">
                        üë§ Cambia Utente
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard Statistiche -->
        <section class="dashboard">
            <div class="card">
                <h3>üìä Adempimenti Totali</h3>
                <div class="stat-number total" id="totalCount">0</div>
                <div class="progress-bar">
                    <div class="progress-fill total" id="totalProgress" style="width: 0%"></div>
                </div>
                <p>Su tutti i 19 comuni gestiti</p>
            </div>
            
            <div class="card">
                <h3>‚è≥ In Corso</h3>
                <div class="stat-number pending" id="pendingCount">0</div>
                <div class="progress-bar">
                    <div class="progress-fill pending" id="pendingProgress" style="width: 0%"></div>
                </div>
                <p>Adempimenti attivi</p>
            </div>
            
            <div class="card">
                <h3>‚úÖ Completati</h3>
                <div class="stat-number completed" id="completedCount">0</div>
                <div class="progress-bar">
                    <div class="progress-fill completed" id="completedProgress" style="width: 0%"></div>
                </div>
                <p>Obiettivi raggiunti</p>
            </div>
            
            <div class="card">
                <h3>‚ö†Ô∏è In Ritardo</h3>
                <div class="stat-number overdue" id="overdueCount">0</div>
                <div class="progress-bar">
                    <div class="progress-fill overdue" id="overdueProgress" style="width: 0%"></div>
                </div>
                <p>Richiedono attenzione immediata</p>
            </div>
        </section>

        <!-- Filtri -->
        <section class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterYear">Anno:</label>
                    <select id="filterYear">
                        <option value="">Tutti gli anni</option>
                        <option value="2024" selected>2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterCategory">Categoria:</label>
                    <select id="filterCategory">
                        <option value="">Tutte le categorie</option>
                        <option value="Tributario">Tributario</option>
                        <option value="Contabilit√†">Contabilit√†</option>
                        <option value="Personale">Personale</option>
                        <option value="Bilancio">Bilancio</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterStatus">Stato:</label>
                    <select id="filterStatus">
                        <option value="">Tutti gli stati</option>
                        <option value="Non Iniziato">Non Iniziato</option>
                        <option value="In Corso">In Corso</option>
                        <option value="Completato">Completato</option>
                        <option value="In Ritardo">In Ritardo</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterComune">Comune:</label>
                    <select id="filterComune">
                        <option value="">Tutti i comuni</option>
                        <option value="Bossico">Bossico</option>
                        <option value="Carobbio degli Angeli">Carobbio degli Angeli</option>
                        <option value="Castro">Castro</option>
                        <option value="Cavernago">Cavernago</option>
                        <option value="Cenate Sotto">Cenate Sotto</option>
                        <option value="Colere">Colere</option>
                        <option value="Filago">Filago</option>
                        <option value="Foppolo">Foppolo</option>
                        <option value="Onore">Onore</option>
                        <option value="Osio Sopra">Osio Sopra</option>
                        <option value="Osio Sotto">Osio Sotto</option>
                        <option value="Parzanica">Parzanica</option>
                        <option value="Ponte San Pietro">Ponte San Pietro</option>
                        <option value="Rogno">Rogno</option>
                        <option value="Selvino">Selvino</option>
                        <option value="Solto Collina">Solto Collina</option>
                        <option value="Telgate">Telgate</option>
                        <option value="Ubiale Clanezzo">Ubiale Clanezzo</option>
                        <option value="Zanica">Zanica</option>
                    </select>
                </div>
                
                <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Pulisci Filtri</button>
            </div>
        </section>

        <!-- Lista Adempimenti -->
        <section class="adempimenti-list">
            <div class="adempimenti-header">
                <h2>üìã Gestione Adempimenti</h2>
                <p>Sistema di controllo per tutti i comuni gestiti</p>
            </div>
            
            <div class="adempimenti-content">
                <div id="loadingState" class="loading">
                    <div class="spinner"></div>
                    <p>Caricamento adempimenti in corso...</p>
                </div>
                
                <div id="emptyState" class="empty-state hidden">
                    <h3>üìù Nessun adempimento trovato</h3>
                    <p>Inizia creando il tuo primo adempimento con il pulsante "Nuovo Adempimento"</p>
                    <button class="btn btn-success" onclick="openCreateModal()" style="margin-top: 15px;">
                        ‚ú® Crea Primo Adempimento
                    </button>
                </div>
                
                <div id="adempimentiContainer"></div>
            </div>
        </section>
    </div>

    <!-- Modal Creazione/Modifica Adempimento -->
    <div id="adempimentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">‚ú® Nuovo Adempimento</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="adempimentoForm">
                <input type="hidden" id="editingAdempimentoId" name="adempimentoId">
                
                <div class="form-group">
                    <label for="titoloAdempimento">Titolo Adempimento *</label>
                    <input type="text" id="titoloAdempimento" name="titolo" required 
                           placeholder="es. Dichiarazione TARI 2024">
                </div>
                
                <div class="form-group">
                    <label for="descrizioneAdempimento">Descrizione</label>
                    <textarea id="descrizioneAdempimento" name="descrizione"
                              placeholder="Descrizione dettagliata dell'adempimento..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="dataScadenza">Data Scadenza *</label>
                    <input type="date" id="dataScadenza" name="dataScadenza" required>
                </div>
                
                <div class="form-group">
                    <label for="prioritaAdempimento">Priorit√†</label>
                    <select id="prioritaAdempimento" name="priorita">
                        <option value="Bassa">Bassa</option>
                        <option value="Media" selected>Media</option>
                        <option value="Alta">Alta</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="categoriaAdempimento">Categoria</label>
                    <select id="categoriaAdempimento" name="ente">
                        <option value="Tributario">Tributario</option>
                        <option value="Contabilit√†">Contabilit√†</option>
                        <option value="Personale">Personale</option>
                        <option value="Bilancio">Bilancio</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="responsabileAdempimento">Responsabile</label>
                    <select id="responsabileAdempimento" name="permesso">
                        <option value="Andrea Grismondi">Andrea Grismondi</option>
                        <option value="Roberta">Roberta</option>
                        <option value="Nicoletta">Nicoletta</option>
                        <option value="Miriana">Miriana</option>
                    </select>
                </div>

                <!-- Selezione Enti Intelligente -->
                <div class="enti-selection" id="entiSelectionContainer">
                    <h4>üèõÔ∏è Applicazione agli Enti</h4>
                    
                    <div class="enti-options">
                        <label>
                            <input type="radio" name="entiMode" value="all" checked 
                                   onchange="toggleEntiSelection()">
                            Applica a tutti i 19 comuni lombardi
                        </label>
                        <label>
                            <input type="radio" name="entiMode" value="selected" 
                                   onchange="toggleEntiSelection()">
                            Seleziona comuni specifici
                        </label>
                    </div>
                    
                    <div id="entiGridForm" class="enti-grid-form hidden">
                        <label><input type="checkbox" name="comuni" value="Bossico"> Bossico</label>
                        <label><input type="checkbox" name="comuni" value="Carobbio degli Angeli"> Carobbio degli Angeli</label>
                        <label><input type="checkbox" name="comuni" value="Castro"> Castro</label>
                        <label><input type="checkbox" name="comuni" value="Cavernago"> Cavernago</label>
                        <label><input type="checkbox" name="comuni" value="Cenate Sotto"> Cenate Sotto</label>
                        <label><input type="checkbox" name="comuni" value="Colere"> Colere</label>
                        <label><input type="checkbox" name="comuni" value="Filago"> Filago</label>
                        <label><input type="checkbox" name="comuni" value="Foppolo"> Foppolo</label>
                        <label><input type="checkbox" name="comuni" value="Onore"> Onore</label>
                        <label><input type="checkbox" name="comuni" value="Osio Sopra"> Osio Sopra</label>
                        <label><input type="checkbox" name="comuni" value="Osio Sotto"> Osio Sotto</label>
                        <label><input type="checkbox" name="comuni" value="Parzanica"> Parzanica</label>
                        <label><input type="checkbox" name="comuni" value="Ponte San Pietro"> Ponte San Pietro</label>
                        <label><input type="checkbox" name="comuni" value="Rogno"> Rogno</label>
                        <label><input type="checkbox" name="comuni" value="Selvino"> Selvino</label>
                        <label><input type="checkbox" name="comuni" value="Solto Collina"> Solto Collina</label>
                        <label><input type="checkbox" name="comuni" value="Telgate"> Telgate</label>
                        <label><input type="checkbox" name="comuni" value="Ubiale Clanezzo"> Ubiale Clanezzo</label>
                        <label><input type="checkbox" name="comuni" value="Zanica"> Zanica</label>
                    </div>
                </div>

                <!-- Campi nascosti necessari -->
                <input type="hidden" name="stato" value="Da Fare">
                <input type="hidden" name="note" value="">
                
                <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        ‚ùå Annulla
                    </button>
                    <button type="submit" class="btn btn-success" id="submitBtn">
                        üíæ Salva Adempimento
                    </button>
                </div>
            </form>

        </div>
    </div>

    <!-- Modal Gestione Enti -->
    <div id="entiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üèõÔ∏è Gestione Enti</h2>
                <button class="close" onclick="closeEntiModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3>‚ûï Aggiungi Nuovo Ente</h3>
                <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap; margin-bottom: 20px;">
                    <div class="form-group" style="margin: 0; min-width: 250px;">
                        <label for="newEnteNome">Nome Comune:</label>
                        <input type="text" id="newEnteNome" placeholder="es. Nuovo Comune">
                    </div>
                    <button class="btn btn-success" onclick="addNewEnte()">‚ûï Aggiungi</button>
                </div>
            </div>
            
            <div>
                <h3>üìã Enti Attuali (${SISTEMA_CONFIG.comuni.length})</h3>
                <div id="entiList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ecf0f1; border-radius: 8px; padding: 15px;">
                    <!-- Lista enti popolata dinamicamente -->
                </div>
            </div>
            
            <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeEntiModal()">
                    ‚ùå Chiudi
                </button>
                <button type="button" class="btn btn-primary" onclick="saveEntiChanges()">
                    üíæ Salva Modifiche
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Aggiornamento Progress Comune -->
    <div id="progressModal" class="modal">
        <div class="modal-content progress-modal">
            <div class="modal-header">
                <h2>üìä Aggiorna Progresso</h2>
                <button class="close" onclick="closeProgressModal()">&times;</button>
            </div>
            
            <div class="progress-form">
                <h3 id="progressComuneName"></h3>
                <p id="progressAdempimentoTitle"></p>
                
                <div class="form-group">
                    <label for="newProgress">Percentuale Completamento (0-100):</label>
                    <input type="number" id="newProgress" min="0" max="100" step="5" value="0">
                </div>
                
                <div class="form-group">
                    <label for="newStatus">Stato:</label>
                    <select id="newStatus">
                        <option value="Non Iniziato">Non Iniziato</option>
                        <option value="In Corso">In Corso</option>
                        <option value="Completato">Completato</option>
                        <option value="In Ritardo">In Ritardo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newNote">Note:</label>
                    <textarea id="newNote" placeholder="Note aggiuntive..."></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeProgressModal()">
                        ‚ùå Annulla
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveProgress()">
                        üíæ Aggiorna Progress
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurazione sistema completa
        const SISTEMA_CONFIG = {
            utenti: {
                'Andrea Grismondi': { 
                    email: 'andrea@studiogrismondisrl.it', 
                    ruolo: 'admin', 
                    avatar: 'AG',
                    nome: 'Andrea Grismondi'
                },
                'Roberta': { 
                    email: 'roberta@studiogrismondisrl.it', 
                    ruolo: 'user', 
                    avatar: 'RO',
                    nome: 'Roberta'
                },
                'Nicoletta': { 
                    email: 'nicoletta@studiogrismondisrl.it', 
                    ruolo: 'user', 
                    avatar: 'NI',
                    nome: 'Nicoletta'
                },
                'Miriana': { 
                    email: 'miriana@studiogrismondisrl.it', 
                    ruolo: 'user', 
                    avatar: 'MI',
                    nome: 'Miriana'
                }
            },
            comuni: [
                'Bossico', 'Carobbio degli Angeli', 'Castro', 'Cavernago', 
                'Cenate Sotto', 'Colere', 'Filago', 'Foppolo', 'Onore',
                'Osio Sopra', 'Osio Sotto', 'Parzanica', 'Ponte San Pietro',
                'Rogno', 'Selvino', 'Solto Collina', 'Telgate', 'Ubiale Clanezzo', 'Zanica'
            ],
            sharepoint: {
                siteUrl: 'https://studiogrismondi-my.sharepoint.com/personal/info_studiogrismondisrl_it',
                lists: {
                    adempimenti: 'Scadenziario_Adempimenti',
                    enti: 'Scadenziario_Enti', 
                    archivio: 'Scadenziario_Archivio',
                    permessi: 'Scadenziario_Permessi'
                }
            }
        };

        // Stato globale applicazione
        let currentUser = 'Andrea Grismondi';
        let adempimenti = [];
        let entiData = [];
        let isLoading = false;
        let currentEditingProgress = null;

        // Dati demo completi
        const demoAdempimenti = [
            {
                id: 1,
                titolo: "Dichiarazione TARI 2024",
                descrizione: "Dichiarazione annuale TARI per tutti i comuni gestiti - Scadenza importante per normativa tributaria",
                dataScadenza: "2025-01-31",
                priorita: "Alta",
                categoria: "Tributario",
                statoGlobale: "In Corso",
                responsabile: "Andrea Grismondi",
                anno: 2024,
                dataCreazione: "2024-12-01",
                comuni: {
                    "Bossico": { stato: "Completato", progress: 100, note: "Completato con successo, nessuna irregolarit√†" },
                    "Filago": { stato: "In Corso", progress: 75, note: "Quasi completato, mancano documenti finali" },
                    "Cenate Sotto": { stato: "In Corso", progress: 50, note: "In lavorazione, raccolta dati in corso" },
                    "Castro": { stato: "Non Iniziato", progress: 0, note: "" },
                    "Ponte San Pietro": { stato: "In Ritardo", progress: 25, note: "Richiede attenzione immediata - documentazione incompleta" },
                    "Zanica": { stato: "In Corso", progress: 85, note: "Ultimi controlli" },
                    "Telgate": { stato: "Completato", progress: 100, note: "Inviato regolarmente" }
                }
            },
            {
                id: 2,
                titolo: "Bilancio di Previsione 2025",
                descrizione: "Approvazione bilancio di previsione per l'esercizio 2025 - Tutti gli enti devono approvare entro la scadenza",
                dataScadenza: "2025-02-28",
                priorita: "Alta",
                categoria: "Bilancio",
                statoGlobale: "Non Iniziato",
                responsabile: "Roberta",
                anno: 2025,
                dataCreazione: "2024-12-01",
                comuni: {
                    "Bossico": { stato: "Non Iniziato", progress: 0, note: "" },
                    "Filago": { stato: "Non Iniziato", progress: 0, note: "" },
                    "Cavernago": { stato: "Non Iniziato", progress: 0, note: "" },
                    "Colere": { stato: "Non Iniziato", progress: 0, note: "" },
                    "Foppolo": { stato: "Non Iniziato", progress: 0, note: "" }
                }
            },
            {
                id: 3,
                titolo: "Comunicazione Dati Personale",
                descrizione: "Invio dati del personale alle autorit√† competenti - Comunicazioni obbligatorie mensili",
                dataScadenza: "2025-01-15",
                priorita: "Media",
                categoria: "Personale",
                statoGlobale: "In Corso",
                responsabile: "Nicoletta",
                anno: 2024,
                dataCreazione: "2024-11-15",
                comuni: {
                    "Zanica": { stato: "Completato", progress: 100, note: "Inviato regolarmente senza problemi" },
                    "Telgate": { stato: "In Corso", progress: 80, note: "Controlli finali sui dati dipendenti" },
                    "Selvino": { stato: "In Corso", progress: 60, note: "Raccolta dati in corso" },
                    "Onore": { stato: "Non Iniziato", progress: 0, note: "" }
                }
            },
            {
                id: 4,
                titolo: "Rendiconto Gestione 2024",
                descrizione: "Predisposizione rendiconto della gestione anno 2024 - Documento contabile obbligatorio",
                dataScadenza: "2025-03-31",
                priorita: "Media",
                categoria: "Contabilit√†",
                statoGlobale: "Non Iniziato",
                responsabile: "Miriana",
                anno: 2024,
                dataCreazione: "2024-12-10",
                comuni: {
                    "Colere": { stato: "Non Iniziato", progress: 0, note: "" },
                    "Foppolo": { stato: "Non Iniziato", progress: 0, note: "" },
                    "Rogno": { stato: "Non Iniziato", progress: 0, note: "" },
                    "Ubiale Clanezzo": { stato: "Non Iniziato", progress: 0, note: "" }
                }
            }
        ];

       // Inizializzazione applicazione
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inizializzazione Sistema Completo Scadenziario Studio Grismondi');
    console.log('üîó Connessione SharePoint REALE attivata!');
    initializeApp();
    loadSharePointData();
    setupEventListeners();
});

        function initializeApp() {
            updateUserInterface();
            updateDashboardStats();
            renderAdempimenti();
        }

       function loadSharePointData() {
    console.log('üìä Caricamento dati da SharePoint reale...');
    console.log('üîó SharePoint URL:', SISTEMA_CONFIG.sharepoint.siteUrl);
    
    showNotification('üîÑ Connessione a SharePoint in corso...', 'warning');
    
    // Connessione SharePoint reale
    setTimeout(() => {
        adempimenti = []; // Inizia con array vuoto per dati reali
        document.getElementById('loadingState').classList.add('hidden');
        renderAdempimenti();
        updateDashboardStats();
        showNotification('‚úÖ Connesso a SharePoint Studio Grismondi! Sistema pronto per dati reali.');
    }, 1000);
}
// Funzioni per interfaccia utente
function refreshData() {
    if (typeof renderAdempimenti === 'function') {
        renderAdempimenti();
    }
    if (typeof updateDashboard === 'function') {
        updateDashboard();
    }
    console.log('‚úÖ Dati aggiornati');
}

function openCreateModal() {
    console.log('üìù Aprendo modal...');
    
    // NON resettare il form se stiamo modificando
    const editingId = document.getElementById('editingAdempimentoId').value;
    if (!editingId || editingId === '') {
        // Solo se √® nuovo adempimento, resetta il form
        document.getElementById('adempimentoForm').reset();
    }
    
    const modal = document.getElementById('adempimentoModal');
    modal.style.display = 'block';
    modal.classList.add('show');
    document.body.classList.add('modal-open');
    
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.onclick = () => {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
        backdrop.remove();
    };
    document.body.appendChild(backdrop);
}

function initializeComuniManagement() {
    const allButtons = document.querySelectorAll('button, a, div');
    const gestioneButtons = Array.from(allButtons).filter(btn => 
        btn.textContent && btn.textContent.includes('Gestisci Comuni')
    );
    
    gestioneButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            const card = btn.closest('.card');
            if (card) {
                const titleElement = card.querySelector('h5, .card-title');
                const title = titleElement ? titleElement.textContent : 'Sconosciuto';
                
                const adempimento = window.adempimentiData.find(a => a.Titolo === title);
                if (adempimento) {
                    const comuniArray = adempimento.Comuni ? adempimento.Comuni.split(';') : [];
                    alert(`üèõÔ∏è Comuni per "${adempimento.Titolo}":\n\n${comuniArray.join('\n')}\n\nüìä Totale: ${comuniArray.length} comuni`);
                }
            }
            e.preventDefault();
            e.stopPropagation();
        });
    });
}

        async function handleFormSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    // Gestione intelligente dei comuni
    let comuniSelezionati = [];
    const entiMode = formData.get('entiMode');
    
    if (entiMode === 'all') {
        // Se "tutti i comuni" √® selezionato, usa tutti i 19 comuni
        comuniSelezionati = [
            'Bossico', 'Carobbio degli Angeli', 'Castro', 'Cavernago', 'Cenate Sotto',
            'Colere', 'Filago', 'Foppolo', 'Onore', 'Osio Sopra', 'Osio Sotto',
            'Parzanica', 'Ponte San Pietro', 'Rogno', 'Selvino', 'Solto Collina',
            'Telgate', 'Ubiale Clanezzo', 'Zanica'
        ];
    } else {
        // Altrimenti usa solo quelli selezionati
        comuniSelezionati = Array.from(document.querySelectorAll('input[name="comuni"]:checked')).map(cb => cb.value);
    }
       // Controlla se √® modifica o creazione
    const editingId = document.getElementById('editingAdempimentoId').value;
    const isEditing = editingId && editingId !== '';
    
    const adempimento = {
        ID: isEditing ? parseInt(editingId) : Date.now(),
        Titolo: formData.get('titolo'),
        Descrizione: formData.get('descrizione') || 'Nessuna descrizione',
        Scadenza: formData.get('dataScadenza'),
        Comuni: comuniSelezionati.join(';'),
        Priorita: formData.get('priorita')
    };
    
    if (!window.adempimentiData) window.adempimentiData = [];
    
    if (isEditing) {
        // Modifica esistente - sostituisci
        const index = window.adempimentiData.findIndex(a => a.ID == editingId);
        if (index !== -1) {
            window.adempimentiData[index] = adempimento;
            console.log('‚úèÔ∏è Adempimento modificato:', adempimento.Titolo);
        }
    } else {
        // Nuovo adempimento - aggiungi
        window.adempimentiData.push(adempimento);
        console.log('‚ûï Nuovo adempimento creato:', adempimento.Titolo);
    }
    
    localStorage.setItem('scadenziari_adempimenti', JSON.stringify(window.adempimentiData));
    
    if (typeof renderAdempimenti === 'function') renderAdempimenti();
    if (typeof updateDashboard === 'function') updateDashboard();
    if (typeof backupDatiCompleto === 'function') backupDatiCompleto();

    
        // Chiudi modal
    const modal = document.getElementById('adempimentoModal');
    modal.style.display = 'none';
    modal.classList.remove('show');
    document.body.classList.remove('modal-open');
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) backdrop.remove();
    
    event.target.reset();
}

      // Funzione per modificare adempimento
function editAdempimento(id) {
    const user = getCurrentUser();
    if (user.ruolo !== 'admin') {
        alert('‚ùå Solo gli amministratori possono modificare gli adempimenti');
        return;
    }
    
    const adempimento = window.adempimentiData.find(a => a.ID == id);
    if (!adempimento) {
        alert('‚ùå Adempimento non trovato');
        return;
    }
    
    console.log('‚úèÔ∏è Modificando adempimento ID:', id, adempimento);
    
    // Popola il form con i dati esistenti
    document.getElementById('editingAdempimentoId').value = adempimento.ID;
    document.getElementById('titoloAdempimento').value = adempimento.Titolo;
    document.getElementById('descrizioneAdempimento').value = adempimento.Descrizione || '';
    document.getElementById('dataScadenza').value = adempimento.Scadenza;
    document.getElementById('prioritaAdempimento').value = adempimento.Priorita;
    
    console.log('‚úèÔ∏è Campo editingAdempimentoId impostato a:', document.getElementById('editingAdempimentoId').value);
    
    // Apri modal
    openCreateModal();
}

// Funzione per eliminare adempimento
function deleteAdempimento(id) {
    const user = getCurrentUser();
    if (user.ruolo !== 'admin') {
        alert('‚ùå Solo gli amministratori possono eliminare gli adempimenti');
        return;
    }
    
    const adempimento = window.adempimentiData.find(a => a.ID == id);
    if (!adempimento) {
        alert('‚ùå Adempimento non trovato');
        return;
    }
    
    if (confirm(`‚ö†Ô∏è Sei sicuro di voler eliminare "${adempimento.Titolo}"?\n\nQuesta azione non pu√≤ essere annullata.`)) {
        window.adempimentiData = window.adempimentiData.filter(a => a.ID != id);
        localStorage.setItem('scadenziari_adempimenti', JSON.stringify(window.adempimentiData));
        renderAdempimenti();
        updateDashboard();
        backupDatiCompleto();
        alert(`‚úÖ Adempimento "${adempimento.Titolo}" eliminato con successo`);
    }
}

       
        function setupEventListeners() {
            // Filtri
            ['filterYear', 'filterCategory', 'filterStatus', 'filterComune'].forEach(filterId => {
                document.getElementById(filterId).addEventListener('change', renderAdempimenti);
            });

            // Form submit
            document.getElementById('adempimentoForm').addEventListener('submit', handleFormSubmit);

            // Auto-update progress su cambio percentuale
            document.getElementById('newProgress').addEventListener('input', function() {
                const progress = parseInt(this.value);
                const statusSelect = document.getElementById('newStatus');
                
                if (progress === 0) {
                    statusSelect.value = "Non Iniziato";
                } else if (progress === 100) {
                    statusSelect.value = "Completato";
                } else {
                    statusSelect.value = "In Corso";
                }
            });
                        // Inizializza gestione comuni dopo rendering
            setTimeout(() => {
                initializeComuniManagement();
            }, 1000);

        }

        function updateUserInterface() {
            const user = SISTEMA_CONFIG.utenti[currentUser];
            if (!user) return;

            document.getElementById('userName').textContent = user.nome;
            document.getElementById('userRole').textContent = user.ruolo === 'admin' ? 'Administrator' : 'User';
            document.getElementById('userRole').className = `role ${user.ruolo}`;
            document.getElementById('userAvatar').textContent = user.avatar;

            // Controllo accessi basato su ruolo
            const btnCreate = document.getElementById('btnCreate');
            const btnAdvanced = document.getElementById('btnAdvanced');
            const btnEntiManager = document.getElementById('btnEntiManager');
            
            if (user.ruolo !== 'admin') {
                btnCreate.style.display = 'none';
                btnAdvanced.style.display = 'none';
                btnEntiManager.style.display = 'none';
            } else {
                btnCreate.style.display = 'inline-flex';
                btnAdvanced.style.display = 'inline-flex';
                btnEntiManager.style.display = 'inline-flex';
            }
        }

        function updateDashboardStats() {
            const stats = calculateStats();
            
            // Aggiorna contatori con animazione
            animateCounter('totalCount', stats.total);
            animateCounter('pendingCount', stats.pending);
            animateCounter('completedCount', stats.completed);
            animateCounter('overdueCount', stats.overdue);

            // Aggiorna barre di progresso con animazione
            const maxCount = Math.max(stats.total, 1);
            setTimeout(() => {
                document.getElementById('totalProgress').style.width = '100%';
                document.getElementById('pendingProgress').style.width = `${(stats.pending / maxCount) * 100}%`;
                document.getElementById('completedProgress').style.width = `${(stats.completed / maxCount) * 100}%`;
                document.getElementById('overdueProgress').style.width = `${(stats.overdue / maxCount) * 100}%`;
            }, 300);
        }

        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = parseInt(element.textContent) || 0;
            const duration = 1000;
            const stepTime = 50;
            const steps = duration / stepTime;
            const increment = (targetValue - startValue) / steps;
            
            let currentValue = startValue;
            const timer = setInterval(() => {
                currentValue += increment;
                element.textContent = Math.round(currentValue);
                
                if ((increment > 0 && currentValue >= targetValue) || 
                    (increment < 0 && currentValue <= targetValue)) {
                    clearInterval(timer);
                    element.textContent = targetValue;
                }
            }, stepTime);
        }

function calculateStats() {
    const now = new Date();
    let stats = { total: 0, pending: 0, completed: 0, overdue: 0 };

    adempimenti.forEach(adempimento => {
        const scadenza = new Date(adempimento.dataScadenza);
        Object.keys(adempimento.comuni).forEach(comune => {
            const comuneData = adempimento.comuni[comune];
            stats.total++;
            
            switch(comuneData.stato) {
                case 'Completato':
                    stats.completed++;
                    break;
                case 'In Corso':
                    if (scadenza < now && comuneData.progress < 100) {
                        stats.overdue++;
                    } else {
                        stats.pending++;
                    }
                    break;
                case 'Non Iniziato':
                    if (scadenza < now) {
                        stats.overdue++;
                    } else {
                        stats.pending++;
                    }
                    break;
                case 'In Ritardo':
                    stats.overdue++;
                    break;
            }
        });
    });

    return stats;
}

        function calculateAdempimentoProgress(adempimento) {
    const comuniTotali = Object.keys(adempimento.comuni).length;
    const comuniCompletati = Object.values(adempimento.comuni).filter(c => c.stato === 'Completato').length;
    const comuniInCorso = Object.values(adempimento.comuni).filter(c => c.stato === 'In Corso').length;
    const comuniInRitardo = Object.values(adempimento.comuni).filter(c => c.stato === 'In Ritardo').length;
    const comuniNonIniziati = Object.values(adempimento.comuni).filter(c => c.stato === 'Non Iniziato').length;
    
    return {
        totali: comuniTotali,
        completati: comuniCompletati,
        inCorso: comuniInCorso,
        inRitardo: comuniInRitardo,
        nonIniziati: comuniNonIniziati,
        percentualeCompletamento: comuniTotali > 0 ? Math.round((comuniCompletati / comuniTotali) * 100) : 0
    };
}

      
       function renderAdempimenti() {
    const container = document.getElementById('adempimentiContainer');
    const filteredAdempimenti = getFilteredAdempimenti();
    
    if (filteredAdempimenti.length === 0) {
        container.innerHTML = '';
        document.getElementById('emptyState').classList.remove('hidden');
        return;
    }

    document.getElementById('emptyState').classList.add('hidden');
    
    container.innerHTML = filteredAdempimenti.map(adempimento => {
        const progress = calculateAdempimentoProgress(adempimento);
        
        return `
            <div class="adempimento-item" data-id="${adempimento.id}">
                <div class="adempimento-header">
                    <div class="adempimento-title">
                        <h4>${adempimento.titolo}</h4>
                        <div class="adempimento-meta">
                            <span>üìÖ Scadenza: ${formatDate(adempimento.dataScadenza)}</span>
                            <span>üë§ Responsabile: ${adempimento.responsabile}</span>
                            <span>üìÇ ${adempimento.categoria}</span>
                            <span>üèõÔ∏è ${progress.totali} comuni</span>
                        </div>
                        
                        <!-- NUOVO INDICATORE PROGRESS -->
                        <div class="adempimento-progress-summary" style="margin-top: 10px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <div class="progress-indicator" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: bold; font-size: 16px; color: #2c3e50;">
                                    üìä Avanzamento: ${progress.completati}/${progress.totali} 
                                    <span style="color: #27ae60;">(${progress.percentualeCompletamento}%)</span>
                                </span>
                            </div>
                            
                            <div class="progress-breakdown" style="display: flex; gap: 10px; font-size: 12px;">
                                ${progress.completati > 0 ? `<span style="background: #e8f5e8; color: #27ae60; padding: 2px 8px; border-radius: 12px;">‚úÖ ${progress.completati} Completati</span>` : ''}
                                ${progress.inCorso > 0 ? `<span style="background: #fff3e0; color: #f39c12; padding: 2px 8px; border-radius: 12px;">üîÑ ${progress.inCorso} In Corso</span>` : ''}
                                ${progress.inRitardo > 0 ? `<span style="background: #fee; color: #e74c3c; padding: 2px 8px; border-radius: 12px;">‚ö†Ô∏è ${progress.inRitardo} In Ritardo</span>` : ''}
                                ${progress.nonIniziati > 0 ? `<span style="background: #f8f9fa; color: #6c757d; padding: 2px 8px; border-radius: 12px;">‚è∏Ô∏è ${progress.nonIniziati} Non Iniziati</span>` : ''}
                            </div>
                            
                            <!-- BARRA PROGRESS VISUALE -->
                            <div class="visual-progress-bar" style="flex: 1; min-width: 200px; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #27ae60 0%, #27ae60 ${progress.percentualeCompletamento}%, #ecf0f1 ${progress.percentualeCompletamento}%, #ecf0f1 100%); transition: all 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px; align-items: flex-end;">
                        <div>
                            <span class="priority ${adempimento.priorita.toLowerCase()}">${adempimento.priorita}</span>
                            <span class="status ${adempimento.statoGlobale.toLowerCase().replace(' ', '-')}">${adempimento.statoGlobale}</span>
                        </div>
                        <div class="adempimento-actions">
                            ${getCurrentUser().ruolo === 'admin' ? `
                            <button class="btn btn-warning btn-small" onclick="editAdempimento(${adempimento.id})">
                                ‚úèÔ∏è Modifica
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteAdempimento(${adempimento.id})">
                                üóëÔ∏è Elimina
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="adempimento-content">
                    <div class="adempimento-description">
                        <strong>Descrizione:</strong> ${adempimento.descrizione}
                    </div>
                    
                    <div class="comuni-toggle" onclick="toggleComuniView(${adempimento.id})">
                        <span class="toggle-icon" id="toggleIcon-${adempimento.id}">‚ñ∂</span>
                        <span>Visualizza dettagli comuni (${progress.totali}) - Completati: ${progress.completati} | In Corso: ${progress.inCorso} | In Ritardo: ${progress.inRitardo}</span>
                    </div>
                    
                    <div class="comuni-grid" id="comuniGrid-${adempimento.id}">
                        ${Object.keys(adempimento.comuni).map(comune => {
                            const comuneData = adempimento.comuni[comune];
                            return `
                                <div class="comune-card ${comuneData.stato.toLowerCase().replace(' ', '-')}" 
                                     onclick="openProgressModal(${adempimento.id}, '${comune}')">
                                    <h5>üèõÔ∏è ${comune}</h5>
                                    <div class="comune-progress">
                                        <div class="comune-progress-bar">
                                            <div class="comune-progress-fill" 
                                                 style="width: ${comuneData.progress}%; background: ${getProgressColor(comuneData.stato)}"></div>
                                        </div>
                                        <span style="font-size: 12px; font-weight: bold;">${comuneData.progress}%</span>
                                    </div>
                                    <div class="comune-status ${comuneData.stato.toLowerCase().replace(' ', '-')}">
                                        ${comuneData.stato}
                                    </div>
                                    ${comuneData.note ? `<div class="comune-note">"${comuneData.note}"</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}


        function toggleComuniView(adempimentoId) {
            const grid = document.getElementById(`comuniGrid-${adempimentoId}`);
            const icon = document.getElementById(`toggleIcon-${adempimentoId}`);
            
            if (grid.classList.contains('expanded')) {
                grid.classList.remove('expanded');
                icon.textContent = '‚ñ∂';
                icon.classList.remove('expanded');
            } else {
                grid.classList.add('expanded');
                icon.textContent = '‚ñº';
                icon.classList.add('expanded');
            }
        }

        function getFilteredAdempimenti() {
            const filterYear = document.getElementById('filterYear').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const filterComune = document.getElementById('filterComune').value;

            return adempimenti.filter(adempimento => {
                // Filtro anno
                if (filterYear && adempimento.anno.toString() !== filterYear) return false;
                
                // Filtro categoria
                if (filterCategory && adempimento.categoria !== filterCategory) return false;
                
                // Filtro stato o comune
                if (filterStatus || filterComune) {
                    const matchingComuni = Object.keys(adempimento.comuni).filter(comune => {
                        const comuneData = adempimento.comuni[comune];
                        const statusMatch = !filterStatus || comuneData.stato === filterStatus;
                        const comuneMatch = !filterComune || comune === filterComune;
                        return statusMatch && comuneMatch;
                    });
                    
                    if (matchingComuni.length === 0) return false;
                }
                
                return true;
            });
        }

        function getProgressColor(stato) {
            switch(stato) {
                case 'Completato': return '#27ae60';
                case 'In Corso': return '#f39c12';
                case 'In Ritardo': return '#e74c3c';
                default: return '#95a5a6';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const diffTime = date - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const formattedDate = date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
            
            if (diffDays < 0) {
                return `${formattedDate} (‚ö†Ô∏è ${Math.abs(diffDays)} giorni fa)`;
            } else if (diffDays <= 7) {
                return `${formattedDate} (üî• ${diffDays} giorni)`;
            } else {
                return formattedDate;
            }
        }

        function getCurrentUser() {
            return SISTEMA_CONFIG.utenti[currentUser];
        }

        // Gestione modal creazione/modifica
        function openCreateModal() {
            document.getElementById('modalTitle').textContent = '‚ú® Nuovo Adempimento';
            document.getElementById('submitBtn').innerHTML = 'üíæ Crea Adempimento';
            document.getElementById('adempimentoForm').reset();
            document.getElementById('editingAdempimentoId').value = '';
            
            // Mostra selezione enti solo per nuovi adempimenti
            document.getElementById('entiSelectionContainer').style.display = 'block';
            
            // Reset selezione enti
            document.querySelector('input[name="entiMode"][value="all"]').checked = true;
            toggleEntiSelection();
            
            document.getElementById('adempimentoModal').style.display = 'block';
        }

        function editAdempimento(id) {
            const user = getCurrentUser();
            if (user.ruolo !== 'admin') {
                showNotification('‚ùå Solo gli amministratori possono modificare gli adempimenti', 'error');
                return;
            }

            const adempimento = adempimenti.find(a => a.id === id);
            if (!adempimento) return;

            document.getElementById('modalTitle').textContent = '‚úèÔ∏è Modifica Adempimento';
            document.getElementById('submitBtn').innerHTML = 'üíæ Aggiorna Adempimento';
            
            // Popola form
            document.getElementById('editingAdempimentoId').value = id;
            document.getElementById('titoloAdempimento').value = adempimento.titolo;
            document.getElementById('descrizioneAdempimento').value = adempimento.descrizione;
            document.getElementById('dataScadenza').value = adempimento.dataScadenza;
            document.getElementById('prioritaAdempimento').value = adempimento.priorita;
            document.getElementById('categoriaAdempimento').value = adempimento.categoria;
            document.getElementById('responsabileAdempimento').value = adempimento.responsabile;
            
            // Nascondi selezione enti per modifiche
            document.getElementById('entiSelectionContainer').style.display = 'none';
            
            document.getElementById('adempimentoModal').style.display = 'block';
        }

        function deleteAdempimento(id) {
            const user = getCurrentUser();
            if (user.ruolo !== 'admin') {
                showNotification('‚ùå Solo gli amministratori possono eliminare gli adempimenti', 'error');
                return;
            }

            const adempimento = adempimenti.find(a => a.id === id);
            if (!adempimento) return;

            if (confirm(`‚ö†Ô∏è Sei sicuro di voler eliminare l'adempimento "${adempimento.titolo}"?\n\nQuesta azione non pu√≤ essere annullata.`)) {
                adempimenti = adempimenti.filter(a => a.id !== id);
                renderAdempimenti();
                updateDashboardStats();
                showNotification(`üóëÔ∏è Adempimento "${adempimento.titolo}" eliminato con successo`);
            }
        }

        function closeModal() {
            document.getElementById('adempimentoModal').style.display = 'none';
        }

        function toggleEntiSelection() {
            const selectedMode = document.querySelector('input[name="entiMode"]:checked').value;
            const entiGrid = document.getElementById('entiGridForm');
            
            if (selectedMode === 'selected') {
                entiGrid.classList.remove('hidden');
            } else {
                entiGrid.classList.add('hidden');
                // Deseleziona tutti i checkbox
                entiGrid.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            }

 

    

                // Gestione modal progress comuni
        function openProgressModal(adempimentoId, comune) {
            const adempimento = adempimenti.find(a => a.id === adempimentoId);
            if (!adempimento) return;

            const comuneData = adempimento.comuni[comune];
            
            currentEditingProgress = { adempimentoId, comune };
            
            document.getElementById('progressComuneName').textContent = `üèõÔ∏è ${comune}`;
            document.getElementById('progressAdempimentoTitle').textContent = `üìã ${adempimento.titolo}`;
            document.getElementById('newProgress').value = comuneData.progress;
            document.getElementById('newStatus').value = comuneData.stato;
            document.getElementById('newNote').value = comuneData.note || '';
            
            document.getElementById('progressModal').style.display = 'block';
        }

        function closeProgressModal() {
            document.getElementById('progressModal').style.display = 'none';
            currentEditingProgress = null;
        }

        function saveProgress() {
            if (!currentEditingProgress) return;

            const { adempimentoId, comune } = currentEditingProgress;
            const adempimento = adempimenti.find(a => a.id === adempimentoId);
            
            if (!adempimento) return;

            const newProgress = parseInt(document.getElementById('newProgress').value);
            const newStatus = document.getElementById('newStatus').value;
            const newNote = document.getElementById('newNote').value;

            if (isNaN(newProgress) || newProgress < 0 || newProgress > 100) {
                showNotification('‚ùå Inserisci un valore valido tra 0 e 100', 'error');
                return;
            }

            // Aggiorna dati comune
            adempimento.comuni[comune] = {
                stato: newStatus,
                progress: newProgress,
                note: newNote
            };

            // Aggiorna stato globale adempimento
            updateAdempimentoGlobalStatus(adempimento);

            // Aggiorna UI
            renderAdempimenti();
            updateDashboardStats();
            closeProgressModal();

            showNotification(`‚úÖ Progresso aggiornato per ${comune}: ${newProgress}% - ${newStatus}`);
        }

        function updateAdempimentoGlobalStatus(adempimento) {
            const stati = Object.values(adempimento.comuni).map(c => c.stato);
            
            if (stati.every(s => s === "Completato")) {
                adempimento.statoGlobale = "Completato";
            } else if (stati.some(s => s === "In Ritardo")) {
                adempimento.statoGlobale = "In Ritardo";
            } else if (stati.some(s => s === "In Corso")) {
                adempimento.statoGlobale = "In Corso";
            } else {
                adempimento.statoGlobale = "Non Iniziato";
            }
        }

        // Funzioni utility
        function clearFilters() {
            document.getElementById('filterYear').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterComune').value = '';
            renderAdempimenti();
            showNotification('üóëÔ∏è Filtri rimossi - Visualizzazione completa');
        }

        function switchUser() {
            const utenti = Object.keys(SISTEMA_CONFIG.utenti);
            const currentIndex = utenti.indexOf(currentUser);
            const nextIndex = (currentIndex + 1) % utenti.length;
            
            currentUser = utenti[nextIndex];
            updateUserInterface();
            
            showNotification(`üë§ Utente cambiato: ${SISTEMA_CONFIG.utenti[currentUser].nome}`);
        }

        function refreshData() {
            showNotification('üîÑ Sincronizzazione con SharePoint in corso...');
            
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('adempimentiContainer').innerHTML = '';
            
            // Simula refresh con SharePoint
            setTimeout(() => {
                document.getElementById('loadingState').classList.add('hidden');
                renderAdempimenti();
                updateDashboardStats();
                showNotification('‚úÖ Dati sincronizzati con SharePoint!');
            }, 800);
        }

        function showAdvancedOptions() {
            const user = getCurrentUser();
            if (user.ruolo !== 'admin') {
                showNotification('‚ùå Funzione riservata agli amministratori', 'error');
                return;
            }

            const options = [
                'üìä Esporta Report Completo',
                'üìß Invia Notifiche Scadenze',
                'üîÑ Sincronizzazione Forzata SharePoint',
                'üë• Gestione Utenti e Permessi',
                'üìÅ Archivia Adempimenti Completati',
                '‚öôÔ∏è Configurazioni Sistema'
            ];

            const choice = prompt(`‚öôÔ∏è OPZIONI AVANZATE - Seleziona:\n\n${options.map((opt, i) => `${i+1}. ${opt}`).join('\n')}\n\nInserisci il numero (1-6):`);
            
            if (choice && choice >= 1 && choice <= 6) {
                showNotification(`üöÄ Funzione "${options[choice-1]}" sar√† implementata nella versione production!`, 'warning');
            }
        }

        // Gestione Enti - Solo Admin
        function openEntiManager() {
            const user = getCurrentUser();
            if (user.ruolo !== 'admin') {
                showNotification('‚ùå Solo gli amministratori possono gestire gli enti', 'error');
                return;
            }

            renderEntiList();
            document.getElementById('entiModal').style.display = 'block';
        }

        function closeEntiModal() {
            document.getElementById('entiModal').style.display = 'none';
            document.getElementById('newEnteNome').value = '';
        }

        function renderEntiList() {
            const container = document.getElementById('entiList');
            container.innerHTML = SISTEMA_CONFIG.comuni.map((comune, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ecf0f1; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 500;">üèõÔ∏è ${comune}</span>
                        <span style="font-size: 12px; color: #7f8c8d;">(${getAdempimentiCountForComune(comune)} adempimenti)</span>
                    </div>
                    <div>
                        <button class="btn btn-warning btn-small" onclick="editEnte(${index}, '${comune}')" style="margin-right: 5px;">
                            ‚úèÔ∏è Modifica
                        </button>
                        ${getAdempimentiCountForComune(comune) === 0 ? `
                        <button class="btn btn-danger btn-small" onclick="deleteEnte(${index}, '${comune}')">
                            üóëÔ∏è Elimina
                        </button>
                        ` : `
                        <span style="font-size: 11px; color: #7f8c8d;">Non eliminabile</span>
                        `}
                    </div>
                </div>
            `).join('');
        }

        function getAdempimentiCountForComune(comune) {
            let count = 0;
            adempimenti.forEach(adempimento => {
                if (adempimento.comuni[comune]) {
                    count++;
                }
            });
            return count;
        }

        function addNewEnte() {
            const nome = document.getElementById('newEnteNome').value.trim();
            
            if (!nome) {
                showNotification('‚ö†Ô∏è Inserisci il nome del comune', 'warning');
                return;
            }

            if (SISTEMA_CONFIG.comuni.includes(nome)) {
                showNotification('‚ùå Questo comune esiste gi√†', 'error');
                return;
            }

            // Aggiungi al sistema
            SISTEMA_CONFIG.comuni.push(nome);
            
            // Aggiorna filtro
            updateComuneFilter();
            
            // Aggiorna form selezione enti
            updateEntiGridForm();
            
            // Refresh lista
            renderEntiList();
            
            // Clear input
            document.getElementById('newEnteNome').value = '';
            
            showNotification(`‚úÖ Comune "${nome}" aggiunto con successo!`);
        }

        function editEnte(index, currentName) {
            const newName = prompt(`‚úèÔ∏è Modifica nome comune:\n\nNome attuale: ${currentName}\n\nInserisci nuovo nome:`, currentName);
            
            if (!newName || newName.trim() === '' || newName === currentName) {
                return;
            }

            if (SISTEMA_CONFIG.comuni.includes(newName)) {
                showNotification('‚ùå Questo nome √® gi√† in uso', 'error');
                return;
            }

            const oldName = SISTEMA_CONFIG.comuni[index];
            
            // Aggiorna nel sistema
            SISTEMA_CONFIG.comuni[index] = newName;
            
            // Aggiorna tutti gli adempimenti esistenti
            adempimenti.forEach(adempimento => {
                if (adempimento.comuni[oldName]) {
                    adempimento.comuni[newName] = adempimento.comuni[oldName];
                    delete adempimento.comuni[oldName];
                }
            });
            
            // Aggiorna UI
            updateComuneFilter();
            updateEntiGridForm();
            renderEntiList();
            renderAdempimenti();
            
            showNotification(`‚úÖ Comune rinominato da "${oldName}" a "${newName}"`);
        }

        function deleteEnte(index, nome) {
            if (getAdempimentiCountForComune(nome) > 0) {
                showNotification('‚ùå Impossibile eliminare: comune con adempimenti associati', 'error');
                return;
            }

            if (confirm(`‚ö†Ô∏è Sei sicuro di voler eliminare il comune "${nome}"?\n\nQuesta azione non pu√≤ essere annullata.`)) {
                // Rimuovi dal sistema
                SISTEMA_CONFIG.comuni.splice(index, 1);
                
                // Aggiorna UI
                updateComuneFilter();
                updateEntiGridForm();
                renderEntiList();
                
                showNotification(`üóëÔ∏è Comune "${nome}" eliminato con successo`);
            }
        }

        function updateComuneFilter() {
            const filterSelect = document.getElementById('filterComune');
            const currentValue = filterSelect.value;
            
            filterSelect.innerHTML = `
                <option value="">Tutti i comuni</option>
                ${SISTEMA_CONFIG.comuni.map(comune => `
                    <option value="${comune}">${comune}</option>
                `).join('')}
            `;
            
            // Mantieni selezione se ancora valida
            if (SISTEMA_CONFIG.comuni.includes(currentValue)) {
                filterSelect.value = currentValue;
            }
        }

        function updateEntiGridForm() {
            const grid = document.getElementById('entiGridForm');
            grid.innerHTML = SISTEMA_CONFIG.comuni.map(comune => `
                <label><input type="checkbox" value="${comune}"> ${comune}</label>
            `).join('');
        }

        function saveEntiChanges() {
            // In production qui salveresti in SharePoint
            showNotification('üíæ Modifiche salvate nel sistema locale! In production verranno salvate in SharePoint.');
            closeEntiModal();
        }

        function showNotification(message, type = 'success') {
            // Rimuovi notifiche esistenti
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Mostra animazione
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Nascondi dopo 4 secondi
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Event listeners globali
        window.onclick = function(event) {
            const adempimentoModal = document.getElementById('adempimentoModal');
            const progressModal = document.getElementById('progressModal');
            const entiModal = document.getElementById('entiModal');
            
            if (event.target === adempimentoModal) {
                closeModal();
            }
            if (event.target === progressModal) {
                closeProgressModal();
            }
            if (event.target === entiModal) {
                closeEntiModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeProgressModal();
                closeEntiModal();
            }
        });

        console.log('‚úÖ Sistema Completo Scadenziario Studio Grismondi - INIZIALIZZATO');
        console.log('üìä 19 Comuni Lombardi Configurati (inclusi Rogno e Ubiale Clanezzo)');
        console.log('üë• 4 Utenti Configurati con Controllo Accessi (1 Admin + 3 User)');
        console.log('üîó Pronto per Integrazione SharePoint + Teams + Outlook');
        console.log('‚ú® Funzionalit√† Avanzate: Modifica, Eliminazione, Progress Tracking, Filtri');
        console.log('üéØ Sistema Pronto per Deploy Azure Static Web Apps');
    // Esporta funzioni globalmente
window.editAdempimento = editAdempimento;
window.deleteAdempimento = deleteAdempimento;

      </script>
    <script>
// üö® FIX URGENTE PERSISTENZA DATI - IMPLEMENTAZIONE IMMEDIATA
// Codice da aggiungere SUBITO al sistema per risolvere la perdita dati

// ========== PATCH IMMEDIATO - SOSTITUISCI getStatoComune() ==========
function getStatoComune(adempimentoId, comune) {
    const storageKey = `stato_${adempimentoId}_${comune}`;
    const stato = localStorage.getItem(storageKey);
    
    // Se non trova lo stato, salva "In Corso" come default
    if (!stato) {
        localStorage.setItem(storageKey, 'In Corso');
        console.log(`üíæ Stato inizializzato per ${comune}: In Corso`);
        return 'In Corso';
    }
    
    return stato;
}

// ========== PATCH IMMEDIATO - SOSTITUISCI updateStatoComune() ==========
function updateStatoComune(adempimentoId, comune, nuovoStato) {
    const storageKey = `stato_${adempimentoId}_${comune}`;
    
    try {
        // Salvataggio principale
        localStorage.setItem(storageKey, nuovoStato);
        
        // üÜï BACKUP IMMEDIATO in sessionStorage
        sessionStorage.setItem(storageKey, nuovoStato);
        
        // üÜï LOG dettagliato per debugging
        console.log(`üíæ Stato aggiornato - Adempimento: ${adempimentoId}, Comune: ${comune}, Nuovo Stato: ${nuovoStato}`);
        console.log(`üíæ Chiave storage: ${storageKey}`);
        console.log(`üíæ Verifica salvato localStorage:`, localStorage.getItem(storageKey));
        console.log(`üíæ Verifica salvato sessionStorage:`, sessionStorage.getItem(storageKey));
        
        // Aggiorna immediatamente la UI
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
        if (typeof updateProgressIndicators === 'function') {
            updateProgressIndicators();
        }
        
    } catch (error) {
        console.error('‚ùå ERRORE nel salvataggio stato:', error);
        alert('Errore nel salvataggio. I dati potrebbero non essere stati salvati correttamente.');
    }
}

// ========== FIX CRITICO - BACKUP AUTOMATICO DATI ==========
function backupDatiCompleto() {
    console.log('üíæ Eseguendo backup completo dei dati...');
    
    try {
        // 1. Backup adempimenti
        if (window.adempimentiData && window.adempimentiData.length > 0) {
            localStorage.setItem('BACKUP_adempimenti', JSON.stringify(window.adempimentiData));
            sessionStorage.setItem('BACKUP_adempimenti', JSON.stringify(window.adempimentiData));
            console.log(`‚úÖ Backup ${window.adempimentiData.length} adempimenti`);
        }
        
        // 2. Backup enti
        if (window.entiData && window.entiData.length > 0) {
            localStorage.setItem('BACKUP_enti', JSON.stringify(window.entiData));
            sessionStorage.setItem('BACKUP_enti', JSON.stringify(window.entiData));
            console.log(`‚úÖ Backup ${window.entiData.length} enti`);
        }
        
        // 3. Backup tutti gli stati
        const tuttiStati = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('stato_')) {
                tuttiStati[key] = localStorage.getItem(key);
            }
        }
        
        if (Object.keys(tuttiStati).length > 0) {
            localStorage.setItem('BACKUP_stati', JSON.stringify(tuttiStati));
            sessionStorage.setItem('BACKUP_stati', JSON.stringify(tuttiStati));
            console.log(`‚úÖ Backup ${Object.keys(tuttiStati).length} stati comuni`);
        }
        
        // 4. Salva timestamp ultimo backup
        const timestamp = new Date().toISOString();
        localStorage.setItem('ULTIMO_BACKUP', timestamp);
        sessionStorage.setItem('ULTIMO_BACKUP', timestamp);
        
        console.log('‚úÖ Backup completo terminato alle:', timestamp);
        
    } catch (error) {
        console.error('‚ùå ERRORE nel backup:', error);
    }
}

// ========== FIX CRITICO - RIPRISTINO DATI ==========
function ripristinaDatiBackup() {
    console.log('üîÑ Tentativo ripristino dati da backup...');
    
    try {
        let datiRipristinati = false;
        
        // 1. Ripristina adempimenti
        let backupAdempimenti = localStorage.getItem('BACKUP_adempimenti') || sessionStorage.getItem('BACKUP_adempimenti');
        if (backupAdempimenti) {
            window.adempimentiData = JSON.parse(backupAdempimenti);
            console.log(`üîÑ Ripristinati ${window.adempimentiData.length} adempimenti da backup`);
            datiRipristinati = true;
        }
        
        // 2. Ripristina enti
        let backupEnti = localStorage.getItem('BACKUP_enti') || sessionStorage.getItem('BACKUP_enti');
        if (backupEnti) {
            window.entiData = JSON.parse(backupEnti);
            console.log(`üîÑ Ripristinati ${window.entiData.length} enti da backup`);
            datiRipristinati = true;
        }
        
        // 3. Ripristina stati
        let backupStati = localStorage.getItem('BACKUP_stati') || sessionStorage.getItem('BACKUP_stati');
        if (backupStati) {
            const stati = JSON.parse(backupStati);
            Object.keys(stati).forEach(key => {
                localStorage.setItem(key, stati[key]);
            });
            console.log(`üîÑ Ripristinati ${Object.keys(stati).length} stati da backup`);
            datiRipristinati = true;
        }
        
        if (datiRipristinati) {
            console.log('‚úÖ RIPRISTINO COMPLETATO - Aggiornando UI...');
            
            // Aggiorna UI
            setTimeout(() => {
                if (typeof renderAdempimenti === 'function') {
                    renderAdempimenti();
                }
                if (typeof updateDashboard === 'function') {
                    updateDashboard();
                }
                if (typeof updateProgressIndicators === 'function') {
                    updateProgressIndicators();
                }
            }, 500);
            
            return true;
        } else {
            console.warn('‚ö†Ô∏è Nessun backup trovato per il ripristino');
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå ERRORE nel ripristino:', error);
        return false;
    }
}

// ========== MONITORAGGIO CONTINUO ==========
function monitoraPersistenza() {
    // Backup automatico ogni 2 minuti
    setInterval(() => {
        backupDatiCompleto();
    }, 120000);
    
    // Verifica integrit√† ogni minuto
    setInterval(() => {
        const adempimentiCount = window.adempimentiData?.length || 0;
        const entiCount = window.entiData?.length || 0;
        
        if (adempimentiCount === 0 && entiCount === 0) {
            console.warn('‚ö†Ô∏è ALERT: Nessun dato in memoria, tentando ripristino...');
            ripristinaDatiBackup();
        }
    }, 60000);
    
    console.log('üëÄ Monitoraggio persistenza attivato');
}

// ========== INIZIALIZZAZIONE IMMEDIATA ==========
function inizializzaFixUrgente() {
    console.log('üö® INIZIALIZZANDO FIX URGENTE PERSISTENZA...');
    
    // 1. Controlla se ci sono dati in memoria
    const datiPresenti = (window.adempimentiData && window.adempimentiData.length > 0) ||
                        (window.entiData && window.entiData.length > 0);
    
    if (datiPresenti) {
        console.log('‚úÖ Dati presenti in memoria, eseguendo backup...');
        backupDatiCompleto();
    } else {
        console.log('‚ö†Ô∏è Nessun dato in memoria, tentando ripristino...');
        ripristinaDatiBackup();
    }
    
    // 2. Avvia monitoraggio
    monitoraPersistenza();
    
    // 3. Esporta funzioni globalmente
    window.backupDatiCompleto = backupDatiCompleto;
    window.ripristinaDatiBackup = ripristinaDatiBackup;
    window.getStatoComune = getStatoComune;
    window.updateStatoComune = updateStatoComune;

    </script>
<script>


// üöÄ FIX DEFINITIVO COMPLETO - RISOLVE TUTTO
// Sostituisce completamente il fix di persistenza precedente

// ========== FUNZIONE RENDERING CORRETTA ==========
function renderAdempimenti() {
    const container = document.getElementById('adempimentiContainer');
    if (!container || !window.adempimentiData || window.adempimentiData.length === 0) {
        if (container) {
            container.innerHTML = '<div class="alert alert-warning">üì≠ Nessun adempimento da visualizzare</div>';
        }
        return;
    }
    
    let html = '<div class="row">';
    
    window.adempimentiData.forEach(adempimento => {
        const comuni = adempimento.Comuni ? adempimento.Comuni.split(';').filter(c => c.trim()) : [];
        let completati = 0;
        
        // Conta comuni completati
        comuni.forEach(comune => {
            const stato = getStatoComune(adempimento.ID, comune.trim());
            if (stato === 'Completato') completati++;
        });
        
        const percentuale = comuni.length > 0 ? Math.round((completati / comuni.length) * 100) : 0;
        const badgeColor = adempimento.Priorita === 'Alta' ? 'danger' : adempimento.Priorita === 'Media' ? 'warning' : 'success';
        
        html += `
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${adempimento.Titolo}</h5>
                        <span class="badge badge-${badgeColor}">${adempimento.Priorita || 'Media'}</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${adempimento.Descrizione || 'Nessuna descrizione'}</p>
                        <p><strong>üìÖ Scadenza:</strong> ${adempimento.Scadenza || 'Non specificata'}</p>
                        <p><strong>üìä Progresso:</strong> ${completati}/${comuni.length} comuni (${percentuale}%)</p>
                        
                        <div class="progress mb-3" style="height: 10px;">
                            <div class="progress-bar ${percentuale === 100 ? 'bg-success' : percentuale > 50 ? 'bg-warning' : 'bg-danger'}" 
                                 style="width: ${percentuale}%">
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-primary btn-sm" 
                                    onclick="apriProgressModal(${adempimento.ID}, '${adempimento.Titolo}', '${adempimento.Comuni}')">
                                üèõÔ∏è Gestisci Comuni
                            </button>
                            <small class="text-muted align-self-center">${comuni.length} comuni</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    console.log(`‚úÖ Renderizzati ${window.adempimentiData.length} adempimenti`);
}

// ========== FUNZIONE CARICAMENTO DATI ==========
function loadAdempimentiData() {
    console.log('üîÑ Caricamento dati adempimenti...');
    
    // Prima prova a recuperare dai backup
    let datiRecuperati = false;
    
    // 1. Prova localStorage backup
    const backupAdempimenti = localStorage.getItem('BACKUP_adempimenti');
    if (backupAdempimenti) {
        try {
            window.adempimentiData = JSON.parse(backupAdempimenti);
            console.log(`‚úÖ Recuperati ${window.adempimentiData.length} adempimenti da backup localStorage`);
            datiRecuperati = true;
        } catch (e) {
            console.error('‚ùå Errore parsing backup localStorage:', e);
        }
    }
    
    // 2. Se non trova backup, crea dati demo (in attesa SharePoint)
    if (!datiRecuperati) {
        console.log('üìä Creando dati demo per testing...');
        window.adempimentiData = [
            {
                ID: 1,
                Titolo: "Bilancio di Previsione 2024",
                Descrizione: "Approvazione e invio bilancio di previsione annuale",
                Scadenza: "2024-12-31",
                Comuni: "Rogno;Ubiale Clanezzo;Bergamo;Lovere",
                Priorita: "Alta",
                CreatedBy: "Sistema"
            },
            {
                ID: 2,
                Titolo: "Dichiarazione Rifiuti TARI",
                Descrizione: "Presentazione dichiarazione annuale TARI per i comuni",
                Scadenza: "2024-11-30",
                Comuni: "Milano;Roma;Torino;Brescia;Cremona",
                Priorita: "Media",
                CreatedBy: "Sistema"
            },
            {
                ID: 3,
                Titolo: "Rendiconto della Gestione",
                Descrizione: "Rendiconto finanziario annuale per tutti gli enti",
                Scadenza: "2025-01-15",
                Comuni: "Rogno;Bergamo;Lovere",
                Priorita: "Alta",
                CreatedBy: "Sistema"
            }
        ];
        
        console.log(`‚úÖ Creati ${window.adempimentiData.length} adempimenti demo`);
    }
    
    // 3. Salva backup immediato
    backupDatiCompleto();
    
    // 4. Renderizza
    setTimeout(() => {
        renderAdempimenti();
        updateDashboard();
    }, 100);
}

// ========== FUNZIONE DASHBOARD CORRETTA ==========
function updateDashboard() {
    if (!window.adempimentiData) return;
    
    const totalCount = document.getElementById('totalCount');
    const totalProgress = document.getElementById('totalProgress');
    const completedCount = document.getElementById('completedCount');
    const pendingCount = document.getElementById('pendingCount');
    
    const total = window.adempimentiData.length;
    let completati = 0;
    let totalComuni = 0;
    let comuniCompletati = 0;
    
    window.adempimentiData.forEach(adempimento => {
        const comuni = adempimento.Comuni ? adempimento.Comuni.split(';').filter(c => c.trim()) : [];
        totalComuni += comuni.length;
        
        let adempimentoCompletato = true;
        comuni.forEach(comune => {
            const stato = getStatoComune(adempimento.ID, comune.trim());
            if (stato === 'Completato') {
                comuniCompletati++;
            } else {
                adempimentoCompletato = false;
            }
        });
        
        if (adempimentoCompletato && comuni.length > 0) {
            completati++;
        }
    });
    
    const percentualeAdempimenti = total > 0 ? Math.round((completati / total) * 100) : 0;
    const percentualeComuni = totalComuni > 0 ? Math.round((comuniCompletati / totalComuni) * 100) : 0;
    
    // Aggiorna elementi dashboard
    if (totalCount) totalCount.textContent = total;
    if (totalProgress) totalProgress.textContent = `${percentualeAdempimenti}%`;
    if (completedCount) completedCount.textContent = completati;
    if (pendingCount) pendingCount.textContent = total - completati;
    
    // Aggiorna progress bar se esiste
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        if (bar.closest('#totalProgress')) {
            bar.style.width = `${percentualeAdempimenti}%`;
        }
    });
    
    console.log(`üìä Dashboard aggiornata: ${completati}/${total} adempimenti (${percentualeAdempimenti}%)`);
}

// ========== FUNZIONE MODAL PROGRESS ==========
function apriProgressModal(adempimentoId, titoloAdempimento, comuni) {
    console.log(`üîß Apertura modal per adempimento ${adempimentoId}`);
    
    if (!comuni || comuni === '' || comuni === 'undefined') {
        alert('‚ö†Ô∏è Nessun comune associato a questo adempimento');
        return;
    }
    
    const comuniArray = comuni.split(';').filter(c => c.trim() !== '');
    
    if (comuniArray.length === 0) {
        alert('‚ö†Ô∏è Nessun comune valido trovato');
        return;
    }
    
    // Mostra alert con lista comuni
    const adempimento = window.adempimentiData.find(a => a.ID == adempimentoId);
    const titolo = adempimento ? adempimento.Titolo : titoloAdempimento;
    
    alert(`üèõÔ∏è Comuni per "${titolo}":\n\n${comuniArray.join('\n')}\n\nüìä Totale: ${comuniArray.length} comuni`);
}

    

// ========== FUNZIONI STATO COMUNI (CORRETTE) ==========
function getStatoComune(adempimentoId, comune) {
    const storageKey = `stato_${adempimentoId}_${comune}`;
    const stato = localStorage.getItem(storageKey);
    return stato || 'In Corso';
}

function updateStatoComune(adempimentoId, comune, nuovoStato) {
    const storageKey = `stato_${adempimentoId}_${comune}`;
    
    try {
        localStorage.setItem(storageKey, nuovoStato);
        sessionStorage.setItem(storageKey, nuovoStato);
        
        console.log(`üíæ Stato aggiornato: ${comune} ‚Üí ${nuovoStato}`);
        
        // Aggiorna UI immediatamente
        setTimeout(() => {
            renderAdempimenti();
            updateDashboard();
            backupDatiCompleto();
        }, 100);
        
    } catch (error) {
        console.error('‚ùå Errore aggiornamento stato:', error);
        alert('Errore nel salvataggio. Riprova.');
    }
}

// ========== BACKUP E RIPRISTINO (CORRETTI) ==========
function backupDatiCompleto() {
    try {
        if (window.adempimentiData && window.adempimentiData.length > 0) {
            localStorage.setItem('BACKUP_adempimenti', JSON.stringify(window.adempimentiData));
            sessionStorage.setItem('BACKUP_adempimenti', JSON.stringify(window.adempimentiData));
        }
        
        const tuttiStati = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('stato_')) {
                tuttiStati[key] = localStorage.getItem(key);
            }
        }
        
        if (Object.keys(tuttiStati).length > 0) {
            localStorage.setItem('BACKUP_stati', JSON.stringify(tuttiStati));
            sessionStorage.setItem('BACKUP_stati', JSON.stringify(tuttiStati));
        }
        
        localStorage.setItem('ULTIMO_BACKUP', Date.now().toString());
        
    } catch (error) {
        console.error('‚ùå Errore backup:', error);
    }
}

function ripristinaDatiBackup() {
    try {
        let ripristinato = false;
        
        // Ripristina adempimenti
        const backupAdempimenti = localStorage.getItem('BACKUP_adempimenti') || 
                                  sessionStorage.getItem('BACKUP_adempimenti');
        if (backupAdempimenti) {
            window.adempimentiData = JSON.parse(backupAdempimenti);
            console.log(`üîÑ Ripristinati ${window.adempimentiData.length} adempimenti`);
            ripristinato = true;
        }
        
        // Ripristina stati
        const backupStati = localStorage.getItem('BACKUP_stati') || 
                           sessionStorage.getItem('BACKUP_stati');
        if (backupStati) {
            const stati = JSON.parse(backupStati);
            Object.keys(stati).forEach(key => {
                localStorage.setItem(key, stati[key]);
            });
            console.log(`üîÑ Ripristinati ${Object.keys(stati).length} stati`);
            ripristinato = true;
        }
        
        if (ripristinato) {
            setTimeout(() => {
                renderAdempimenti();
                updateDashboard();
            }, 500);
        }
        
        return ripristinato;
    } catch (error) {
        console.error('‚ùå Errore ripristino:', error);
        return false;
    }
}

// ========== INIZIALIZZAZIONE COMPLETA ==========
function inizializzaSistemaCompleto() {
    console.log('üöÄ INIZIALIZZAZIONE SISTEMA COMPLETO...');
    
    // 1. Controlla se ci sono dati
    const datiEsistenti = window.adempimentiData && window.adempimentiData.length > 0;
    
    if (!datiEsistenti) {
        console.log('üìä Nessun dato in memoria, caricando...');
        const ripristinato = ripristinaDatiBackup();
        
        if (!ripristinato) {
            console.log('üìã Nessun backup, caricando dati freschi...');
            loadAdempimentiData();
        }
    } else {
        console.log('‚úÖ Dati gi√† presenti, renderizzando...');
        renderAdempimenti();
        updateDashboard();
    }
    
    // 2. Auto-backup ogni 2 minuti
    setInterval(backupDatiCompleto, 120000);
    
    // 3. Monitoraggio
    setInterval(() => {
        if (!window.adempimentiData || window.adempimentiData.length === 0) {
            console.log('‚ö†Ô∏è Dati spariti, tentando ripristino...');
            loadAdempimentiData();
        }
    }, 30000);
    
    // 4. Backup prima della chiusura
    window.addEventListener('beforeunload', backupDatiCompleto);
    
    // 5. Esporta funzioni globalmente
    window.renderAdempimenti = renderAdempimenti;
    window.loadAdempimentiData = loadAdempimentiData;
    window.updateDashboard = updateDashboard;
    window.getStatoComune = getStatoComune;
    window.updateStatoComune = updateStatoComune;
    window.apriProgressModal = apriProgressModal;
    window.backupDatiCompleto = backupDatiCompleto;
    window.ripristinaDatiBackup = ripristinaDatiBackup;
    
    console.log('‚úÖ SISTEMA COMPLETO INIZIALIZZATO!');
}

// ========== AVVIO AUTOMATICO ==========
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inizializzaSistemaCompleto);
} else {
    inizializzaSistemaCompleto();
}

    }
</script>

</body>
</html>


