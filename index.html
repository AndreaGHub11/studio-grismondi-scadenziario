<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scadenziario Studio Grismondi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .alert-banner {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 15px 30px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
            animation: pulse 2s infinite;
            display: none;
        }

        .alert-banner.visible {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .user-section {
            background: #34495e;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-badge {
            background: #3498db;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .admin-badge {
            background: #e74c3c;
        }

        select, button, input {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        button {
            background: #3498db;
            color: white;
            font-weight: bold;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #ecf0f1;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            margin: 8px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .stat-totali .stat-number { color: #3498db; }
        .stat-completati .stat-number { color: #27ae60; }
        .stat-dafare .stat-number { color: #f39c12; }
        .stat-scaduti .stat-number { color: #e74c3c; }

        .controls {
            padding: 25px 30px;
            background: white;
            border-top: 3px solid #ecf0f1;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 13px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-primary { background: #3498db; }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .btn-warning { background: #f39c12; }
        .btn-secondary { background: #95a5a6; }
        .btn-purple { background: #9b59b6; }

        .adempimenti-list {
            padding: 30px;
        }

        .adempimento-card {
            background: white;
            border-left: 5px solid #3498db;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .adempimento-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .adempimento-card.categoria-contabilita { border-left-color: #3498db; }
        .adempimento-card.categoria-tributi { border-left-color: #e74c3c; }
        .adempimento-card.categoria-personale { border-left-color: #9b59b6; }
        .adempimento-card.categoria-rendicontazione { border-left-color: #27ae60; }
        .adempimento-card.categoria-monitoraggi { border-left-color: #f39c12; }

        .adempimento-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            gap: 15px;
            cursor: pointer;
        }

        .adempimento-header:hover {
            opacity: 0.8;
        }

        .adempimento-title-section {
            flex: 1;
        }

        .adempimento-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .adempimento-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 14px;
            color: #555;
        }

        .adempimento-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            white-space: nowrap;
        }

        .badge-categoria-contabilita { background: #3498db; }
        .badge-categoria-tributi { background: #e74c3c; }
        .badge-categoria-personale { background: #9b59b6; }
        .badge-categoria-rendicontazione { background: #27ae60; }
        .badge-categoria-monitoraggi { background: #f39c12; }
        .badge-scaduto { background: #e74c3c; }
        .badge-prossimo { background: #f39c12; }

        .progress-section {
            margin: 15px 0;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s;
        }

        .toggle-icon {
            font-size: 1.5em;
            color: #3498db;
            transition: transform 0.3s;
        }

        .toggle-icon.expanded {
            transform: rotate(180deg);
        }

        .enti-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }

        .enti-details.visible {
            display: block;
        }

        .enti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .ente-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .ente-item:hover {
            border-color: #3498db;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.2);
        }

        .ente-item.completato {
            background: #d4edda;
            border-color: #28a745;
        }

        .ente-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .ente-nome {
            font-weight: bold;
            color: #2c3e50;
            font-size: 15px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-custom {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #27ae60;
        }

        .checkbox-label {
            font-size: 14px;
            font-weight: 600;
            color: #27ae60;
        }

        .note-section {
            margin-top: 10px;
        }

        .note-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .note-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .note-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .adempimento-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #ecf0f1;
            flex-wrap: wrap;
        }

        .adempimento-actions button {
            padding: 8px 16px;
            font-size: 13px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-header h2 {
            color: #2c3e50;
            font-size: 1.8em;
        }

        .close-modal {
            background: #e74c3c;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .comuni-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            padding: 15px;
            background: #f8f9fa;
        }

        .comune-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .comune-checkbox:hover {
            background: #ecf0f1;
        }

        .comune-checkbox input {
            width: auto;
            margin-right: 10px;
        }

        .select-all-comuni {
            margin-bottom: 15px;
            padding: 10px;
            background: #3498db;
            color: white;
            width: 100%;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .filters {
                grid-template-columns: 1fr;
            }

            .enti-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📅 Scadenziario Studio Grismondi</h1>
            <p>Sistema Gestione Adempimenti - <span id="currentMonthDisplay">Ottobre 2025</span></p>
        </div>

        <!-- User Section -->
        <div class="user-section">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span>Utente:</span>
                <span class="user-badge" id="currentUserBadge">Andrea Grismondi</span>
            </div>
            <div>
                <select id="userSelector" onchange="switchUtente()">
                    <option value="Andrea Grismondi">Andrea Grismondi (Admin)</option>
                    <option value="Roberta">Roberta</option>
                    <option value="Nicoletta">Nicoletta</option>
                    <option value="Miriana">Miriana</option>
                </select>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="stat-card stat-totali">
                <div class="stat-label">Totali</div>
                <div class="stat-number" id="statTotali">0</div>
            </div>
            <div class="stat-card stat-completati">
                <div class="stat-label">Completati</div>
                <div class="stat-number" id="statCompletati">0</div>
            </div>
            <div class="stat-card stat-dafare">
                <div class="stat-label">Da Fare</div>
                <div class="stat-number" id="statDaFare">0</div>
            </div>
            <div class="stat-card stat-scaduti">
                <div class="stat-label">Scaduti</div>
                <div class="stat-number" id="statScaduti">0</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="filters">
                <div class="filter-group">
                    <label>Mese</label>
                    <input type="month" id="filtroMese" onchange="applicaFiltri()">
                </div>
                <div class="filter-group">
                    <label>Categoria</label>
                    <select id="filtroCategoria" onchange="applicaFiltri()">
                        <option value="">Tutte</option>
                        <option value="Contabilità">Contabilità</option>
                        <option value="Tributi">Tributi</option>
                        <option value="Personale">Personale</option>
                        <option value="Rendicontazione">Rendicontazione</option>
                        <option value="Monitoraggi">Monitoraggi</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Stato</label>
                    <select id="filtroStato" onchange="applicaFiltri()">
                        <option value="">Tutti</option>
                        <option value="completati">Solo Completati</option>
                        <option value="da_fare">Da Fare</option>
                        <option value="scaduti">Scaduti</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Ricerca</label>
                    <input type="text" id="filtroRicerca" placeholder="Cerca..." onkeyup="applicaFiltri()">
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn-primary" id="btnNuovo" onclick="apriModalCreazione()">➕ Nuovo Adempimento</button>
                <button class="btn-secondary" onclick="pulisciFiltri()">🔄 Pulisci Filtri</button>
                <button class="btn-success" onclick="esportaDati()">📥 Esporta CSV</button>
                <button class="btn-warning" onclick="ripristinaDati()">📤 Importa</button>
                <button class="btn-purple" onclick="gestioneEnti()">🏛️ Gestisci Enti</button>
            </div>
        </div>

        <!-- Lista Adempimenti -->
        <div class="adempimenti-list" id="adempimentiContainer">
            <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                <div style="font-size: 3em; margin-bottom: 20px;">📋</div>
                <p>Caricamento adempimenti...</p>
            </div>
        </div>
    </div>

    <!-- Modal Adempimento -->
    <div class="modal" id="modalAdempimento">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitolo">Nuovo Adempimento</h2>
                <button class="close-modal" onclick="chiudiModal('modalAdempimento')">✕</button>
            </div>
            <form id="formAdempimento" onsubmit="salvaAdempimento(event)">
                <input type="hidden" id="adempimentoId">
                
                <div class="form-group">
                    <label>Titolo *</label>
                    <input type="text" id="inputTitolo" required placeholder="Es: F24EP stipendi SETTEMBRE">
                </div>

                <div class="form-group">
                    <label>Descrizione</label>
                    <textarea id="inputDescrizione" placeholder="Dettagli..."></textarea>
                </div>

                <div class="form-group">
                    <label>Categoria *</label>
                    <select id="inputCategoria" required>
                        <option value="Contabilità">Contabilità</option>
                        <option value="Tributi">Tributi</option>
                        <option value="Personale">Personale</option>
                        <option value="Rendicontazione">Rendicontazione</option>
                        <option value="Monitoraggi">Monitoraggi</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Scadenza *</label>
                    <input type="date" id="inputScadenza" required>
                </div>

                <div class="form-group">
                    <label>Email Promemoria (separati da virgola)</label>
                    <input type="text" id="inputEmail" placeholder="mario@studio.it, laura@studio.it">
                </div>

                <div class="form-group">
                    <label>Comuni *</label>
                    <button type="button" class="select-all-comuni" onclick="toggleTuttiComuni()">Seleziona/Deseleziona Tutti</button>
                    <div class="comuni-selector" id="comuniSelector"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-success">💾 Salva</button>
                    <button type="button" class="btn-secondary" onclick="chiudiModal('modalAdempimento')">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gestione Enti -->
    <div class="modal" id="modalEnti">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gestione Enti</h2>
                <button class="close-modal" onclick="chiudiModal('modalEnti')">✕</button>
            </div>
            <div id="listaEnti"></div>
            <div class="form-actions">
                <button class="btn-primary" onclick="aggiungiEnte()">➕ Aggiungi Ente</button>
                <button class="btn-secondary" onclick="chiudiModal('modalEnti')">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAZIONE
        // ============================================
        
        const COMUNI_DEFAULT = [
            'Bossico', 'Carobbio degli Angeli', 'Castro', 'Cavernago',
            'Cenate Sotto', 'Colere', 'Filago', 'Foppolo', 'Onore',
            'Osio Sopra', 'Osio Sotto', 'Parzanica', 'Ponte San Pietro',
            'Rogno', 'Selvino', 'Solto Collina', 'Telgate',
            'Ubiale Clanezzo', 'Zanica'
        ];

        const STORAGE_KEY = 'scadenziari_adempimenti';
        const STORAGE_KEY_COMUNI = 'scadenziari_comuni';
        
        let adempimenti = [];
        let comuni = [];
        let utenteCorrente = 'Andrea Grismondi';
        let meseCorrente = '';

        // ============================================
        // INIZIALIZZAZIONE
        // ============================================

        function inizializzaSistema() {
            console.log('🚀 Inizializzazione Sistema...');
            
            caricaDati();
            impostaMeseCorrente();
            popolaFiltroMese();
            popolaComuniModal();
            verificaScadenzeImminenti();
            aggiornaStatistiche();
            renderizzaAdempimenti();
            
            console.log('✅ Sistema inizializzato');
        }

        function caricaDati() {
            try {
                const comuniSalvati = localStorage.getItem(STORAGE_KEY_COMUNI);
                comuni = comuniSalvati ? JSON.parse(comuniSalvati) : [...COMUNI_DEFAULT];
                
                const datiSalvati = localStorage.getItem(STORAGE_KEY);
                adempimenti = datiSalvati ? JSON.parse(datiSalvati) : [];
                
                console.log('✅ Dati caricati:', adempimenti.length, 'adempimenti');
            } catch (error) {
                console.error('❌ Errore caricamento:', error);
                comuni = [...COMUNI_DEFAULT];
                adempimenti = [];
            }
        }

        function salvaDati() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(adempimenti));
                localStorage.setItem(STORAGE_KEY_COMUNI, JSON.stringify(comuni));
                console.log('💾 Dati salvati');
                return true;
            } catch (error) {
                console.error('❌ Errore salvataggio:', error);
                alert('Errore nel salvataggio');
                return false;
            }
        }

        function impostaMeseCorrente() {
            const oggi = new Date();
            const anno = oggi.getFullYear();
            const mese = String(oggi.getMonth() + 1).padStart(2, '0');
            meseCorrente = `${anno}-${mese}`;
            document.getElementById('filtroMese').value = meseCorrente;
            
            const nomeMese = oggi.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonthDisplay').textContent = nomeMese.charAt(0).toUpperCase() + nomeMese.slice(1);
        }

        function popolaFiltroMese() {
            // Il filtro mese è già un input type="month", non serve popolare
        }

        // ============================================
        // GESTIONE UTENTI
        // ============================================

        function switchUtente() {
            utenteCorrente = document.getElementById('userSelector').value;
            const badge = document.getElementById('currentUserBadge');
            badge.textContent = utenteCorrente;
            badge.className = 'user-badge' + (utenteCorrente === 'Andrea Grismondi' ? ' admin-badge' : '');
            renderizzaAdempimenti();
        }

        function isUtenteAdmin() {
            return utenteCorrente === 'Andrea Grismondi';
        }

        // ============================================
        // ALERT SCADENZE
        // ============================================

        function verificaScadenzeImminenti() {
            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);
            const treGiorni = new Date(oggi);
            treGiorni.setDate(treGiorni.getDate() + 3);
            
            const scadenzeImminenti = adempimenti.filter(a => {
                const scadenza = new Date(a.Scadenza);
                scadenza.setHours(0, 0, 0, 0);
                return scadenza <= treGiorni && scadenza >= oggi;
            });
            
            const banner = document.getElementById('alertBanner');
            if (scadenzeImminenti.length > 0) {
                banner.textContent = `⚠️ ATTENZIONE: ${scadenzeImminenti.length} adempimento/i in scadenza nei prossimi 3 giorni!`;
                banner.classList.add('visible');
            } else {
                banner.classList.remove('visible');
            }
        }

        // ============================================
        // STATISTICHE
        // ============================================

        function aggiornaStatistiche() {
            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);
            
            let totali = 0;
            let completati = 0;
            let daFare = 0;
            let scaduti = 0;
            
            adempimenti.forEach(adempimento => {
                const scadenza = new Date(adempimento.Scadenza);
                scadenza.setHours(0, 0, 0, 0);
                
                adempimento.Comuni.split(';').forEach(comune => {
                    const stato = adempimento.StatiComuni?.[comune.trim()] || { fatto: false, note: '' };
                    totali++;
                    
                    if (stato.fatto) {
                        completati++;
                    } else {
                        daFare++;
                        if (scadenza < oggi) {
                            scaduti++;
                        }
                    }
                });
            });
            
            document.getElementById('statTotali').textContent = totali;
            document.getElementById('statCompletati').textContent = completati;
            document.getElementById('statDaFare').textContent = daFare;
            document.getElementById('statScaduti').textContent = scaduti;
        }

        // ============================================
        // RENDERIZZAZIONE
        // ============================================

        function renderizzaAdempimenti() {
            const container = document.getElementById('adempimentiContainer');
            const adempimentiFiltrati = applicaFiltri();
            
            if (adempimentiFiltrati.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>Nessun adempimento trovato</h3>
                        <p>Non ci sono adempimenti per i filtri selezionati.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = adempimentiFiltrati.map(adempimento => creaCardAdempimento(adempimento)).join('');
        }

        function creaCardAdempimento(adempimento) {
            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);
            const scadenza = new Date(adempimento.Scadenza);
            scadenza.setHours(0, 0, 0, 0);
            
            let badgeScadenza = '';
            if (scadenza < oggi) {
                badgeScadenza = '<span class="badge badge-scaduto">SCADUTO</span>';
            } else {
                const giorni = Math.floor((scadenza - oggi) / (1000 * 60 * 60 * 24));
                if (giorni <= 3) {
                    badgeScadenza = `<span class="badge badge-prossimo">SCADE TRA ${giorni} GG</span>`;
                }
            }
            
            const comuni = adempimento.Comuni.split(';');
            const statiComuni = adempimento.StatiComuni || {};
            
            let completati = 0;
            comuni.forEach(comune => {
                const stato = statiComuni[comune.trim()] || { fatto: false };
                if (stato.fatto) completati++;
            });
            
            const percentuale = Math.round((completati / comuni.length) * 100);
            
            return `
                <div class="adempimento-card categoria-${adempimento.Categoria.toLowerCase()}">
                    <div class="adempimento-header" onclick="toggleEntiDetails(${adempimento.ID})">
                        <div class="adempimento-title-section">
                            <div class="adempimento-title">${adempimento.Titolo}</div>
                            <div class="adempimento-meta">
                                <div class="adempimento-meta-item">
                                    <span class="badge badge-categoria-${adempimento.Categoria.toLowerCase()}">${adempimento.Categoria}</span>
                                </div>
                                <div class="adempimento-meta-item">
                                    📅 ${formattaData(adempimento.Scadenza)}
                                </div>
                                <div class="adempimento-meta-item">
                                    🏛️ ${comuni.length} comuni
                                </div>
                                ${badgeScadenza}
                            </div>
                        </div>
                        <div>
                            <span class="toggle-icon" id="toggle-${adempimento.ID}">▼</span>
                        </div>
                    </div>
                    
                    <div class="progress-section">
                        <div class="progress-info">
                            <span><strong>Progresso:</strong> ${completati}/${comuni.length} completati</span>
                            <span><strong>${percentuale}%</strong></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentuale}%"></div>
                        </div>
                    </div>
                    
                    <div class="enti-details" id="enti-${adempimento.ID}">
                        <div class="enti-grid">
                            ${comuni.map(comune => {
                                const comunePulito = comune.trim();
                                const stato = statiComuni[comunePulito] || { fatto: false, note: '' };
                                return `
                                    <div class="ente-item ${stato.fatto ? 'completato' : ''}">
                                        <div class="ente-header">
                                            <div class="ente-nome">${comunePulito}</div>
                                            <div class="checkbox-container">
                                                <input type="checkbox" 
                                                       class="checkbox-custom" 
                                                       ${stato.fatto ? 'checked' : ''}
                                                       onchange="toggleCompletatoComune(${adempimento.ID}, '${comunePulito}', this.checked)">
                                                <span class="checkbox-label">${stato.fatto ? '✅ Fatto' : 'Da Fare'}</span>
                                            </div>
                                        </div>
                                        <div class="note-section">
                                            <div class="note-label">📝 Note:</div>
                                            <textarea class="note-input" 
                                                      placeholder="Aggiungi note per ${comunePulito}..."
                                                      onchange="aggiornaNoteComune(${adempimento.ID}, '${comunePulito}', this.value)">${stato.note || ''}</textarea>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${isUtenteAdmin() ? `
                        <div class="adempimento-actions">
                            <button class="btn-warning" onclick="modificaAdempimento(${adempimento.ID})">✏️ Modifica</button>
                            <button class="btn-danger" onclick="eliminaAdempimento(${adempimento.ID})">🗑️ Elimina</button>
                            ${adempimento.Email ? `<button class="btn-purple" onclick="inviaPromemoria(${adempimento.ID})">📧 Invia Promemoria</button>` : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function toggleEntiDetails(id) {
            const details = document.getElementById(`enti-${id}`);
            const icon = document.getElementById(`toggle-${id}`);
            
            if (details.classList.contains('visible')) {
                details.classList.remove('visible');
                icon.classList.remove('expanded');
            } else {
                details.classList.add('visible');
                icon.classList.add('expanded');
            }
        }

        function formattaData(dataStr) {
            const data = new Date(dataStr);
            return data.toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
        }

        // ============================================
        // GESTIONE STATI COMUNI
        // ============================================

        function toggleCompletatoComune(adempimentoId, comune, fatto) {
            const adempimento = adempimenti.find(a => a.ID === adempimentoId);
            if (!adempimento) return;
            
            if (!adempimento.StatiComuni) adempimento.StatiComuni = {};
            if (!adempimento.StatiComuni[comune]) adempimento.StatiComuni[comune] = { fatto: false, note: '' };
            
            adempimento.StatiComuni[comune].fatto = fatto;
            salvaDati();
            aggiornaStatistiche();
            renderizzaAdempimenti();
        }

        function aggiornaNoteComune(adempimentoId, comune, note) {
            const adempimento = adempimenti.find(a => a.ID === adempimentoId);
            if (!adempimento) return;
            
            if (!adempimento.StatiComuni) adempimento.StatiComuni = {};
            if (!adempimento.StatiComuni[comune]) adempimento.StatiComuni[comune] = { fatto: false, note: '' };
            
            adempimento.StatiComuni[comune].note = note;
            salvaDati();
        }

        // ============================================
        // FILTRI
        // ============================================

        function applicaFiltri() {
            const mese = document.getElementById('filtroMese').value;
            const categoria = document.getElementById('filtroCategoria').value;
            const stato = document.getElementById('filtroStato').value;
            const ricerca = document.getElementById('filtroRicerca').value.toLowerCase();
            
            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0);
            
            return adempimenti.filter(a => {
                // Filtro mese
                if (mese && !a.Scadenza.startsWith(mese)) return false;
                
                // Filtro categoria
                if (categoria && a.Categoria !== categoria) return false;
                
                // Filtro ricerca
                if (ricerca && !a.Titolo.toLowerCase().includes(ricerca) && !a.Descrizione?.toLowerCase().includes(ricerca)) return false;
                
                // Filtro stato
                if (stato) {
                    const scadenza = new Date(a.Scadenza);
                    scadenza.setHours(0, 0, 0, 0);
                    
                    const statiComuni = a.StatiComuni || {};
                    const comuni = a.Comuni.split(';').map(c => c.trim());
                    
                    if (stato === 'completati') {
                        return comuni.every(c => statiComuni[c]?.fatto);
                    } else if (stato === 'da_fare') {
                        return comuni.some(c => !statiComuni[c]?.fatto);
                    } else if (stato === 'scaduti') {
                        return scadenza < oggi && comuni.some(c => !statiComuni[c]?.fatto);
                    }
                }
                
                return true;
            }).sort((a, b) => new Date(a.Scadenza) - new Date(b.Scadenza));
        }

        function pulisciFiltri() {
            impostaMeseCorrente();
            document.getElementById('filtroCategoria').value = '';
            document.getElementById('filtroStato').value = '';
            document.getElementById('filtroRicerca').value = '';
            renderizzaAdempimenti();
        }

        // ============================================
        // CRUD ADEMPIMENTI
        // ============================================

        function apriModalCreazione() {
            if (!isUtenteAdmin()) {
                alert('Solo gli amministratori possono creare adempimenti');
                return;
            }
            
            document.getElementById('modalTitolo').textContent = 'Nuovo Adempimento';
            document.getElementById('formAdempimento').reset();
            document.getElementById('adempimentoId').value = '';
            
            const checkboxes = document.querySelectorAll('#comuniSelector input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            
            document.getElementById('modalAdempimento').classList.add('active');
        }

        function modificaAdempimento(id) {
            if (!isUtenteAdmin()) {
                alert('Solo gli amministratori possono modificare adempimenti');
                return;
            }
            
            const adempimento = adempimenti.find(a => a.ID === id);
            if (!adempimento) return;
            
            document.getElementById('modalTitolo').textContent = 'Modifica Adempimento';
            document.getElementById('adempimentoId').value = adempimento.ID;
            document.getElementById('inputTitolo').value = adempimento.Titolo;
            document.getElementById('inputDescrizione').value = adempimento.Descrizione || '';
            document.getElementById('inputCategoria').value = adempimento.Categoria;
            document.getElementById('inputScadenza').value = adempimento.Scadenza;
            document.getElementById('inputEmail').value = adempimento.Email || '';
            
            const comuniSelezionati = adempimento.Comuni.split(';').map(c => c.trim());
            const checkboxes = document.querySelectorAll('#comuniSelector input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = comuniSelezionati.includes(cb.value);
            });
            
            document.getElementById('modalAdempimento').classList.add('active');
        }

        function salvaAdempimento(event) {
            event.preventDefault();
            
            if (!isUtenteAdmin()) {
                alert('Solo gli amministratori possono salvare adempimenti');
                return;
            }
            
            const comuniSelezionati = Array.from(
                document.querySelectorAll('#comuniSelector input[type="checkbox"]:checked')
            ).map(cb => cb.value);
            
            if (comuniSelezionati.length === 0) {
                alert('Seleziona almeno un comune');
                return;
            }
            
            const dati = {
                Titolo: document.getElementById('inputTitolo').value.trim(),
                Descrizione: document.getElementById('inputDescrizione').value.trim(),
                Categoria: document.getElementById('inputCategoria').value,
                Scadenza: document.getElementById('inputScadenza').value,
                Email: document.getElementById('inputEmail').value.trim(),
                Comuni: comuniSelezionati.join(';')
            };
            
            const idModifica = document.getElementById('adempimentoId').value;
            
            if (idModifica) {
                const index = adempimenti.findIndex(a => a.ID === parseInt(idModifica));
                if (index !== -1) {
                    adempimenti[index] = { 
                        ...adempimenti[index], 
                        ...dati 
                    };
                }
            } else {
                const nuovoId = adempimenti.length > 0 ? Math.max(...adempimenti.map(a => a.ID)) + 1 : 1;
                adempimenti.push({ 
                    ID: nuovoId, 
                    ...dati,
                    StatiComuni: {}
                });
            }
            
            salvaDati();
            verificaScadenzeImminenti();
            aggiornaStatistiche();
            renderizzaAdempimenti();
            chiudiModal('modalAdempimento');
            alert('✅ Adempimento salvato!');
        }

        function eliminaAdempimento(id) {
            if (!isUtenteAdmin()) {
                alert('Solo gli amministratori possono eliminare adempimenti');
                return;
            }
            
            const adempimento = adempimenti.find(a => a.ID === id);
            if (!adempimento) return;
            
            if (confirm(`Confermi l'eliminazione di "${adempimento.Titolo}"?`)) {
                adempimenti = adempimenti.filter(a => a.ID !== id);
                salvaDati();
                verificaScadenzeImminenti();
                aggiornaStatistiche();
                renderizzaAdempimenti();
                alert('✅ Adempimento eliminato');
            }
        }

        // ============================================
        // INVIO PROMEMORIA
        // ============================================

        function inviaPromemoria(id) {
            const adempimento = adempimenti.find(a => a.ID === id);
            if (!adempimento || !adempimento.Email) return;
            
            const comuni = adempimento.Comuni.split(';');
            const statiComuni = adempimento.StatiComuni || {};
            
            const comuniDaCompletare = comuni.filter(c => {
                const stato = statiComuni[c.trim()] || { fatto: false };
                return !stato.fatto;
            }).map(c => c.trim());
            
            const scadenza = new Date(adempimento.Scadenza);
            const oggi = new Date();
            const giorniMancanti = Math.ceil((scadenza - oggi) / (1000 * 60 * 60 * 24));
            
            const destinatari = adempimento.Email;
            const oggetto = `Promemoria - ${adempimento.Titolo} - Scade ${scadenza.toLocaleDateString('it-IT')}`;
            const corpo = `Gentile collega,

Ti ricordo che l'adempimento "${adempimento.Titolo}" scade il ${scadenza.toLocaleDateString('it-IT')} (${giorniMancanti > 0 ? 'tra ' + giorniMancanti + ' giorni' : 'OGGI'}).

${adempimento.Descrizione ? '\nDescrizione: ' + adempimento.Descrizione + '\n' : ''}
Categoria: ${adempimento.Categoria}

Enti da completare (${comuniDaCompletare.length}/${comuni.length}):
${comuniDaCompletare.map(c => '- ' + c).join('\n')}

Cordiali saluti,
Studio Grismondi`;
            
            const mailtoLink = `mailto:${destinatari}?subject=${encodeURIComponent(oggetto)}&body=${encodeURIComponent(corpo)}`;
            window.location.href = mailtoLink;
        }

        // ============================================
        // GESTIONE ENTI
        // ============================================

        function gestioneEnti() {
            const container = document.getElementById('listaEnti');
            container.innerHTML = comuni.sort().map((comune, index) => `
                <div style="padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <strong>${comune}</strong>
                    ${isUtenteAdmin() ? `<button class="btn-danger" onclick="rimuoviEnte(${index})">🗑️ Rimuovi</button>` : ''}
                </div>
            `).join('');
            document.getElementById('modalEnti').classList.add('active');
        }

        function aggiungiEnte() {
            const nome = prompt('Inserisci il nome del nuovo ente:');
            if (nome && nome.trim() && !comuni.includes(nome.trim())) {
                comuni.push(nome.trim());
                salvaDati();
                gestioneEnti();
                popolaComuniModal();
            }
        }

        function rimuoviEnte(index) {
            if (confirm(`Rimuovere ${comuni[index]} dagli enti?`)) {
                comuni.splice(index, 1);
                salvaDati();
                gestioneEnti();
                popolaComuniModal();
            }
        }

        function popolaComuniModal() {
            const container = document.getElementById('comuniSelector');
            container.innerHTML = comuni.sort().map(comune => `
                <div class="comune-checkbox">
                    <input type="checkbox" id="comune_${comune.replace(/\s/g, '_')}" value="${comune}" name="comuni">
                    <label for="comune_${comune.replace(/\s/g, '_')}">${comune}</label>
                </div>
            `).join('');
        }

        function toggleTuttiComuni() {
            const checkboxes = document.querySelectorAll('#comuniSelector input[type="checkbox"]');
            const tuttiSelezionati = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !tuttiSelezionati);
        }

        // ============================================
        // ESPORTA/IMPORTA
        // ============================================

        function esportaDati() {
            try {
                let csvContent = "Titolo,Categoria,Scadenza,Comune,Fatto,Note\n";
                
                adempimenti.forEach(adempimento => {
                    adempimento.Comuni.split(';').forEach(comune => {
                        const comunePulito = comune.trim();
                        const stato = adempimento.StatiComuni?.[comunePulito] || { fatto: false, note: '' };
                        csvContent += `"${adempimento.Titolo}","${adempimento.Categoria}","${adempimento.Scadenza}","${comunePulito}","${stato.fatto ? 'SI' : 'NO'}","${stato.note || ''}"\n`;
                    });
                });
                
                const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'scadenziario_' + new Date().toISOString().split('T')[0] + '.csv';
                link.click();
                URL.revokeObjectURL(url);
                alert('✅ Dati esportati!');
            } catch (error) {
                console.error('❌ Errore esportazione:', error);
                alert('Errore durante l\'esportazione');
            }
        }

        function ripristinaDati() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const datiImportati = JSON.parse(e.target.result);
                            if (confirm('Confermi il ripristino? I dati attuali saranno sovrascritti.')) {
                                if (datiImportati.adempimenti) adempimenti = datiImportati.adempimenti;
                                if (datiImportati.comuni) comuni = datiImportati.comuni;
                                salvaDati();
                                inizializzaSistema();
                                alert('✅ Dati ripristinati!');
                            }
                        } catch (error) {
                            alert('Errore: file non valido');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // ============================================
        // UTILITY
        // ============================================

        function chiudiModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(event) {
                if (event.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        window.addEventListener('DOMContentLoaded', inizializzaSistema);

    </script>
</body>
</html>
