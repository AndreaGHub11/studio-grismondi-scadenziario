<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scadenziario Studio Grismondi V16</title>
    
    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #90ee90 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(79, 172, 254, 0.3);
            text-align: center;
        }
        
        .logo { font-size: 60px; margin-bottom: 20px; }
        .login-container h1 { color: #4facfe; margin-bottom: 10px; font-size: 28px; }
        .login-container p { color: #666; margin-bottom: 35px; font-size: 16px; }
        
        .login-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.4);
        }
        
        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(79, 172, 254, 0.6);
        }
        
        .app-container {
            display: none;
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(79, 172, 254, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { font-size: 26px; display: flex; align-items: center; gap: 15px; }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-name { text-align: right; }
        .user-name strong { font-size: 16px; }
        .user-name small { opacity: 0.9; display: block; font-size: 13px; }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .logout-btn:hover { background: white; color: #4facfe; }
        
        .mesi-section {
            padding: 25px 40px;
            background: linear-gradient(to right, #f8f9ff 0%, #f0fff4 100%);
            border-bottom: 2px solid #e5e7eb;
        }
        
        .mesi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .mesi-header h2 { color: #4facfe; font-size: 20px; }
        
        .mesi-aperti {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .mese-card {
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            border: 2px solid #4facfe;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.15);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .mese-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.25);
        }
        
        .mese-card.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .mese-nome { font-weight: 700; font-size: 16px; margin-bottom: 5px; }
        .mese-stats { font-size: 13px; opacity: 0.8; }
        
        .mesi-actions { display: flex; gap: 10px; }
        
        .controls {
            padding: 25px 40px;
            background: #f8f9fa;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group { display: flex; align-items: center; gap: 10px; }
        .filter-group label { font-weight: 600; color: #333; font-size: 14px; }
        
        select, input { padding: 10px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
        select:focus, input:focus { outline: none; border-color: #4facfe; }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 11px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.3);
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.5); }
        .btn-success { background: linear-gradient(135deg, #90ee90 0%, #7bed9f 100%); }
        .btn-danger { background: linear-gradient(135deg, #f14668 0%, #fa5252 100%); }
        .admin-only { display: none; }
        
        .content { padding: 40px; }
        .loading { text-align: center; padding: 60px; color: #666; }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .adempimento-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .adempimento-card:hover {
            border-color: #4facfe;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.15);
        }
        
        .adempimento-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: linear-gradient(to right, #f8f9ff 0%, #f0fff4 100%);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        
        .adempimento-header:hover { background: linear-gradient(to right, #eef0ff 0%, #e0ffe0 100%); }
        
        .adempimento-info { flex: 1; }
        .adempimento-titolo { font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 5px; }
        .adempimento-meta { font-size: 13px; color: #6b7280; }
        
        .adempimento-stats { display: flex; gap: 15px; align-items: center; }
        
        .stat-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .stat-badge.totali { background: #dbeafe; color: #1e40af; }
        .stat-badge.non-gestiti { background: #fee2e2; color: #991b1b; }
        .stat-badge.in-corso { background: #fef3c7; color: #92400e; }
        .stat-badge.completati { background: #d1fae5; color: #065f46; }
        
        .expand-icon { font-size: 20px; transition: transform 0.3s; margin-left: 15px; }
        .expand-icon.open { transform: rotate(180deg); }
        
        .comuni-list { display: none; padding: 25px; background: #fafbfc; }
        .comuni-list.open { display: block; }
        
        .comune-row {
            background: white;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .comune-row:hover {
            border-color: #4facfe;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.1);
        }
        
        .comune-info { flex: 1; }
        .comune-nome { font-weight: 600; font-size: 15px; color: #1f2937; margin-bottom: 3px; }
        .comune-note { font-size: 13px; color: #6b7280; font-style: italic; }
        
        .comune-stato { display: flex; align-items: center; gap: 15px; }
        
        .progress-bar {
            width: 150px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #90ee90 100%);
            transition: width 0.3s;
        }
        
        .stato-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            min-width: 120px;
            text-align: center;
        }
        
        .stato-badge.non-gestito { background: #fee2e2; color: #991b1b; }
        .stato-badge.in-corso { background: #fef3c7; color: #92400e; }
        .stato-badge.completato { background: #d1fae5; color: #065f46; }
        
        .comune-actions { display: flex; gap: 8px; }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px 10px;
            transition: transform 0.2s;
            border-radius: 6px;
        }
        
        .icon-btn:hover { transform: scale(1.2); background: #f3f4f6; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.open { display: flex; }
        
        .modal-content {
            background: white;
            padding: 35px;
            border-radius: 20px;
            max-width: 650px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 70px rgba(0,0,0,0.3);
        }
        
        .modal-header { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
        .modal-header h2 { color: #4facfe; font-size: 24px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-actions { display: flex; gap: 12px; margin-top: 30px; }
        
        .alert {
            padding: 18px 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #6b7280; }
        .empty-state-icon { font-size: 80px; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { color: #4facfe; margin-bottom: 10px; font-size: 20px; }
        
        .comuni-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
        }
        
        .comune-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .comune-checkbox:hover { background: #f3f4f6; }
        .comune-checkbox input { margin-right: 10px; }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <div class="logo">🏢</div>
        <h1>Studio Grismondi</h1>
        <p>Sistema Scadenziario V16</p>
        <button class="login-btn" onclick="login()">🔐 Accedi con Microsoft</button>
    </div>

    <div id="appContainer" class="app-container">
        <div class="header">
            <h1><span>📅</span>Scadenziario Studio Grismondi</h1>
            <div class="user-info">
                <div class="user-name">
                    <strong id="userName">Utente</strong>
                    <small id="userRole">Caricamento...</small>
                </div>
                <button class="logout-btn" onclick="logout()">Esci</button>
            </div>
        </div>

        <div class="mesi-section">
            <div class="mesi-header">
                <h2>🗓️ Gestione Mesi</h2>
                <div class="mesi-actions">
                    <button class="btn btn-success" onclick="openMeseModal()">➕ Apri Nuovo Mese</button>
                    <button class="btn btn-danger admin-only" onclick="chiudiMese()">🔒 Chiudi Mese</button>
                </div>
            </div>
            <div class="mesi-aperti" id="mesiAperti"></div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <label>🗓️ Mese:</label>
                <select id="filterMese" onchange="renderAdempimenti()"><option value="">Tutti</option></select>
            </div>

            <div class="filter-group">
                <label>📂 Tipologia:</label>
                <select id="filterTipologia" onchange="renderAdempimenti()">
                    <option value="">Tutte</option>
                    <option value="Contabilità">Contabilità</option>
                    <option value="Tributi">Tributi</option>
                    <option value="Personale">Personale</option>
                    <option value="Altro">Altro</option>
                </select>
            </div>

            <div class="filter-group">
                <label>⚠️ Stato:</label>
                <select id="filterStato" onchange="renderAdempimenti()">
                    <option value="">Tutti</option>
                    <option value="Non Gestito">Non Gestito</option>
                    <option value="In Corso">In Corso</option>
                    <option value="Completato">Completato</option>
                </select>
            </div>

            <button class="btn btn-success" onclick="openAdempimentoModal()">➕ Nuovo Adempimento</button>
            <button class="btn" onclick="loadData()">🔄 Sincronizza</button>
        </div>

        <div class="content">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Caricamento dati...</p>
            </div>
            <div id="alertContainer"></div>
            <div id="adempimentiContainer"></div>
        </div>
    </div>

    <!-- Modal Nuovo Mese -->
    <div id="meseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>🗓️ Apri Nuovo Mese</h2></div>
            <form onsubmit="createMese(event)">
                <div class="form-group">
                    <label>Anno e Mese *</label>
                    <input type="month" id="formAnnoMese" required>
                </div>
                <div class="form-group">
                    <label>Copia adempimenti?</label>
                    <select id="formCopiaTemplate" onchange="toggleComuniSelector()">
                        <option value="no">No</option>
                        <option value="si">Sì, copia precedente</option>
                    </select>
                </div>
                <div id="comuniSelector" class="form-group" style="display:none;">
                    <label>Seleziona Comuni</label>
                    <div class="comuni-selector" id="comuniCheckboxes"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">✅ Crea</button>
                    <button type="button" class="btn" onclick="closeModal('meseModal')">❌ Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Adempimento -->
    <div id="adempimentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>➕ Nuovo Adempimento</h2></div>
            <form onsubmit="createAdempimento(event)">
                <div class="form-group">
                    <label>Mese *</label>
                    <input type="month" id="formMese" required>
                </div>
                <div class="form-group">
                    <label>Titolo *</label>
                    <input type="text" id="formTitolo" required>
                </div>
                <div class="form-group">
                    <label>Descrizione</label>
                    <textarea id="formDescrizione"></textarea>
                </div>
                <div class="form-group">
                    <label>Tipologia *</label>
                    <select id="formTipologia" required>
                        <option value="">Seleziona...</option>
                        <option value="Contabilità">Contabilità</option>
                        <option value="Tributi">Tributi</option>
                        <option value="Personale">Personale</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data Scadenza *</label>
                    <input type="date" id="formDataScadenza" required>
                </div>
                <div class="form-group">
                    <label>Comuni</label>
                    <div class="comuni-selector" id="adempimentoComuniCheckboxes"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">💾 Salva</button>
                    <button type="button" class="btn" onclick="closeModal('adempimentoModal')">❌ Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Note -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>📝 Note per <span id="noteComune"></span></h2></div>
            <form onsubmit="saveNote(event)">
                <input type="hidden" id="noteRecordId">
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="formNote"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">💾 Salva</button>
                    <button type="button" class="btn" onclick="closeModal('noteModal')">❌ Chiudi</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const msalConfig = {
            auth: {
                clientId: '931c14fe-e538-4ae3-a336-0d3a9fd75c49',
                authority: 'https://login.microsoftonline.com/7f07be7a-b1c7-42ca-8f8b-ff793e29b450',
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: true }
        };

        const loginRequest = { scopes: ['User.Read', 'Sites.Read.All', 'Sites.ReadWrite.All'] };
        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const SHAREPOINT_HOSTNAME = 'studiogrismondi.sharepoint.com';
        const SITE_PATH = '/sites/SitodiComunicazione';
        const LISTS = { COMUNI: 'Scadenziario_Comuni', ADEMPIMENTI: 'Scadenziario_Adempimenti', ENTI: 'Scadenziario_Enti' };
        const ADMIN_EMAIL = 'info@studiogrismondisrl.it';

        let currentUser, userRole, accessToken, siteId;
        let allComuni = [], allAdempimenti = [], allEnti = [];
        let meseCorrente = null;

        async function login() {
            try {
                await msalInstance.initialize();
                const resp = await msalInstance.loginPopup(loginRequest);
                currentUser = resp.account;
                await handleAuth();
            } catch (err) {
                alert('Errore login: ' + err.message);
            }
        }

        async function handleAuth() {
            try {
                const account = msalInstance.getAllAccounts()[0];
                if (!account) return;
                currentUser = account;
                const tokenResp = await msalInstance.acquireTokenSilent({ ...loginRequest, account: currentUser });
                accessToken = tokenResp.accessToken;
                userRole = currentUser.username.toLowerCase() === ADMIN_EMAIL.toLowerCase() ? 'Admin' : 'User';
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userName').textContent = currentUser.name || currentUser.username;
                document.getElementById('userRole').textContent = userRole === 'Admin' ? '👑 Amministratore' : '👤 Utente';

                if (userRole === 'Admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-block');
                }

                await loadData();
            } catch (err) {
                if (err.name === 'InteractionRequiredAuthError') await login();
            }
        }

        async function logout() {
            await msalInstance.logoutPopup();
            location.reload();
        }

        async function callGraph(endpoint, method = 'GET', body = null) {
            const url = `https://graph.microsoft.com/v1.0/${endpoint}`;
            const options = {
                method,
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
            };
            if (body && (method === 'POST' || method === 'PATCH')) options.body = JSON.stringify(body);
            const resp = await fetch(url, options);
            if (!resp.ok) throw new Error(`API: ${resp.status}`);
            if (method === 'DELETE' || resp.status === 204) return { success: true };
            return await resp.json();
        }

        async function getSiteId() {
            if (siteId) return siteId;
            const result = await callGraph(`sites/${SHAREPOINT_HOSTNAME}:${SITE_PATH}`);
            siteId = result.id;
            return siteId;
        }

        async function getListItems(listName) {
            const site = await getSiteId();
            const result = await callGraph(`sites/${site}/lists/${listName}/items?expand=fields`);
            return result.value.map(item => ({ ID: item.id, ...item.fields }));
        }

        async function createItem(listName, data) {
            const site = await getSiteId();
            return await callGraph(`sites/${site}/lists/${listName}/items`, 'POST', { fields: data });
        }

        async function updateItem(listName, itemId, data) {
            const site = await getSiteId();
            return await callGraph(`sites/${site}/lists/${listName}/items/${itemId}/fields`, 'PATCH', data);
        }

        async function loadData() {
            try {
                showLoading(true);
                allComuni = (await getListItems(LISTS.COMUNI)).filter(c => c.StatoEnte === 'Attivo');
                allAdempimenti = await getListItems(LISTS.ADEMPIMENTI);
                allEnti = await getListItems(LISTS.ENTI);
                
                populateComuniSelectors();
                renderMesi();
                renderAdempimenti();
                showLoading(false);
                showAlert('✅ Dati caricati!', 'success');
            } catch (err) {
                showAlert('Errore: ' + err.message, 'error');
                showLoading(false);
            }
        }

        function populateComuniSelectors() {
            [document.getElementById('comuniCheckboxes'), document.getElementById('adempimentoComuniCheckboxes')].forEach(container => {
                container.innerHTML = '';
                allComuni.forEach(comune => {
                    const div = document.createElement('div');
                    div.className = 'comune-checkbox';
                    div.innerHTML = `<input type="checkbox" value="${comune.Title}" id="c_${comune.ID}_${container.id}"><label for="c_${comune.ID}_${container.id}">${comune.Title} (${comune.Provincia || ''})</label>`;
                    container.appendChild(div);
                });
            });
        }

        function renderMesi() {
            const container = document.getElementById('mesiAperti');
            const filterSelect = document.getElementById('filterMese');
            
            const mesiAperti = [...new Set(allAdempimenti.filter(a => a.StatoMese === 'Aperto').map(a => a.AnnoMese))].sort().reverse();
            if (mesiAperti.length === 0) mesiAperti.push(getCurrentYearMonth());
            meseCorrente = mesiAperti[0];
            
            container.innerHTML = '';
            filterSelect.innerHTML = '<option value="">Tutti</option>';
            
            mesiAperti.forEach(mese => {
                const count = allAdempimenti.filter(a => a.AnnoMese === mese).length;
                const card = document.createElement('div');
                card.className = 'mese-card';
                if (mese === meseCorrente) card.classList.add('active');
                card.innerHTML = `<div class="mese-nome">${formatMese(mese)}</div><div class="mese-stats">${count} adempimenti</div>`;
                card.onclick = () => { meseCorrente = mese; renderMesi(); renderAdempimenti(); };
                container.appendChild(card);
                
                const option = document.createElement('option');
                option.value = mese;
                option.textContent = formatMese(mese);
                filterSelect.appendChild(option);
            });
        }

        function renderAdempimenti() {
            const container = document.getElementById('adempimentiContainer');
            const filters = {
                mese: document.getElementById('filterMese').value || meseCorrente,
                tipologia: document.getElementById('filterTipologia').value,
                stato: document.getElementById('filterStato').value
            };
            
            let adempimenti = allAdempimenti.filter(a => a.AnnoMese === filters.mese);
            if (filters.tipologia) adempimenti = adempimenti.filter(a => a.Tipologia === filters.tipologia);
            
            if (adempimenti.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📋</div><h3>Nessun adempimento</h3><p>Clicca "Nuovo Adempimento"!</p></div>';
                return;
            }
            
            container.innerHTML = '';
            adempimenti.forEach(adempimento => {
                const card = createAdempimentoCard(adempimento, filters);
                container.appendChild(card);
            });
        }
