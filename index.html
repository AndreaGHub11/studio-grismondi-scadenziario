<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scadenziario Studio Grismondi V13-LITE</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #90ee90 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(79, 172, 254, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            margin-top: 10px;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .controls {
            padding: 25px 40px;
            background: linear-gradient(to right, #f8fbff 0%, #f0fff4 100%);
            border-bottom: 2px solid #e0f2fe;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        select, input[type="month"], input[type="text"], input[type="date"], input[type="number"], textarea {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 11px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.5);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #90ee90 0%, #7bed9f 100%);
            box-shadow: 0 3px 10px rgba(144, 238, 144, 0.3);
        }
        
        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(144, 238, 144, 0.5);
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 13px;
        }
        
        .content {
            padding: 40px;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .comune-card {
            background: white;
            border: 2px solid #e0f2fe;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .comune-card:hover {
            border-color: #4facfe;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.15);
            transform: translateY(-2px);
        }
        
        .comune-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: linear-gradient(to right, #f8fbff 0%, #f0fff4 100%);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        
        .comune-header:hover {
            background: linear-gradient(to right, #e0f2fe 0%, #d4f4dd 100%);
        }
        
        .comune-name {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .comune-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stat-badge {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);
        }
        
        .stat-badge.scaduti {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }
        
        .stat-badge.prossimi {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            box-shadow: 0 2px 8px rgba(254, 202, 87, 0.3);
        }
        
        .expand-icon {
            transition: transform 0.3s;
            font-size: 20px;
        }
        
        .expand-icon.open {
            transform: rotate(180deg);
        }
        
        .adempimenti-list {
            display: none;
            padding: 25px;
            background: #fafbfc;
        }
        
        .adempimenti-list.open {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        th {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        tr:hover {
            background: #f8fbff;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.completato {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.in-corso {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.non-iniziato {
            background: #f8d7da;
            color: #721c24;
        }
        
        .priority-high {
            color: #ff6b6b;
            font-weight: 700;
        }
        
        .priority-medium {
            color: #feca57;
            font-weight: 700;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            transition: transform 0.2s;
        }
        
        .icon-btn:hover {
            transform: scale(1.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.open {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 35px;
            border-radius: 20px;
            max-width: 650px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 70px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0f2fe;
        }
        
        .modal-header h2 {
            color: #4facfe;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .form-row select {
            flex: 1;
        }
        
        .alert {
            padding: 18px 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: #4facfe;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1><span>üìÖ</span>Scadenziario Studio Grismondi</h1>
            <p>V13-LITE - Accesso Diretto (No Login)</p>
        </div>

        <div class="controls">
            <div class="filter-group">
                <label>üìç Comune:</label>
                <select id="filterComune">
                    <option value="">Tutti i comuni</option>
                </select>
            </div>

            <div class="filter-group">
                <label>üìÇ Tipologia:</label>
                <select id="filterTipologia">
                    <option value="">Tutte</option>
                </select>
            </div>

            <div class="filter-group">
                <label>‚ö†Ô∏è Stato:</label>
                <select id="filterStato">
                    <option value="">Tutti</option>
                </select>
            </div>

            <div class="filter-group">
                <label>üìÖ Mese:</label>
                <input type="month" id="filterMese">
            </div>

            <button class="btn btn-success" id="btnAddAdempimento">‚ûï Nuovo Adempimento</button>
            <button class="btn" id="btnSync">üîÑ Sincronizza</button>
        </div>

        <div class="content">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Caricamento dati da SharePoint...</p>
            </div>
            <div id="alertContainer"></div>
            <div id="comuniContainer"></div>
        </div>
    </div>

    <!-- MODAL ADEMPIMENTO -->
    <div id="adempimentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuovo Adempimento</h2>
            </div>
            <form id="adempimentoForm">
                <input type="hidden" id="editId">
                
                <div class="form-group">
                    <label>Comune *</label>
                    <div class="form-row">
                        <select id="formComune" required>
                            <option value="">Seleziona comune...</option>
                        </select>
                        <button type="button" class="btn btn-success btn-small" id="btnOpenEnteModal">
                            ‚ûï Nuovo Comune
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tipologia *</label>
                    <select id="formTipologia" required>
                        <option value="">Seleziona...</option>
                        <option value="Contabilit√†">Contabilit√†</option>
                        <option value="Tributi">Tributi</option>
                        <option value="Personale">Personale</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Descrizione *</label>
                    <textarea id="formDescrizione" required placeholder="Descrivi l'adempimento..."></textarea>
                </div>

                <div class="form-group">
                    <label>Scadenza *</label>
                    <input type="date" id="formScadenza" required>
                </div>

                <div class="form-group">
                    <label>Stato *</label>
                    <select id="formStato" required>
                        <option value="Non Iniziato">Non Iniziato</option>
                        <option value="In Corso">In Corso</option>
                        <option value="Completato">Completato</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Progress (%)</label>
                    <input type="number" id="formProgress" min="0" max="100" value="0">
                </div>

                <div class="form-group">
                    <label>Note</label>
                    <textarea id="formNote" placeholder="Note aggiuntive..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">üíæ Salva</button>
                    <button type="button" class="btn" id="btnCloseModal">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL NUOVO ENTE -->
    <div id="enteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üèõÔ∏è Nuovo Comune</h2>
            </div>
            <form id="enteForm">
                <div class="form-group">
                    <label>Nome Comune *</label>
                    <input type="text" id="formEnteNome" required placeholder="es. Milano, Bergamo, Brescia...">
                </div>

                <div class="form-group">
                    <label>Provincia</label>
                    <input type="text" id="formEnteProvincia" placeholder="es. MI, BG, BS..." maxlength="2" style="text-transform: uppercase;">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">üíæ Crea Comune</button>
                    <button type="button" class="btn" id="btnCloseEnteModal">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('üöÄ Studio Grismondi Scadenziario V13-LITE (No Auth)');

        // ============================================
        // CONFIGURAZIONE SHAREPOINT
        // ============================================
        const SHAREPOINT_SITE = 'https://studiogrismondi.sharepoint.com/sites/SitodiComunicazione';
        const LISTS = {
            ENTI: 'Scadenziario_Enti',
            ADEMPIMENTI: 'Scadenziario_Adempimenti'
        };

        // ============================================
        // VARIABILI GLOBALI
        // ============================================
        let allEnti = [];
        let allAdempimenti = [];
        let tipologieUniche = new Set();
        let statiUnici = new Set();

        // ============================================
        // SHAREPOINT REST API
        // ============================================
        async function callSharePoint(endpoint, method = 'GET', body = null) {
            const url = `${SHAREPOINT_SITE}/_api/${endpoint}`;
            
            const headers = {
                'Accept': 'application/json;odata=verbose',
                'Content-Type': 'application/json;odata=verbose'
            };

            if (method === 'POST' || method === 'PATCH') {
                headers['X-RequestDigest'] = await getFormDigest();
            }

            if (method === 'PATCH') {
                headers['X-HTTP-Method'] = 'MERGE';
                headers['IF-MATCH'] = '*';
            }

            const options = {
                method: method === 'PATCH' ? 'POST' : method,
                headers,
                credentials: 'include'
            };

            if (body && method !== 'GET') {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(url, options);
            
            if (!response.ok) {
                throw new Error(`SharePoint error: ${response.status} ${response.statusText}`);
            }

            if (method === 'DELETE') {
                return { success: true };
            }

            const data = await response.json();
            return data.d;
        }

        async function getFormDigest() {
            const response = await fetch(`${SHAREPOINT_SITE}/_api/contextinfo`, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json;odata=verbose'
                },
                credentials: 'include'
            });
            
            const data = await response.json();
            return data.d.GetContextWebInformation.FormDigestValue;
        }

        async function getListItems(listName) {
            const result = await callSharePoint(`web/lists/getbytitle('${listName}')/items`);
            return result.results || [];
        }

        async function createItem(listName, data) {
            data.__metadata = { type: `SP.Data.${listName}ListItem` };
            return await callSharePoint(`web/lists/getbytitle('${listName}')/items`, 'POST', data);
        }

        async function updateItem(listName, itemId, data) {
            data.__metadata = { type: `SP.Data.${listName}ListItem` };
            return await callSharePoint(`web/lists/getbytitle('${listName}')/items(${itemId})`, 'PATCH', data);
        }

        async function deleteItem(listName, itemId) {
            return await callSharePoint(`web/lists/getbytitle('${listName}')/items(${itemId})`, 'DELETE');
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            try {
                showLoading(true);
                
                allEnti = await getListItems(LISTS.ENTI);
                allEnti = allEnti.filter(e => e.StatoEnte !== 'Disattivo');
                
                allAdempimenti = await getListItems(LISTS.ADEMPIMENTI);
                
                extractUniqueValues();
                populateDropdowns();
                renderComuni();
                
                showLoading(false);
                showAlert('‚úÖ Dati caricati con successo!', 'success');
            } catch (error) {
                console.error('Load error:', error);
                showAlert('‚ùå Errore caricamento: ' + error.message + '\n\nVerifica che le liste SharePoint siano accessibili.', 'error');
                showLoading(false);
            }
        }

        function extractUniqueValues() {
            tipologieUniche.clear();
            statiUnici.clear();
            
            allAdempimenti.forEach(a => {
                if (a.Tipologia) tipologieUniche.add(a.Tipologia);
                if (a.Stato) statiUnici.add(a.Stato);
            });
        }

        function populateDropdowns() {
            const filterComune = document.getElementById('filterComune');
            const formComune = document.getElementById('formComune');
            
            filterComune.innerHTML = '<option value="">Tutti i comuni</option>';
            formComune.innerHTML = '<option value="">Seleziona comune...</option>';
            
            allEnti.forEach(ente => {
                const nome = ente.Comune || ente.Title;
                const provincia = ente.Provincia ? ` (${ente.Provincia})` : '';
                
                const opt1 = document.createElement('option');
                opt1.value = ente.ID || ente.Id;
                opt1.textContent = nome + provincia;
                filterComune.appendChild(opt1);
                
                const opt2 = opt1.cloneNode(true);
                formComune.appendChild(opt2);
            });

            const filterTip = document.getElementById('filterTipologia');
            filterTip.innerHTML = '<option value="">Tutte</option>';
            Array.from(tipologieUniche).sort().forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                filterTip.appendChild(opt);
            });

            const filterStato = document.getElementById('filterStato');
            filterStato.innerHTML = '<option value="">Tutti</option>';
            Array.from(statiUnici).sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                filterStato.appendChild(opt);
            });
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderComuni() {
            const container = document.getElementById('comuniContainer');
            container.innerHTML = '';

            const filters = {
                comune: document.getElementById('filterComune').value,
                tipologia: document.getElementById('filterTipologia').value,
                stato: document.getElementById('filterStato').value,
                mese: document.getElementById('filterMese').value
            };

            let filteredEnti = [...allEnti];
            
            if (filters.comune) {
                filteredEnti = filteredEnti.filter(e => (e.ID || e.Id) == filters.comune);
            }

            if (filteredEnti.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÇ</div>
                        <h3>Nessun ente trovato</h3>
                        <p>Clicca "Nuovo Adempimento" e poi "Nuovo Comune" per iniziare!</p>
                    </div>
                `;
                return;
            }

            filteredEnti.forEach(ente => {
                const adempimenti = getAdempimentiForEnte(ente, filters);
                
                if (adempimenti.length === 0 && filters.comune === '') return;
                
                const card = createComuneCard(ente, adempimenti);
                container.appendChild(card);
            });

            attachEventListeners();
        }

        function getAdempimentiForEnte(ente, filters) {
            const comuneName = ente.Comune || ente.Title;
            let adempimenti = allAdempimenti.filter(a => {
                return a.Title && a.Title.includes(comuneName);
            });

            if (filters.tipologia) {
                adempimenti = adempimenti.filter(a => a.Tipologia === filters.tipologia);
            }
            
            if (filters.stato) {
                adempimenti = adempimenti.filter(a => a.Stato === filters.stato);
            }
            
            if (filters.mese) {
                const [year, month] = filters.mese.split('-');
                adempimenti = adempimenti.filter(a => {
                    if (!a.Scadenza) return false;
                    const scadenzaDate = new Date(a.Scadenza);
                    return scadenzaDate.getFullYear() == year && 
                           (scadenzaDate.getMonth() + 1) == month;
                });
            }

            return adempimenti;
        }

        function createComuneCard(ente, adempimenti) {
            const card = document.createElement('div');
            card.className = 'comune-card';

            const oggi = new Date();
            const scaduti = adempimenti.filter(a => {
                const scadenza = new Date(a.Scadenza);
                return scadenza < oggi && a.Stato !== 'Completato';
            }).length;

            const prossimi = adempimenti.filter(a => {
                const scadenza = new Date(a.Scadenza);
                const diff = (scadenza - oggi) / (1000 * 60 * 60 * 24);
                return diff >= 0 && diff <= 7 && a.Stato !== 'Completato';
            }).length;

            const comuneName = ente.Comune || ente.Title;
            const provincia = ente.Provincia ? ` (${ente.Provincia})` : '';

            card.innerHTML = `
                <div class="comune-header comune-toggle">
                    <div class="comune-name">üèõÔ∏è ${comuneName}${provincia}</div>
                    <div class="comune-stats">
                        <span class="stat-badge">${adempimenti.length} totali</span>
                        ${scaduti > 0 ? `<span class="stat-badge scaduti">${scaduti} scaduti</span>` : ''}
                        ${prossimi > 0 ? `<span class="stat-badge prossimi">${prossimi} prossimi 7gg</span>` : ''}
                        <span class="expand-icon">‚ñº</span>
                    </div>
                </div>
                <div class="adempimenti-list">
                    ${adempimenti.length > 0 ? createAdempimentiTable(adempimenti) : '<p style="text-align:center;padding:20px;color:#999;">Nessun adempimento</p>'}
                </div>
            `;

            return card;
        }

        function createAdempimentiTable(adempimenti) {
            return `
                <table>
                    <thead>
                        <tr>
                            <th>Tipologia</th>
                            <th>Descrizione</th>
                            <th>Scadenza</th>
                            <th>Stato</th>
                            <th>Progress</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${adempimenti.map(a => createAdempimentoRow(a)).join('')}
                    </tbody>
                </table>
            `;
        }

        function createAdempimentoRow(adempimento) {
            const scadenza = new Date(adempimento.Scadenza);
            const oggi = new Date();
            const diff = Math.floor((scadenza - oggi) / (1000 * 60 * 60 * 24));
            
            let scadenzaClass = '';
            if (diff < 0 && adempimento.Stato !== 'Completato') {
                scadenzaClass = 'priority-high';
            } else if (diff >= 0 && diff <= 7) {
                scadenzaClass = 'priority-medium';
            }

            const statoClass = adempimento.Stato === 'Completato' ? 'completato' :
                              adempimento.Stato === 'In Corso' ? 'in-corso' : 'non-iniziato';

            const itemId = adempimento.ID || adempimento.Id;

            return `
                <tr>
                    <td>${adempimento.Tipologia || '-'}</td>
                    <td>${adempimento.Descrizione || '-'}</td>
                    <td class="${scadenzaClass}">${formatDate(adempimento.Scadenza)}</td>
                    <td><span class="status-badge ${statoClass}">${adempimento.Stato || 'Non Iniziato'}</span></td>
                    <td>${adempimento.Progress || 0}%</td>
                    <td>${adempimento.Note || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="icon-btn btn-edit" data-id="${itemId}" title="Modifica">‚úèÔ∏è</button>
                            <button class="icon-btn btn-delete" data-id="${itemId}" title="Elimina">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function attachEventListeners() {
            document.querySelectorAll('.comune-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const list = this.nextElementSibling;
                    const icon = this.querySelector('.expand-icon');
                    list.classList.toggle('open');
                    icon.classList.toggle('open');
                });
            });

            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editAdempimento(parseInt(btn.dataset.id));
                });
            });

            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteAdempimento(parseInt(btn.dataset.id));
                });
            });
        }

        // ============================================
        // CRUD ADEMPIMENTI
        // ============================================
        function openAddAdempimentoModal() {
            document.getElementById('modalTitle').textContent = 'Nuovo Adempimento';
            document.getElementById('adempimentoForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('adempimentoModal').classList.add('open');
        }

        async function editAdempimento(id) {
            const adempimento = allAdempimenti.find(a => (a.ID || a.Id) === id);
            if (!adempimento) return;

            document.getElementById('modalTitle').textContent = 'Modifica Adempimento';
            document.getElementById('editId').value = id;
            
            const comuneName = adempimento.Title.split(' - ')[0];
            const ente = allEnti.find(e => (e.Comune || e.Title) === comuneName);
            
            if (ente) {
                document.getElementById('formComune').value = ente.ID || ente.Id;
            }
            
            document.getElementById('formTipologia').value = adempimento.Tipologia || '';
            document.getElementById('formDescrizione').value = adempimento.Descrizione || '';
            document.getElementById('formScadenza').value = adempimento.Scadenza ? adempimento.Scadenza.split('T')[0] : '';
            document.getElementById('formStato').value = adempimento.Stato || 'Non Iniziato';
            document.getElementById('formProgress').value = adempimento.Progress || 0;
            document.getElementById('formNote').value = adempimento.Note || '';

            document.getElementById('adempimentoModal').classList.add('open');
        }

        async function deleteAdempimento(id) {
            if (!confirm('Sei sicuro di voler eliminare questo adempimento?')) return;

            try {
                showLoading(true);
                await deleteItem(LISTS.ADEMPIMENTI, id);
                showAlert('‚úÖ Adempimento eliminato con successo!', 'success');
                await loadData();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('‚ùå Errore durante l\'eliminazione: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ============================================
        // CRUD ENTI
        // ============================================
        function openAddEnteModal() {
            document.getElementById('enteForm').reset();
            document.getElementById('enteModal').classList.add('open');
        }

        function closeEnteModal() {
            document.getElementById('enteModal').classList.remove('open');
        }

        function closeAdempimentoModal() {
            document.getElementById('adempimentoModal').classList.remove('open');
        }

        // ============================================
        // FORM SUBMISSIONS
        // ============================================
        document.getElementById('adempimentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const editId = document.getElementById('editId').value;
            const comuneId = document.getElementById('formComune').value;
            const ente = allEnti.find(e => (e.ID || e.Id) == comuneId);
            const comuneName = ente ? (ente.Comune || ente.Title) : '';
            
            const data = {
                Title: `${comuneName} - ${document.getElementById('formDescrizione').value}`,
                Tipologia: document.getElementById('formTipologia').value,
                Descrizione: document.getElementById('formDescrizione').value,
                Scadenza: document.getElementById('formScadenza').value,
                Stato: document.getElementById('formStato').value,
                Progress: parseInt(document.getElementById('formProgress').value) || 0,
                Note: document.getElementById('formNote').value
            };

            try {
                showLoading(true);

                if (editId) {
                    await updateItem(LISTS.ADEMPIMENTI, editId, data);
                    showAlert('‚úÖ Adempimento aggiornato con successo!', 'success');
                } else {
                    await createItem(LISTS.ADEMPIMENTI, data);
                    showAlert('‚úÖ Adempimento creato con successo!', 'success');
                }

                closeAdempimentoModal();
                await loadData();

            } catch (error) {
                console.error('Save error:', error);
                showAlert('‚ùå Errore durante il salvataggio: ' + error.message, 'error');
                showLoading(false);
            }
        });

        document.getElementById('enteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nome = document.getElementById('formEnteNome').value;
            const provincia = document.getElementById('formEnteProvincia').value.toUpperCase();
            
            const data = {
                Title: nome,
                Comune: nome,
                Provincia: provincia,
                StatoEnte: 'Attivo'
            };

            try {
                showLoading(true);
                
                await createItem(LISTS.ENTI, data);
                showAlert('‚úÖ Comune creato con successo!', 'success');
                
                closeEnteModal();
                await loadData();

            } catch (error) {
                console.error('Create ente error:', error);
                showAlert('‚ùå Errore durante la creazione del comune: ' + error.message, 'error');
                showLoading(false);
            }
        });

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('comuniContainer').style.display = show ? 'none' : 'block';
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        window.addEventListener('load', async () => {
            console.log('üöÄ Applicazione caricata - V13-LITE');
            
            // Carica dati automaticamente
            await loadData();
        });

        // Button event listeners
        document.getElementById('btnAddAdempimento').addEventListener('click', openAddAdempimentoModal);
        document.getElementById('btnOpenEnteModal').addEventListener('click', openAddEnteModal);
        document.getElementById('btnSync').addEventListener('click', loadData);
        document.getElementById('btnCloseModal').addEventListener('click', closeAdempimentoModal);
        document.getElementById('btnCloseEnteModal').addEventListener('click', closeEnteModal);

        // Filter event listeners
        document.getElementById('filterComune').addEventListener('change', renderComuni);
        document.getElementById('filterTipologia').addEventListener('change', renderComuni);
        document.getElementById('filterStato').addEventListener('change', renderComuni);
        document.getElementById('filterMese').addEventListener('change', renderComuni);

        console.log('‚úÖ Event listeners registrati');
    </script>
</body>
</html>
