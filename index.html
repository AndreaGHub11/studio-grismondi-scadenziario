<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scadenziario Studio Grismondi V23</title>
    
    <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #90ee90 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(79, 172, 254, 0.3);
            text-align: center;
        }
        
        .logo { margin-bottom: 20px; display: flex; justify-content: center; align-items: center; }
        .logo-img { width: 120px; height: 120px; object-fit: contain; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1)); }
        
        .login-container h1 { color: #4facfe; margin-bottom: 10px; font-size: 28px; }
        .login-container p { color: #666; margin-bottom: 35px; font-size: 16px; }
        
        .login-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white; border: none; padding: 18px 50px; border-radius: 10px;
            font-size: 17px; font-weight: 600; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.4); width: 100%;
        }
        .login-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(79, 172, 254, 0.6); }
        
        .app-container {
            display: none; max-width: 1800px; margin: 0 auto; background: white;
            border-radius: 20px; box-shadow: 0 25px 70px rgba(79, 172, 254, 0.3); overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white; padding: 25px 40px; display: flex;
            justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 24px; }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-name { text-align: right; }
        
        .logout-btn {
            background: rgba(255,255,255,0.2); color: white; border: 2px solid white;
            padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;
            transition: all 0.3s; font-size: 14px;
        }
        .logout-btn:hover { background: white; color: #4facfe; }
        
        .controls {
            padding: 20px 40px; background: #f8f9fa; border-bottom: 2px solid #e5e7eb;
            display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white; border: none; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 14px;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.3);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.5); }
        .btn-success { background: linear-gradient(135deg, #90ee90 0%, #7bed9f 100%); box-shadow: 0 3px 10px rgba(144, 238, 144, 0.3); color: #1a1a1a; }
        .btn-success:hover { box-shadow: 0 5px 15px rgba(144, 238, 144, 0.5); }
        .btn-warning { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-fasi { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); box-shadow: 0 3px 10px rgba(155, 89, 182, 0.3); }
        .btn-fasi:hover { box-shadow: 0 5px 15px rgba(155, 89, 182, 0.5); }

        .filtro-rapido { transition: all 0.2s; opacity: 0.7; }
        .filtro-rapido:hover { opacity: 1; }
        .filtro-rapido.active { opacity: 1; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3); transform: scale(1.05); }
        
        select, input { padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; }
        select:focus, input:focus { outline: none; border-color: #4facfe; }
        
        .content { padding: 40px; min-height: 400px; }
        .loading { text-align: center; padding: 60px; color: #666; }
        
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #4facfe;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin: 0 auto 25px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ===================== ADEMPIMENTO CARD ===================== */
        .adempimento-card {
            background: white; border: 2px solid #e5e7eb; border-radius: 12px;
            margin-bottom: 15px; overflow: hidden; transition: all 0.3s;
        }
        .adempimento-card:hover { border-color: #4facfe; box-shadow: 0 5px 20px rgba(79, 172, 254, 0.15); }
        
        .adempimento-header {
            padding: 15px 20px;
            background: linear-gradient(to right, #f8f9ff 0%, #f0fff4 100%);
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; transition: all 0.2s;
        }
        .adempimento-header:hover { background: linear-gradient(to right, #eef0ff 0%, #e0ffe0 100%); }
        
        .adempimento-header.adempimento-completato {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important;
            border: 3px solid #10b981 !important; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }
        .adempimento-completato .adempimento-titolo { color: #065f46; font-weight: 800; }
        
        .adempimento-titolo { font-size: 17px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .adempimento-meta { font-size: 12px; color: #6b7280; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        
        .responsabile-badge { background: #dbeafe; color: #1e40af; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        
        .scadenza-ok { color: #059669; }
        .scadenza-warning { color: #ea580c; font-weight: 700; background: #fed7aa; padding: 4px 10px; border-radius: 6px; border: 2px solid #f97316; }
        .scadenza-danger { color: #dc2626; font-weight: 900; background: #fee2e2; padding: 4px 10px; border-radius: 6px; border: 2px solid #ef4444; animation: pulse-scadenza 2s infinite; }
        @keyframes pulse-scadenza { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.85; transform: scale(1.02); } }
        
        .adempimento-stats { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .adempimento-actions { display: flex; gap: 8px; margin-left: 15px; }
        
        .stat-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .stat-badge.totali { background: #dbeafe; color: #1e40af; }
        .stat-badge.non-gestiti { background: #fee2e2; color: #991b1b; }
        .stat-badge.in-corso { background: #fef3c7; color: #92400e; }
        .stat-badge.completati { background: #d1fae5; color: #065f46; }
        .stat-badge.non-gestiti-grigio { background: #f3f4f6; color: #6b7280; }
        
        /* Badge FASI - viola */
        .badge-fasi {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white; padding: 5px 14px; border-radius: 20px;
            font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(155, 89, 182, 0.35);
            white-space: nowrap; letter-spacing: 0.3px;
        }
        
        .progress-mini {
            width: 150px; height: 8px; background: #e5e7eb; border-radius: 5px;
            overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .progress-mini-fill {
            height: 100%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 50%, #90ee90 100%);
            transition: width 0.5s ease; box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }
        
        .expand-icon { font-size: 16px; transition: transform 0.3s; margin-left: 10px; }
        .expand-icon.open { transform: rotate(180deg); }
        
        /* ===================== COMUNI LIST (adempimento senza fasi) ===================== */
        .comuni-list { display: none; padding: 15px; background: #fafbfc; }
        .comuni-list.open { display: block; }
        
        .comuni-controls {
            display: flex; gap: 10px; margin-bottom: 12px; padding: 10px;
            background: white; border-radius: 8px; flex-wrap: wrap; align-items: center;
        }
        
        .search-box {
            flex: 1; min-width: 200px; padding: 6px 12px;
            border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px;
        }
        .search-box:focus { outline: none; border-color: #4facfe; }
        
        .comuni-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        
        .comune-card {
            background: white; border: 1px solid #e5e7eb; border-radius: 6px;
            padding: 8px 10px; transition: all 0.2s; font-size: 12px;
        }
        .comune-card:hover { border-color: #4facfe; box-shadow: 0 2px 8px rgba(79, 172, 254, 0.1); }
        
        .comune-nome { font-weight: 600; color: #1f2937; margin-bottom: 4px; font-size: 13px; }
        
        .comune-status-display { margin-bottom: 4px; cursor: pointer; }
        
        .status-btn-single {
            width: 100%; background: white; border: 2px solid #e5e7eb;
            border-radius: 8px; padding: 6px 8px; font-size: 11px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; display: flex;
            align-items: center; justify-content: center; gap: 4px;
        }
        .status-btn-single:hover { transform: scale(1.02); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .status-btn-single.status-btn-dafare { border-color: #fecaca; background: #fef2f2; color: #991b1b; }
        .status-btn-single.status-btn-incorso { border-color: #fde68a; background: #fefce8; color: #92400e; }
        .status-btn-single.status-btn-completato { border-color: #86efac; background: #f0fdf4; color: #065f46; }
        .status-btn-single.status-btn-nongestito { border-color: #d1d5db; background: #f9fafb; color: #6b7280; }
        
        .progress-bar-small { height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; margin-bottom: 3px; }
        .progress-bar-small .progress-fill { height: 100%; background: linear-gradient(90deg, #4facfe 0%, #90ee90 100%); transition: width 0.3s; }
        
        .comune-actions-small { display: flex; gap: 2px; justify-content: space-between; margin-top: 4px; }
        .progress-text-small { font-size: 10px; color: #6b7280; font-weight: 600; }
        
        .icon-btn-small { background: none; border: none; cursor: pointer; font-size: 14px; padding: 2px 4px; transition: transform 0.2s; border-radius: 3px; }
        .icon-btn-small:hover { transform: scale(1.2); background: #f3f4f6; }
        
        /* ===================== FASI SYSTEM ===================== */
        .fasi-container { display: none; padding: 15px; background: #fafbfc; }
        .fasi-container.open { display: block; }
        
        .fasi-header-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: linear-gradient(to right, #f3e8ff 0%, #ede9fe 100%);
            border-radius: 8px; margin-bottom: 12px; border: 2px solid #ddd6fe;
        }
        .fasi-header-bar span { font-weight: 700; color: #7c3aed; font-size: 14px; }
        
        .fase-card {
            background: white; border: 2px solid #e5e7eb; border-radius: 10px;
            margin-bottom: 10px; overflow: hidden; transition: all 0.3s;
        }
        .fase-card:hover { border-color: #9b59b6; box-shadow: 0 3px 12px rgba(155, 89, 182, 0.12); }
        
        .fase-header {
            padding: 12px 18px; background: #f8f9fa; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.2s;
        }
        .fase-header:hover { background: #f3e8ff; }
        
        .fase-ordine {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white; width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 13px; flex-shrink: 0; margin-right: 12px;
        }
        
        .fase-info { flex: 1; }
        .fase-title { font-size: 15px; font-weight: 700; color: #2c3e50; margin-bottom: 4px; }
        .fase-meta { display: flex; gap: 15px; font-size: 12px; color: #6b7280; align-items: center; }
        
        .scadenza-fase-ok { color: #059669; font-weight: 600; }
        .scadenza-fase-warning { 
            color: #ea580c; font-weight: 700; background: #fed7aa;
            padding: 2px 8px; border-radius: 5px; border: 1px solid #f97316;
        }
        .scadenza-fase-danger { 
            color: #dc2626; font-weight: 900; background: #fee2e2;
            padding: 2px 8px; border-radius: 5px; border: 1px solid #ef4444;
        }
        
        .fase-progress-bar { width: 120px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
        .fase-progress-fill { height: 100%; background: linear-gradient(90deg, #9b59b6 0%, #8e44ad 100%); transition: width 0.4s; }
        
        .fase-actions { display: flex; gap: 8px; align-items: center; margin-left: 12px; }
        
        .fase-expand-btn {
            background: #9b59b6; color: white; border: none; padding: 6px 14px;
            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;
            transition: all 0.2s; white-space: nowrap;
        }
        .fase-expand-btn:hover { background: #8e44ad; transform: translateY(-1px); }
        
        .fase-comuni-container { display: none; padding: 12px 15px; background: #fefeff; border-top: 1px solid #e5e7eb; }
        .fase-comuni-container.open { display: block; }
        
        /* Icona stato fase */
        .fase-stato-icon { font-size: 18px; margin-right: 8px; }

        /* ===================== ICONE AZIONE ===================== */
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 16px; padding: 4px 6px; transition: transform 0.2s; border-radius: 4px; }
        .icon-btn:hover { transform: scale(1.2); background: #f3f4f6; }
        
        /* ===================== MODAL ===================== */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; }
        .modal.open { display: flex; }
        
        .modal-content {
            background: white; padding: 35px; border-radius: 20px;
            max-width: 750px; width: 90%; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 25px 70px rgba(0,0,0,0.3); margin: 20px;
        }
        .modal-header { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e0f2fe; }
        .modal-header h2 { color: #4facfe; font-size: 24px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-actions { display: flex; gap: 12px; margin-top: 30px; flex-wrap: wrap; }
        
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e5e7eb; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 6px; transition: all 0.2s; }
        .checkbox-item:hover { background: #f0f9ff; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-item label { margin: 0; cursor: pointer; font-weight: 500; }
        
        .select-all-btns { display: flex; gap: 10px; margin-bottom: 10px; }
        
        /* ===================== TOGGLE FASI ===================== */
        .usa-fasi-toggle {
            display: flex; align-items: center; gap: 12px; padding: 15px;
            background: linear-gradient(to right, #f3e8ff 0%, #ede9fe 100%);
            border-radius: 10px; border: 2px solid #ddd6fe; margin-bottom: 5px;
        }
        .usa-fasi-toggle input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: #9b59b6; }
        .usa-fasi-toggle label { font-weight: 700; color: #7c3aed; font-size: 15px; cursor: pointer; margin: 0; }
        .usa-fasi-toggle small { color: #8b5cf6; font-size: 12px; }
        
        /* SEZIONE FASI NEL FORM */
        #fasiInputSection { display: none; }
        #fasiInputSection.open { display: block; }
        
        .fasi-form-container {
            background: #faf5ff; border: 2px solid #e9d5ff; border-radius: 10px; padding: 15px; margin-top: 10px;
        }
        .fasi-form-header { font-weight: 700; color: #7c3aed; margin-bottom: 12px; font-size: 14px; }
        
        .fase-input-row {
            display: grid; grid-template-columns: 30px 1fr 160px auto; gap: 8px;
            align-items: center; background: white; padding: 10px 12px;
            border-radius: 8px; border: 1px solid #e9d5ff; margin-bottom: 8px;
        }
        .fase-num { font-weight: 700; color: #9b59b6; font-size: 14px; text-align: center; }
        .fase-input-row input { padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; width: 100%; }
        .fase-input-row input:focus { outline: none; border-color: #9b59b6; }
        .remove-fase-btn { background: #fee2e2; border: none; color: #dc2626; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 16px; transition: all 0.2s; }
        .remove-fase-btn:hover { background: #fecaca; transform: scale(1.1); }
        
        /* Responsabile fase - toggle badges */
        .fase-resp-row { grid-column: 1 / -1; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 2px; }
        .fase-resp-label { font-size: 11px; font-weight: 600; color: #7c3aed; white-space: nowrap; }
        .fase-resp-toggle {
            display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px;
            border-radius: 15px; border: 2px solid #e5e7eb; background: #f9fafb;
            font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #6b7280;
            user-select: none;
        }
        .fase-resp-toggle:hover { border-color: #9b59b6; background: #faf5ff; }
        .fase-resp-toggle.selected { border-color: #9b59b6; background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 100%); color: #7c3aed; }
        .fase-resp-badge { background: #ede9fe; color: #7c3aed; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; white-space: nowrap; }
        
        #btnAggiungi-fase {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white; border: none; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: 600; font-size: 13px; margin-top: 5px;
            transition: all 0.2s; display: flex; align-items: center; gap: 6px;
        }
        #btnAggiungi-fase:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3); }
        
        /* ===================== MODAL CAMBIO STATO ===================== */
        .btn-stato { width: 100%; padding: 15px; border: 3px solid #e5e7eb; border-radius: 10px; background: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: left; }
        .btn-stato:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-stato.active { border-color: #3b82f6; background: #eff6ff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .btn-stato-dafare:hover { border-color: #ef4444; background: #fef2f2; }
        .btn-stato-incorso:hover { border-color: #f59e0b; background: #fffbeb; }
        .btn-stato-completato:hover { border-color: #10b981; background: #f0fdf4; }
        .btn-stato-nongestito:hover { border-color: #6b7280; background: #f9fafb; }
        
        /* ===================== DASHBOARD ===================== */
        .dashboard-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 12px; margin-bottom: 25px; padding: 20px; background: linear-gradient(to right, #f0f9ff 0%, #f0fdf4 100%); border-radius: 12px; border: 2px solid #e0f2fe; }
        .summary-card { background: white; padding: 18px; border-radius: 10px; display: flex; align-items: center; gap: 12px; border: 2px solid #e5e7eb; transition: all 0.3s; }
        .summary-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .summary-icon { font-size: 28px; }
        .summary-content { flex: 1; }
        .summary-number { font-size: 24px; font-weight: 800; color: #1f2937; line-height: 1; margin-bottom: 4px; }
        .summary-label { font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-scaduti { border-color: #fca5a5; }
        .summary-scaduti .summary-number { color: #dc2626; }
        .summary-urgenti { border-color: #fdba74; }
        .summary-urgenti .summary-number { color: #ea580c; }
        .summary-completati { border-color: #86efac; }
        .summary-completati .summary-number { color: #16a34a; }
        
        /* ===================== LEGENDA ===================== */
        .comuni-legenda { display: flex; justify-content: center; gap: 20px; padding: 12px; background: linear-gradient(to right, #f0f9ff 0%, #f0fdf4 100%); border-radius: 8px; margin-bottom: 15px; border: 2px solid #e0f2fe; flex-wrap: wrap; }
        .legenda-item { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; color: #374151; }
        
        /* ===================== ALERT ===================== */
        .alert { padding: 18px 20px; margin-bottom: 25px; border-radius: 10px; font-weight: 500; font-size: 14px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .empty-state { text-align: center; padding: 80px 20px; color: #9ca3af; }
        .empty-state-icon { font-size: 80px; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { color: #6b7280; margin-bottom: 10px; font-size: 20px; }
        
        /* ===================== PANNELLO ALERT SCADENZE ===================== */
        .alert-scadenze-panel {
            background: linear-gradient(135deg, #fef2f2 0%, #fff7ed 50%, #fefce8 100%);
            border: 2px solid #fca5a5; border-radius: 12px; padding: 15px 20px;
            margin-bottom: 20px;
        }
        .alert-scadenze-title { font-weight: 800; color: #991b1b; font-size: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .alert-scadenze-panel.collapsed .alert-scadenze-body { display: none; }
        .alert-scadenze-panel.collapsed .alert-scadenze-title { margin-bottom: 0; }
        .alert-scadenze-panel.collapsed .alert-scadenze-title span:last-child { transform: rotate(-90deg); }
        .alert-scadenze-item {
            display: flex; align-items: center; gap: 10px; padding: 8px 12px;
            background: white; border-radius: 8px; margin-bottom: 6px; font-size: 13px;
            border-left: 4px solid #ef4444; cursor: pointer; transition: all 0.2s;
        }
        .alert-scadenze-item:hover { transform: translateX(3px); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .alert-scadenze-item.warning { border-left-color: #f97316; }
        .alert-scadenze-item .alert-scad-title { font-weight: 700; color: #1f2937; flex: 1; }
        .alert-scadenze-item .alert-scad-date { font-weight: 700; white-space: nowrap; }
        .alert-scadenze-item .alert-scad-fase { font-size: 11px; color: #7c3aed; font-weight: 600; }
        
        /* Fase card scaduta */
        .fase-card.fase-scaduta { border-color: #ef4444 !important; box-shadow: 0 0 0 1px #fca5a5; }
        .fase-card.fase-scaduta .fase-header { background: #fef2f2 !important; }
        .fase-card.fase-warning { border-color: #f97316 !important; }
        .fase-card.fase-warning .fase-header { background: #fff7ed !important; }
        
        /* Badge fasi scadute su adempimento */
        .badge-fasi-scadute {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white; padding: 4px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 700; animation: pulse-scadenza 2s infinite;
        }
        
        .hidden { display: none !important; }
        
        /* ===================== RESPONSIVE ===================== */
        @media (max-width: 1200px) { .comuni-grid { grid-template-columns: repeat(2, 1fr); } }
        
        @media only screen and (max-width: 768px) {
            body { padding: 10px; }
            .login-container { padding: 30px 20px; margin: 50px auto; }
            .logo-img { width: 90px; height: 90px; }
            .login-container h1 { font-size: 22px; }
            .header { padding: 20px; flex-direction: column; gap: 15px; text-align: center; }
            .header h1 { font-size: 18px; }
            .user-info { flex-direction: column; gap: 10px; }
            .controls { padding: 15px; flex-direction: column; align-items: stretch; }
            .controls > div { width: 100%; }
            .btn { width: 100%; padding: 12px; }
            .dashboard-summary { grid-template-columns: 1fr; padding: 15px; gap: 10px; }
            .content { padding: 15px; }
            .adempimento-header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 12px; }
            .adempimento-stats { flex-wrap: wrap; width: 100%; }
            .progress-mini { width: 100%; }
            .comuni-grid { grid-template-columns: 1fr !important; }
            .fase-input-row { grid-template-columns: 25px 1fr; grid-template-rows: auto auto; }
            .fase-input-row input[type="date"] { grid-column: 1 / -1; }
            .remove-fase-btn { justify-self: end; }
            .checkbox-grid { grid-template-columns: 1fr !important; }
            .modal-content { width: 95%; padding: 20px; margin: 10px; }
            .form-actions { flex-direction: column; }
            .form-actions .btn { width: 100%; }
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="loginContainer" class="login-container">
        <div class="logo">
            <img src="https://raw.githubusercontent.com/AndreaGHub11/studio-grismondi-scadenziario/main/1_Bozza_Logo_ufficiale.png" alt="Studio Grismondi Logo" class="logo-img">
        </div>
        <h1>Studio Grismondi</h1>
        <p>Sistema Scadenziario Integrato</p>
        <button class="login-btn" id="loginBtn">ğŸ” Accedi con Microsoft</button>
    </div>

    <!-- APP -->
    <div id="appContainer" class="app-container">
        <div class="header">
            <div style="display:flex;align-items:center;gap:15px;">
                <img src="https://raw.githubusercontent.com/AndreaGHub11/studio-grismondi-scadenziario/main/1_Bozza_Logo_ufficiale.png" alt="Logo" style="width:45px;height:45px;object-fit:contain;filter:brightness(0) invert(1) drop-shadow(0 2px 4px rgba(0,0,0,0.2));border-radius:8px;">
                <h1>ğŸ“… Scadenziario Studio Grismondi</h1>
            </div>
            <div class="user-info">
                <div class="user-name">
                    <strong id="userName">Utente</strong>
                    <small id="userRole">Caricamento...</small>
                </div>
                <button class="logout-btn" id="btnTestOperatore" style="display:none;background:rgba(255,165,0,0.3);border-color:#ffa500;" title="Testa la vista Operatore">ğŸ”„ Vista Operatore</button>
                <select id="selectTestOperatore" style="display:none;padding:6px 10px;border:2px solid #ffa500;border-radius:8px;font-size:12px;font-weight:700;background:#fff7ed;cursor:pointer;">
                    <option value="">ğŸ‘‘ Admin</option>
                </select>
                <button class="logout-btn" id="logoutBtn">Esci</button>
            </div>
        </div>

        <div class="controls">
            <div style="display:flex;align-items:center;gap:8px;">
                <label style="font-weight:600;">ğŸ“… Mese:</label>
                <select id="filterMese" style="min-width:150px;"><option value="">Tutti i mesi</option></select>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <label style="font-weight:600;">ğŸ“‚ Tipologia:</label>
                <select id="filterTipologia">
                    <option value="">Tutte</option>
                    <option value="ContabilitÃ ">ContabilitÃ </option>
                    <option value="Tributi">Tributi</option>
                    <option value="Personale">Personale</option>
                    <option value="Altro">Altro</option>
                </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <label style="font-weight:600;">ğŸ‘¤ Responsabile:</label>
                <select id="filterResponsabile">
                    <option value="">Tutti</option>
                    <option value="Andrea">Andrea</option>
                    <option value="Roberta">Roberta</option>
                    <option value="Nicoletta">Nicoletta</option>
                    <option value="Miriana">Miriana</option>
                </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <label style="font-weight:600;">âš ï¸ Stato:</label>
                <select id="filterStato">
                    <option value="">Tutti</option>
                    <option value="Non Gestito">Da Fare</option>
                    <option value="In Corso">In Corso</option>
                    <option value="Completato">Completato</option>
                </select>
            </div>
            <button class="btn btn-success" id="btnAddAdempimento">â• Nuovo Adempimento</button>
            <button class="btn btn-warning" id="btnAddComune">ğŸ›ï¸ Nuovo Comune</button>
            <button class="btn" id="btnSync">ğŸ”„ Sincronizza</button>
            <div style="margin-left:auto;display:flex;gap:8px;">
                <button class="btn btn-sm filtro-rapido active" onclick="filtroRapido('tutti')" id="filtro-tutti">ğŸ“‹ Tutti</button>
                <button class="btn btn-sm btn-danger filtro-rapido" onclick="filtroRapido('scaduti')" id="filtro-scaduti">âš ï¸ Scaduti</button>
                <button class="btn btn-sm btn-warning filtro-rapido" onclick="filtroRapido('urgenti')" id="filtro-urgenti">ğŸ”¥ Urgenti</button>
                <button class="btn btn-sm btn-success filtro-rapido" onclick="filtroRapido('completati')" id="filtro-completati">âœ… Completati</button>
            </div>
        </div>

        <div class="content">
            <!-- Dashboard - solo Admin -->
            <div class="dashboard-summary" id="dashboardSummary" style="display:none;">
                <div class="summary-card">
                    <div class="summary-icon">ğŸ“‹</div>
                    <div class="summary-content">
                        <div class="summary-number" id="summary-totali">0</div>
                        <div class="summary-label">Adempimenti Attivi</div>
                    </div>
                </div>
                <div class="summary-card summary-scaduti">
                    <div class="summary-icon">âš ï¸</div>
                    <div class="summary-content">
                        <div class="summary-number" id="summary-scaduti">0</div>
                        <div class="summary-label">Scaduti</div>
                    </div>
                </div>
                <div class="summary-card summary-urgenti">
                    <div class="summary-icon">ğŸ”¥</div>
                    <div class="summary-content">
                        <div class="summary-number" id="summary-urgenti">0</div>
                        <div class="summary-label">Prossimi 7gg</div>
                    </div>
                </div>
                <div class="summary-card summary-completati">
                    <div class="summary-icon">âœ…</div>
                    <div class="summary-content">
                        <div class="summary-number" id="summary-completati">0</div>
                        <div class="summary-label">Completati</div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon">ğŸ“Š</div>
                    <div class="summary-content">
                        <div class="summary-number" id="summary-progress">0%</div>
                        <div class="summary-label">Completamento</div>
                    </div>
                </div>
            </div>

            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Caricamento dati da SharePoint...</p>
            </div>
            <div id="alertContainer"></div>
            <!-- Pannello alert scadenze cross-mese -->
            <div id="alertScadenzePanel" style="display:none;"></div>
            <div id="adempimentiContainer"></div>
        </div>
    </div>

    <!-- ============================================================
         MODAL CAMBIO STATO
         ============================================================ -->
    <div id="cambiaStatoModal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h2>ğŸ“Š Cambia Stato - <span id="statoComune"></span></h2>
            </div>
            <input type="hidden" id="statoRecordId">
            <input type="hidden" id="statoListaSource"> <!-- 'enti' o 'comuniFasi' -->
            <div style="display:flex;flex-direction:column;gap:10px;">
                <button class="btn-stato btn-stato-dafare" onclick="applicaNuovoStato('Da Fare')">ğŸ”´ Da Fare</button>
                <button class="btn-stato btn-stato-incorso" onclick="applicaNuovoStato('In Corso')">ğŸŸ¡ In Corso</button>
                <button class="btn-stato btn-stato-completato" onclick="applicaNuovoStato('Completato')">ğŸŸ¢ Completato</button>
                <button class="btn-stato btn-stato-nongestito" onclick="applicaNuovoStato('Non Gestito')">âš« Non Gestito</button>
            </div>
            <div style="margin-top:20px;">
                <button class="btn" id="btnCloseCambiaStatoModal">âŒ Annulla</button>
            </div>
        </div>
    </div>

    <!-- ============================================================
         MODAL ADEMPIMENTO (crea / modifica) - CON FASI
         ============================================================ -->
    <div id="adempimentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="adempimentoModalTitle">â• Nuovo Adempimento</h2>
            </div>
            <form id="adempimentoForm">
                <input type="hidden" id="editAdempimentoId">

                <div class="form-group">
                    <label>Titolo *</label>
                    <input type="text" id="formTitolo" required placeholder="es. Versamento IMU">
                </div>
                <div class="form-group">
                    <label>Descrizione / Istruzioni operative</label>
                    <textarea id="formDescrizione" rows="3" placeholder="Istruzioni dettagliate..."></textarea>
                </div>
                <div class="form-group">
                    <label>ğŸ“ Link Allegato / Guida (opzionale)</label>
                    <input type="text" id="formAllegato" placeholder="Incolla qui il link al documento..." style="font-size:13px;">
                    <small style="color:#6b7280;font-size:11px;">Copia il link di condivisione da OneDrive, SharePoint o Google Drive e incollalo qui</small>
                </div>
                <div class="form-group">
                    <label>Tipologia *</label>
                    <select id="formTipologia" required>
                        <option value="">Seleziona...</option>
                        <option value="ContabilitÃ ">ContabilitÃ </option>
                        <option value="Tributi">Tributi</option>
                        <option value="Personale">Personale</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ğŸ‘¥ Responsabili * (uno o piÃ¹)</label>
                    <div class="select-all-btns">
                        <button type="button" class="btn btn-sm" onclick="selectAllResponsabili()">âœ… Tutti</button>
                        <button type="button" class="btn btn-sm" onclick="deselectAllResponsabili()">âŒ Nessuno</button>
                    </div>
                    <div class="checkbox-grid" id="responsabiliCheckboxes" style="max-height:200px;">
                        <div class="checkbox-item"><input type="checkbox" name="responsabili" id="resp_andrea" value="Andrea"><label for="resp_andrea">ğŸ‘¤ Andrea</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="responsabili" id="resp_roberta" value="Roberta"><label for="resp_roberta">ğŸ‘¤ Roberta</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="responsabili" id="resp_nicoletta" value="Nicoletta"><label for="resp_nicoletta">ğŸ‘¤ Nicoletta</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="responsabili" id="resp_miriana" value="Miriana"><label for="resp_miriana">ğŸ‘¤ Miriana</label></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Mese di Riferimento *</label>
                    <input type="month" id="formAnnoMese" required>
                </div>
                <div class="form-group">
                    <label>Data Scadenza Principale *</label>
                    <input type="date" id="formDataScadenza" required>
                </div>

                <!-- ========== TOGGLE USA FASI ========== -->
                <div class="form-group">
                    <div class="usa-fasi-toggle">
                        <input type="checkbox" id="chkUsaFasi" onchange="toggleFasiSection(this.checked)">
                        <div>
                            <label for="chkUsaFasi">ğŸ”· Usa sistema Fasi</label><br>
                            <small>Attiva per suddividere l'adempimento in piÃ¹ fasi con scadenze specifiche</small>
                        </div>
                    </div>

                    <!-- Sezione fasi dinamica -->
                    <div id="fasiInputSection">
                        <div class="fasi-form-container">
                            <div class="fasi-form-header">ğŸ“‹ Fasi dell'adempimento (ognuna con scadenza specifica)</div>
                            
                            <!-- CARICA DA TEMPLATE -->
                            <div id="templateLoadSection" style="display:flex;gap:8px;align-items:center;margin-bottom:12px;padding:10px;background:#e0f2fe;border-radius:8px;border:2px solid #93c5fd;">
                                <span style="font-size:12px;font-weight:700;color:#1e40af;">ğŸ“‚ Template:</span>
                                <select id="templateSelect" style="flex:1;padding:6px 10px;border:2px solid #93c5fd;border-radius:6px;font-size:13px;">
                                    <option value="">â€” Seleziona template â€”</option>
                                </select>
                                <button type="button" class="btn btn-sm" onclick="caricaTemplate(document.getElementById('templateSelect').value)" style="font-size:11px;background:#3b82f6;color:white;" title="Carica template selezionato">ğŸ“¥ Carica</button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="eliminaTemplate()" style="font-size:11px;" title="Elimina template selezionato">ğŸ—‘ï¸</button>
                            </div>

                            <div id="fasiInputList">
                                <!-- Le righe fasi vengono aggiunte dinamicamente -->
                            </div>
                            <button type="button" id="btnAggiungi-fase" onclick="aggiungiFaseInput()">
                                â• Aggiungi Fase
                            </button>

                            <!-- SALVA COME TEMPLATE -->
                            <div style="margin-top:12px;padding:10px;background:#f0fdf4;border-radius:8px;border:2px solid #86efac;">
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <input type="checkbox" id="chkSalvaTemplate" style="width:18px;height:18px;cursor:pointer;accent-color:#16a34a;">
                                    <label for="chkSalvaTemplate" style="font-weight:700;color:#16a34a;font-size:13px;cursor:pointer;margin:0;">ğŸ’¾ Salva queste fasi come Template</label>
                                </div>
                                <div id="templateNameSection" style="display:none;margin-top:8px;">
                                    <input type="text" id="templateName" placeholder="es. Rendiconto di Gestione, Bilancio Previsionale..." style="width:100%;padding:8px 12px;border:2px solid #86efac;border-radius:6px;font-size:13px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ========== END FASI ========== -->

                <div class="form-group">
                    <label>Comuni da Associare *</label>
                    <div class="select-all-btns">
                        <button type="button" class="btn btn-sm" onclick="selectAllComuni()">âœ… Seleziona Tutti</button>
                        <button type="button" class="btn btn-sm" onclick="deselectAllComuni()">âŒ Deseleziona Tutti</button>
                    </div>
                    <div class="checkbox-grid" id="comuniCheckboxes"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">ğŸ’¾ Salva Adempimento</button>
                    <button type="button" class="btn" id="btnCloseAdempimentoModal">âŒ Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================================
         MODAL NUOVO COMUNE
         ============================================================ -->
    <div id="comuneModal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header"><h2>ğŸ›ï¸ Nuovo Comune</h2></div>
            <form id="comuneForm">
                <div class="form-group">
                    <label>Nome Comune *</label>
                    <input type="text" id="formNomeComune" required placeholder="es. Milano, Bergamo...">
                </div>
                <div class="form-group">
                    <label>Provincia</label>
                    <input type="text" id="formProvincia" placeholder="es. MI, BG..." maxlength="2" style="text-transform:uppercase;">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">ğŸ’¾ Crea Comune</button>
                    <button type="button" class="btn" id="btnCloseComuneModal">âŒ Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================================
         MODAL DUPLICA
         ============================================================ -->
    <div id="duplicaModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header"><h2>ğŸ“‹ Duplica Adempimento Mensile</h2></div>
            <div style="background:#dbeafe;border:2px solid #93c5fd;border-radius:8px;padding:15px;margin-bottom:20px;">
                <strong style="color:#1e40af;">Stai per duplicare:</strong>
                <div id="duplicaAdempimentoInfo" style="font-size:14px;color:#1e40af;margin-top:8px;"></div>
            </div>
            <form id="duplicaForm">
                <input type="hidden" id="duplicaAdempimentoId">
                <div class="form-group">
                    <label>ğŸ“ Titolo</label>
                    <input type="text" id="duplicaNuovoTitolo" required>
                </div>
                <div class="form-group">
                    <label>ğŸ“‹ Descrizione</label>
                    <textarea id="duplicaNuovaDescrizione" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>ğŸ“… Nuovo Mese *</label>
                    <input type="month" id="duplicaNuovoMese" required>
                </div>
                <div class="form-group">
                    <label>ğŸ“… Nuova Data Scadenza *</label>
                    <input type="date" id="duplicaNuovaScadenza" required>
                </div>
                <div class="form-group">
                    <label>ğŸ‘¤ Responsabile (opzionale)</label>
                    <select id="duplicaNuovoResponsabile">
                        <option value="">Mantieni originale</option>
                        <option value="Andrea">Andrea</option>
                        <option value="Roberta">Roberta</option>
                        <option value="Nicoletta">Nicoletta</option>
                        <option value="Miriana">Miriana</option>
                    </select>
                </div>
                <div style="background:#fef3c7;border:2px solid #fde68a;border-radius:8px;padding:12px;margin-bottom:20px;font-size:13px;color:#92400e;">
                    <strong>ğŸ“Œ Cosa viene copiato:</strong> Titolo, Descrizione, Tipologia, Comuni assegnati, Fasi (se presenti).<br>
                    <strong>âš ï¸ Tutti i comuni partiranno con stato "Da Fare" (0%)</strong>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">âœ… Duplica</button>
                    <button type="button" class="btn" id="btnCloseDuplicaModal">âŒ Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================================
         MODAL NOTE
         ============================================================ -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ Note - <span id="noteComune"></span></h2>
            </div>
            <form id="noteForm">
                <input type="hidden" id="noteRecordId">
                <input type="hidden" id="noteListaSource"> <!-- 'enti' o 'comuniFasi' -->
                <div class="form-group">
                    <label>âœï¸ Aggiungi nuova nota</label>
                    <textarea id="formNuovaNota" rows="3" placeholder="Scrivi qui la nuova nota..."></textarea>
                </div>
                <div class="form-group" id="noteStoricoSection" style="display:none;">
                    <label>ğŸ“‹ Storico Note</label>
                    <div id="noteStoricoContent" style="max-height:250px;overflow-y:auto;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;padding:12px;font-size:12px;line-height:1.6;white-space:pre-wrap;font-family:'Courier New',monospace;color:#374151;"></div>
                </div>
                <input type="hidden" id="formNote">
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">ğŸ’¾ Salva Nota</button>
                    <button type="button" class="btn" id="btnCloseNoteModal">âŒ Chiudi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Batch action bar (floating) -->
    <div id="batchActionBar" style="display:none;position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#1e3a5f,#2563eb);padding:12px 20px;z-index:1000;box-shadow:0 -4px 20px rgba(0,0,0,0.3);border-radius:16px 16px 0 0;">
        <div style="max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <span id="batchCount" style="color:white;font-weight:700;font-size:14px;">0 selezionati</span>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button onclick="applicaStatoBatch('Da Fare')" style="padding:8px 14px;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;background:#fef2f2;color:#991b1b;">ğŸ”´ Da Fare</button>
                <button onclick="applicaStatoBatch('In Corso')" style="padding:8px 14px;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;background:#fefce8;color:#92400e;">ğŸŸ¡ In Corso</button>
                <button onclick="applicaStatoBatch('Completato')" style="padding:8px 14px;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;background:#f0fdf4;color:#065f46;">ğŸŸ¢ Completato</button>
                <button onclick="applicaStatoBatch('Non Gestito')" style="padding:8px 14px;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;background:#f9fafb;color:#6b7280;">âš« Non Gestito</button>
                <button onclick="deselezionaTutti()" style="padding:8px 14px;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;background:#fee2e2;color:#991b1b;">âœ• Deseleziona</button>
            </div>
        </div>
    </div>

    <!-- ============================================================
         SCRIPT
         ============================================================ -->
    <script>
        console.log('ğŸš€ Scadenziario V23 - Multi-Select + Note Storico + Frecce Fasi');

        // ============================================================
        // CONFIG MSAL & SHAREPOINT
        // ============================================================
        const msalConfig = {
            auth: {
                clientId: '931c14fe-e538-4ae3-a336-0d3a9fd75c49',
                authority: 'https://login.microsoftonline.com/7f07be7a-b1c7-42ca-8f8b-ff793e29b450',
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: true }
        };

        const loginRequest = {
            scopes: ['User.Read', 'Sites.Read.All', 'Sites.ReadWrite.All'],
            prompt: 'login'   // Forza re-autenticazione completa (con MFA se configurato in Azure AD)
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const SHAREPOINT_HOSTNAME = 'studiogrismondi.sharepoint.com';
        const SITE_PATH = '/';

        const LISTS = {
            COMUNI:       'Scadenziario_Comuni',
            ADEMPIMENTI:  'Scadenziario_Adempimenti',
            ENTI:         'Scadenziario_Enti',
            // Sistema Fasi
            FASI:         'Scadenziario_Fasi',
            COMUNI_FASI:  'Scadenziario_Comuni_Fasi',
            // Template Fasi
            TEMPLATES:    'Scadenziario_Templates'
        };

        const ADMIN_EMAIL = 'info@studiogrismondisrl.it';
        const ADMIN_EMAILS = ['info@studiogrismondisrl.it', 'roberta@studiogrismondisrl.it'];  // Admin: Andrea e Roberta

        let currentUser, userRole, accessToken, siteId;
        let allComuni = [], allAdempimenti = [], allEnti = [];
        let allFasi = [], allComuniFasi = [];       // dati fasi
        let allTemplates = [];                       // template fasi salvati
        let fasiInputCounter = 0;                   // contatore righe fasi nel form
        let activeFilterResp = '';                   // filtro responsabile attivo (per fasi)
        let testModeOperatore = false;               // toggle per testare vista operatore
        let testOperatoreName = '';                  // nome operatore simulato

        // Team dello Studio - AGGIUNGI QUI NUOVE PERSONE
        const TEAM_MEMBERS = ['Andrea', 'Roberta', 'Nicoletta', 'Miriana'];

        // ============================================================
        // SESSIONE
        // ============================================================
        function checkSessionExpiry() {
            const lastLogin = localStorage.getItem('lastLogin');
            const now = Date.now();
            const tenDays = 10 * 24 * 60 * 60 * 1000;
            if (lastLogin) {
                const elapsed = now - parseInt(lastLogin);
                if (elapsed > tenDays) {
                    localStorage.removeItem('lastLogin');
                    localStorage.removeItem('msalCache');
                    alert('â° Sessione scaduta dopo 10 giorni. Effettua nuovamente il login con autenticazione.');
                    logout();
                    return false;
                }
                return Math.ceil((tenDays - elapsed) / (24 * 60 * 60 * 1000));
            }
            localStorage.setItem('lastLogin', now.toString());
            return 10;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================================
        // AUTH
        // ============================================================
        async function login() {
            try {
                await msalInstance.initialize();
                const resp = await msalInstance.loginPopup(loginRequest);
                currentUser = resp.account;
                await handleAuth();
            } catch (err) {
                console.error('Login error:', err);
                alert('Errore login: ' + err.message);
            }
        }

        async function handleAuth() {
            try {
                const account = msalInstance.getAllAccounts()[0];
                if (!account) return;
                const daysRemaining = checkSessionExpiry();
                if (daysRemaining === false) return;
                currentUser = account;
                const tokenResp = await msalInstance.acquireTokenSilent({ ...loginRequest, account: currentUser });
                accessToken = tokenResp.accessToken;

                // Determina ruolo: Admin se email nell'elenco admin
                const isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === currentUser.username.toLowerCase());
                userRole = (isAdmin && !testModeOperatore) ? 'Admin' : 'Operatore';

                // Estrai nome per filtri operatore
                const fullName = currentUser.name || currentUser.username;
                if (testModeOperatore && testOperatoreName) {
                    window.currentUserName = testOperatoreName;
                } else {
                    window.currentUserName = fullName.split(' ')[0];
                }

                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userName').textContent = testModeOperatore ? `${fullName} (come ${testOperatoreName})` : fullName;

                const roleText = userRole === 'Admin' ? 'ğŸ‘‘ Amministratore' : 'ğŸ‘¤ Operatore';
                const testBadge = testModeOperatore ? ' <span style="background:#ffa500;color:#000;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;">TEST</span>' : '';
                document.getElementById('userRole').innerHTML = `${roleText}${testBadge}<br><span style="font-size:11px;opacity:0.8;">ğŸ”’ Sessione: ${daysRemaining} giorni</span>`;

                // Mostra select operatore solo per admin
                if (isAdmin) {
                    const select = document.getElementById('selectTestOperatore');
                    select.style.display = 'inline-block';
                    select.innerHTML = '<option value="">ğŸ‘‘ Admin</option>';
                    TEAM_MEMBERS.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = `ğŸ‘¤ ${name} (operatore)`;
                        select.appendChild(opt);
                    });
                    if (testModeOperatore && testOperatoreName) select.value = testOperatoreName;
                    // Nascondi vecchio bottone toggle
                    document.getElementById('btnTestOperatore').style.display = 'none';
                }

                // Nascondi/mostra elementi in base al ruolo
                const isOperatore = userRole === 'Operatore';
                document.getElementById('btnAddAdempimento').style.display = ''; // Operatori possono creare
                document.getElementById('btnAddComune').style.display = isOperatore ? 'none' : '';
                document.getElementById('btnSync').style.display = isOperatore ? 'none' : '';
                document.getElementById('dashboardSummary').style.display = isOperatore ? 'none' : 'grid';
                // Operatori non vedono filtro responsabile (vedono solo i propri)
                const filtroRespContainer = document.getElementById('filterResponsabile')?.closest('div');
                if (filtroRespContainer) filtroRespContainer.style.display = isOperatore ? 'none' : '';

                await loadData();
            } catch (err) {
                if (err.name === 'InteractionRequiredAuthError') await login();
                else showAlert('Errore autenticazione: ' + err.message, 'error');
            }
        }

        async function logout() {
            localStorage.removeItem('lastLogin');
            try { await msalInstance.logoutPopup(); } catch(e) { console.warn('Logout error:', e); }
            // Pulisci cache per forzare nuova autenticazione
            const keys = Object.keys(localStorage);
            keys.forEach(k => { if (k.startsWith('msal.') || k.includes('login.windows')) localStorage.removeItem(k); });
            location.reload();
        }

        // ============================================================
        // GRAPH API
        // ============================================================
        async function callGraph(endpoint, method = 'GET', body = null) {
            try {
                const tokenResponse = await msalInstance.acquireTokenSilent({
                    scopes: ['User.Read', 'Sites.Read.All', 'Sites.ReadWrite.All'],
                    account: currentUser
                });
                accessToken = tokenResponse.accessToken;
            } catch (error) {
                if (error.name === 'InteractionRequiredAuthError') { await logout(); return; }
            }
            const url = `https://graph.microsoft.com/v1.0/${endpoint}`;
            const options = {
                method,
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
            };
            if (body && (method === 'POST' || method === 'PATCH')) options.body = JSON.stringify(body);
            const resp = await fetch(url, options);
            if (resp.status === 401) { alert('âš ï¸ Sessione scaduta.'); await logout(); return; }
            if (!resp.ok) { const err = await resp.text(); throw new Error(`API Error: ${resp.status} - ${err}`); }
            if (method === 'DELETE' || resp.status === 204) return { success: true };
            return await resp.json();
        }

        async function getSiteId() {
            if (siteId) return siteId;
            const result = await callGraph(`sites/${SHAREPOINT_HOSTNAME}:${SITE_PATH}`);
            siteId = result.id;
            return siteId;
        }

        async function getListItems(listName) {
            const site = await getSiteId();
            const result = await callGraph(`sites/${site}/lists/${listName}/items?expand=fields&$top=5000`);
            return result.value.map(item => ({ ID: item.id, ...item.fields }));
        }

        async function createItem(listName, data) {
            const site = await getSiteId();
            return await callGraph(`sites/${site}/lists/${listName}/items`, 'POST', { fields: data });
        }

        async function updateItem(listName, itemId, data) {
            const site = await getSiteId();
            return await callGraph(`sites/${site}/lists/${listName}/items/${itemId}/fields`, 'PATCH', data);
        }

        async function deleteItem(listName, itemId) {
            const site = await getSiteId();
            return await callGraph(`sites/${site}/lists/${listName}/items/${itemId}`, 'DELETE');
        }

        // ============================================================
        // LOAD DATA
        // ============================================================
        async function loadData() {
            try {
                showLoading(true);

                allComuni = (await getListItems(LISTS.COMUNI)).filter(c => c.StatoEnte === 'Attivo');
                allAdempimenti = await getListItems(LISTS.ADEMPIMENTI);

                // Normalizza Responsabile array
                allAdempimenti = allAdempimenti.map(function(a) {
                    if (a.Responsabile) {
                        if (typeof a.Responsabile === 'string' && a.Responsabile.indexOf('; ') !== -1) {
                            a.Responsabile = a.Responsabile.split('; ').filter(r => r.trim());
                        } else if (!Array.isArray(a.Responsabile)) {
                            a.Responsabile = [a.Responsabile];
                        }
                    } else { a.Responsabile = []; }
                    return a;
                });

                allEnti = await getListItems(LISTS.ENTI);

                // Carica dati fasi (con gestione errori se lista non esiste ancora)
                try {
                    allFasi = await getListItems(LISTS.FASI);
                } catch(e) {
                    console.warn('Lista Fasi non trovata - funzionalitÃ  fasi disabilitata:', e.message);
                    allFasi = [];
                }
                try {
                    allComuniFasi = await getListItems(LISTS.COMUNI_FASI);
                } catch(e) {
                    console.warn('Lista ComuniFasi non trovata:', e.message);
                    allComuniFasi = [];
                }
                try {
                    allTemplates = await getListItems(LISTS.TEMPLATES);
                } catch(e) {
                    console.warn('Lista Templates non trovata:', e.message);
                    allTemplates = [];
                }

                populateFilterMesi();
                renderAdempimenti();
                if (userRole === 'Admin') updateDashboardSummary();
                updateAlertScadenze();
                showLoading(false);
                showAlert('âœ… Dati caricati con successo!', 'success');

            } catch (err) {
                console.error('Load error:', err);
                showAlert('âŒ Errore caricamento: ' + err.message, 'error');
                showLoading(false);
            }
        }

        // ============================================================
        // DASHBOARD
        // ============================================================
        function updateDashboardSummary() {
            if (userRole !== 'Admin') return;
            const oggi = new Date(); oggi.setHours(0,0,0,0);
            const totali = allAdempimenti.length;
            const isAdempimentoCompletato = (a) => {
                if (a.HasFasi) {
                    const fasi = allFasi.filter(f => f.AdempimentoID == a.ID);
                    if (fasi.length === 0) return false;
                    return fasi.every(f => {
                        const cf = allComuniFasi.filter(c => c.FaseID == f.ID && c.Attivo !== false);
                        return cf.length > 0 && cf.every(c => c.StatoEnte === 'Completato' || c.StatoEnte === 'Non Gestito');
                    });
                } else {
                    const enti = allEnti.filter(e => e.AdempimentoID == a.ID);
                    return enti.length > 0 && enti.every(e => e.StatoEnte === 'Completato' || e.StatoEnte === 'Non Gestito');
                }
            };
            const scaduti = allAdempimenti.filter(a => {
                if (!a.DataScadenza) return false;
                return new Date(a.DataScadenza) < oggi && !isAdempimentoCompletato(a);
            }).length;
            const urgenti = allAdempimenti.filter(a => {
                if (!a.DataScadenza) return false;
                const diff = Math.floor((new Date(a.DataScadenza) - oggi) / (1000*60*60*24));
                return diff >= 0 && diff <= 7 && !isAdempimentoCompletato(a);
            }).length;
            const completati = allAdempimenti.filter(a => isAdempimentoCompletato(a)).length;

            const allComuniTracked = [...allEnti, ...allComuniFasi.filter(c => c.Attivo !== false)];
            const progressPerc = allComuniTracked.length > 0 ?
                Math.round((allComuniTracked.filter(e => e.StatoEnte === 'Completato' || e.StatoEnte === 'Non Gestito').length / allComuniTracked.length) * 100) : 0;

            document.getElementById('summary-totali').textContent = totali;
            document.getElementById('summary-scaduti').textContent = scaduti;
            document.getElementById('summary-urgenti').textContent = urgenti;
            document.getElementById('summary-completati').textContent = completati;
            document.getElementById('summary-progress').textContent = progressPerc + '%';
            document.getElementById('dashboardSummary').style.display = 'grid';
        }

        // ============================================================
        // PANNELLO ALERT SCADENZE CROSS-MESE
        // ============================================================
        function updateAlertScadenze() {
            const panel = document.getElementById('alertScadenzePanel');
            if (!panel) return;
            const oggi = new Date(); oggi.setHours(0,0,0,0);
            const alerts = [];

            // Filtra per operatore se necessario
            let adempimentiDaControllare = [...allAdempimenti];
            if (userRole === 'Operatore' && window.currentUserName) {
                adempimentiDaControllare = adempimentiDaControllare.filter(a => isResponsabileInAdempimento(a, window.currentUserName));
            }

            for (const a of adempimentiDaControllare) {
                const hasFasi = a.HasFasi === true || a.HasFasi === 'true';

                const isCompleto = (() => {
                    if (hasFasi) {
                        const cf = allComuniFasi.filter(c => c.AdempimentoID == a.ID && c.Attivo !== false);
                        return cf.length > 0 && cf.every(c => c.StatoEnte === 'Completato' || c.StatoEnte === 'Non Gestito');
                    }
                    const enti = allEnti.filter(e => e.AdempimentoID == a.ID);
                    return enti.length > 0 && enti.every(e => e.StatoEnte === 'Completato' || e.StatoEnte === 'Non Gestito');
                })();
                if (isCompleto) continue;

                // Adempimento: scaduto o entro 5gg
                if (a.DataScadenza) {
                    const scad = new Date(a.DataScadenza); scad.setHours(0,0,0,0);
                    const diff = Math.floor((scad - oggi) / (1000*60*60*24));
                    if (diff < 0) alerts.push({ tipo: 'scaduto', titolo: a.Title, data: scad, diff, mese: a.AnnoMese, adempId: a.ID, hasFasi });
                    else if (diff <= 5) alerts.push({ tipo: 'urgente', titolo: a.Title, data: scad, diff, mese: a.AnnoMese, adempId: a.ID, hasFasi });
                }

                // Fasi: scadute o entro 5gg
                if (hasFasi) {
                    const fasiAd = userRole === 'Operatore' && window.currentUserName
                        ? getFasiFiltratePerResp(a.ID, window.currentUserName)
                        : allFasi.filter(f => f.AdempimentoID == a.ID);
                    for (const fase of fasiAd) {
                        if (!fase.DataScadenzaFase) continue;
                        const cf = allComuniFasi.filter(c => c.FaseID == fase.ID && c.Attivo !== false);
                        const faseOk = cf.length > 0 && cf.every(c => c.StatoEnte === 'Completato' || c.StatoEnte === 'Non Gestito');
                        if (faseOk) continue;
                        const scadF = new Date(fase.DataScadenzaFase); scadF.setHours(0,0,0,0);
                        const dF = Math.floor((scadF - oggi) / (1000*60*60*24));
                        if (dF < 0) alerts.push({ tipo: 'fase-scaduta', titolo: a.Title, faseNome: fase.Title, data: scadF, diff: dF, mese: a.AnnoMese, adempId: a.ID, hasFasi: true });
                        else if (dF <= 5) alerts.push({ tipo: 'fase-urgente', titolo: a.Title, faseNome: fase.Title, data: scadF, diff: dF, mese: a.AnnoMese, adempId: a.ID, hasFasi: true });
                    }
                }
            }

            if (alerts.length === 0) { panel.style.display = 'none'; return; }

            alerts.sort((a,b) => {
                const ord = { 'scaduto': 0, 'fase-scaduta': 1, 'urgente': 2, 'fase-urgente': 3 };
                if (ord[a.tipo] !== ord[b.tipo]) return ord[a.tipo] - ord[b.tipo];
                return a.diff - b.diff;
            });

            const scadutiN = alerts.filter(a => a.tipo === 'scaduto' || a.tipo === 'fase-scaduta').length;
            const urgentiN = alerts.filter(a => a.tipo === 'urgente' || a.tipo === 'fase-urgente').length;

            panel.style.display = 'block';
            panel.innerHTML = `
                <div class="alert-scadenze-panel collapsed">
                    <div class="alert-scadenze-title" onclick="this.parentElement.classList.toggle('collapsed')" style="cursor:pointer;user-select:none;">
                        ğŸš¨ ${scadutiN > 0 ? `${scadutiN} scaduti` : ''}${scadutiN > 0 && urgentiN > 0 ? ' + ' : ''}${urgentiN > 0 ? `${urgentiN} entro 5gg` : ''}
                        <span style="margin-left:auto;font-size:12px;opacity:0.6;">â–¶ clicca per dettagli</span>
                    </div>
                    <div class="alert-scadenze-body">
                    ${alerts.map(a => {
                        const isScad = a.tipo === 'scaduto' || a.tipo === 'fase-scaduta';
                        const isFase = a.tipo.startsWith('fase-');
                        const dateStr = a.data.toLocaleDateString('it-IT');
                        const diffText = a.diff < 0 ? `${Math.abs(a.diff)}gg fa` : (a.diff === 0 ? 'OGGI!' : `tra ${a.diff}gg`);
                        return `
                        <div class="alert-scadenze-item ${isScad ? '' : 'warning'}" onclick="navigaAdempimento('${a.adempId}', ${a.hasFasi}, '${a.mese}')">
                            <span>${isScad ? 'ğŸ”´' : 'ğŸŸ '}</span>
                            <span class="alert-scad-title">${escapeHtml(a.titolo)}${isFase ? ` <span class="alert-scad-fase">â†’ ${escapeHtml(a.faseNome)}</span>` : ''}</span>
                            <span class="alert-scad-date ${isScad ? 'scadenza-danger' : 'scadenza-warning'}">${dateStr} (${diffText})</span>
                            <span style="font-size:11px;color:#6b7280;">${formatMese(a.mese)}</span>
                        </div>`;
                    }).join('')}
                    </div>
                </div>`;
        }

        // Naviga a un adempimento specifico (cambia mese se necessario)
        window.navigaAdempimento = function(adempId, hasFasi, mese) {
            // Cambia filtro mese se necessario
            const filterMese = document.getElementById('filterMese');
            if (filterMese && mese) filterMese.value = mese;
            renderAdempimenti();
            // Apri la card dopo render
            setTimeout(() => {
                const containerId = hasFasi ? `fasi-container-${adempId}` : `comuni-list-${adempId}`;
                const header = document.querySelector(`.adempimento-toggle[data-id="${adempId}"]`);
                const container = document.getElementById(containerId);
                const icon = header?.querySelector('.expand-icon');
                if (container && header && icon) {
                    container.classList.add('open');
                    icon.classList.add('open');
                    header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 200);
        };

        // ============================================================
        // FILTER MESI
        // ============================================================
        function populateFilterMesi() {
            const select = document.getElementById('filterMese');
            if (!select) return;
            const mesi = new Set();
            allAdempimenti.forEach(a => { if (a.AnnoMese) mesi.add(a.AnnoMese); });
            const sorted = Array.from(mesi).sort().reverse();
            select.innerHTML = '<option value="">Tutti i mesi</option>';
            sorted.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.textContent = formatMese(m);
                select.appendChild(opt);
            });
            const oggi = new Date();
            const meseOggi = `${oggi.getFullYear()}-${String(oggi.getMonth()+1).padStart(2,'0')}`;
            if (sorted.includes(meseOggi)) select.value = meseOggi;
            else if (sorted.length > 0) select.value = sorted[0];
        }

        // ============================================================
        // HELPER: controlla se un responsabile Ã¨ assegnato a un adempimento (considerando le fasi)
        // ============================================================
        function isResponsabileInAdempimento(adempimento, nomeResp) {
            const hasFasi = adempimento.HasFasi === true || adempimento.HasFasi === 'true';
            if (hasFasi) {
                // Per adempimenti con fasi: controlla ResponsabileFase di ogni fase
                const fasi = allFasi.filter(f => f.AdempimentoID == adempimento.ID);
                // Se almeno una fase ha quel responsabile â†’ true
                const inFasi = fasi.some(f => f.ResponsabileFase && f.ResponsabileFase.split('; ').map(r => r.trim()).includes(nomeResp));
                if (inFasi) return true;
                // Fallback: se NESSUNA fase ha responsabili impostati, guarda il padre
                const nessunaFaseHaResp = fasi.every(f => !f.ResponsabileFase || f.ResponsabileFase.trim() === '');
                if (nessunaFaseHaResp) return Array.isArray(adempimento.Responsabile) && adempimento.Responsabile.includes(nomeResp);
                return false;
            } else {
                // Senza fasi: logica originale
                return Array.isArray(adempimento.Responsabile) && adempimento.Responsabile.includes(nomeResp);
            }
        }

        function getFasiFiltratePerResp(adempimentoID, nomeResp) {
            // Ritorna solo le fasi dove il responsabile Ã¨ assegnato
            const fasi = allFasi.filter(f => f.AdempimentoID == adempimentoID);
            if (!nomeResp) return fasi;
            const filtrate = fasi.filter(f => f.ResponsabileFase && f.ResponsabileFase.split('; ').map(r => r.trim()).includes(nomeResp));
            // Se nessuna fase ha responsabili impostati, mostra tutte (fallback)
            if (filtrate.length === 0 && fasi.every(f => !f.ResponsabileFase || f.ResponsabileFase.trim() === '')) return fasi;
            return filtrate;
        }

        // ============================================================
        // RENDER ADEMPIMENTI
        // ============================================================
        function renderAdempimenti() {
            const container = document.getElementById('adempimentiContainer');
            if (!container) return;

            const fM = document.getElementById('filterMese')?.value || '';
            const fT = document.getElementById('filterTipologia')?.value || '';
            const fS = document.getElementById('filterStato')?.value || '';
            const fR = document.getElementById('filterResponsabile')?.value || '';

            // Salva il filtro responsabile globalmente per usarlo in createFasiSection
            activeFilterResp = fR;

            let filtered = [...allAdempimenti];

            // Privacy operatori - considera anche i responsabili delle fasi
            if (userRole === 'Operatore' && window.currentUserName) {
                filtered = filtered.filter(a => isResponsabileInAdempimento(a, window.currentUserName));
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><h3>Nessun adempimento assegnato</h3></div>';
                    return;
                }
            }

            if (fM) filtered = filtered.filter(a => a.AnnoMese === fM);
            if (fT) filtered = filtered.filter(a => a.Tipologia === fT);
            if (fR) filtered = filtered.filter(a => isResponsabileInAdempimento(a, fR));
            if (fS) {
                filtered = filtered.filter(a => {
                    if (a.HasFasi) {
                        const cf = allComuniFasi.filter(c => c.AdempimentoID == a.ID);
                        return cf.some(c => c.StatoEnte === fS);
                    } else {
                        return allEnti.filter(e => e.AdempimentoID == a.ID).some(e => e.StatoEnte === fS);
                    }
                });
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><h3>Nessun adempimento trovato</h3><p>Clicca "Nuovo Adempimento" per iniziare!</p></div>';
                return;
            }

            filtered.sort((a,b) => {
                const dA = a.DataScadenza ? new Date(a.DataScadenza) : new Date('2099-12-31');
                const dB = b.DataScadenza ? new Date(b.DataScadenza) : new Date('2099-12-31');
                return dA - dB;
            });

            container.innerHTML = filtered.map(a => createAdempimentoCard(a)).join('');
            attachEventListeners();
        }

        // ============================================================
        // CARD ADEMPIMENTO - differenzia con/senza fasi
        // ============================================================
        function createAdempimentoCard(adempimento) {
            const hasFasi = adempimento.HasFasi === true || adempimento.HasFasi === 'true';

            // Calcola progresso e stati
            let totali, daFare, inCorso, completati, nonGestiti, progressPercentuale, isCompletato;

            if (hasFasi) {
                // Se c'Ã¨ filtro responsabile, mostra solo le fasi di quel responsabile
                const fasiVisibili = activeFilterResp 
                    ? getFasiFiltratePerResp(adempimento.ID, activeFilterResp)
                    : allFasi.filter(f => f.AdempimentoID == adempimento.ID);
                const fasiVisibiliIDs = fasiVisibili.map(f => String(f.ID));
                const comuniF = allComuniFasi.filter(c => c.AdempimentoID == adempimento.ID && c.Attivo !== false && fasiVisibiliIDs.includes(String(c.FaseID)));
                totali = comuniF.length;
                daFare = comuniF.filter(c => c.StatoEnte === 'Da Fare').length;
                inCorso = comuniF.filter(c => c.StatoEnte === 'In Corso').length;
                completati = comuniF.filter(c => c.StatoEnte === 'Completato').length;
                nonGestiti = comuniF.filter(c => !c.StatoEnte || c.StatoEnte === 'Non Gestito').length;
                progressPercentuale = totali > 0 ? Math.round(((completati + nonGestiti) / totali) * 100) : 0;
                isCompletato = totali > 0 && (completati + nonGestiti) === totali;
            } else {
                const enti = allEnti.filter(e => e.AdempimentoID == adempimento.ID).sort((a,b) => a.Comune.localeCompare(b.Comune));
                totali = enti.length;
                daFare = enti.filter(e => e.StatoEnte === 'Da Fare').length;
                inCorso = enti.filter(e => e.StatoEnte === 'In Corso').length;
                completati = enti.filter(e => e.StatoEnte === 'Completato').length;
                nonGestiti = enti.filter(e => !e.StatoEnte || e.StatoEnte === 'Non Gestito').length;
                progressPercentuale = totali > 0 ? Math.round(((completati + nonGestiti) / totali) * 100) : 0;
                isCompletato = totali > 0 && (completati + nonGestiti) === totali;
            }

            // Scadenza
            const scadenza = adempimento.DataScadenza ? new Date(adempimento.DataScadenza) : null;
            const oggi = new Date(); oggi.setHours(0,0,0,0);
            let scadenzaClass = 'scadenza-ok';
            let scadenzaText = scadenza ? scadenza.toLocaleDateString('it-IT') : '-';
            if (scadenza && !isCompletato) {
                const diff = Math.floor((scadenza - oggi) / (1000*60*60*24));
                if (diff < 0) { scadenzaClass = 'scadenza-danger'; scadenzaText += ' âš ï¸ SCADUTO'; }
                else if (diff <= 7) { scadenzaClass = 'scadenza-warning'; scadenzaText += ` (${diff}gg)`; }
            }

            const responsabiliHtml = adempimento.Responsabile && adempimento.Responsabile.length > 0
                ? adempimento.Responsabile.map(r => `<span class="responsabile-badge">ğŸ‘¤ ${r}</span>`).join(' ')
                : '';

            const fasiCount = hasFasi 
                ? (activeFilterResp ? getFasiFiltratePerResp(adempimento.ID, activeFilterResp).length : allFasi.filter(f => f.AdempimentoID == adempimento.ID).length)
                : 0;
            const fasiBadge = hasFasi ? `<span class="badge-fasi">âš¡ ${fasiCount} FASI</span>` : '';

            // Conta fasi scadute (non completate)
            let fasiScaduteBadge = '';
            if (hasFasi && !isCompletato) {
                const oggiCheck = new Date(); oggiCheck.setHours(0,0,0,0);
                const fasiAdep = allFasi.filter(f => f.AdempimentoID == adempimento.ID);
                const fasiScad = fasiAdep.filter(fase => {
                    if (!fase.DataScadenzaFase) return false;
                    const scadF = new Date(fase.DataScadenzaFase); scadF.setHours(0,0,0,0);
                    if (scadF >= oggiCheck) return false;
                    const cf = allComuniFasi.filter(c => c.FaseID == fase.ID && c.Attivo !== false);
                    return !(cf.length > 0 && cf.every(c => c.StatoEnte === 'Completato' || c.StatoEnte === 'Non Gestito'));
                });
                if (fasiScad.length > 0) fasiScaduteBadge = `<span class="badge-fasi-scadute">âš ï¸ ${fasiScad.length} fasi scadute</span>`;
            }

            const innerContent = hasFasi
                ? createFasiSection(adempimento)
                : createComuniSection(adempimento);

            const innerClass = hasFasi ? 'fasi-container' : 'comuni-list';
            const innerId = hasFasi ? `fasi-container-${adempimento.ID}` : `comuni-list-${adempimento.ID}`;

            return `
            <div class="adempimento-card">
                <div class="adempimento-header adempimento-toggle ${isCompletato ? 'adempimento-completato' : ''}" data-id="${adempimento.ID}" data-has-fasi="${hasFasi}">
                    <div style="flex:1;">
                        <div class="adempimento-titolo">
                            ${isCompletato ? 'âœ… ' : ''}${escapeHtml(adempimento.Title || 'Senza titolo')}${isCompletato ? ' - COMPLETATO' : ''}
                        </div>
                        <div class="adempimento-meta">
                            ğŸ“… ${formatMese(adempimento.AnnoMese)} |
                            ${getIconaTipologia(adempimento.Tipologia)} ${adempimento.Tipologia} |
                            <span class="${scadenzaClass}">â° ${scadenzaText}</span>
                            ${responsabiliHtml ? '| ' + responsabiliHtml : ''}
                        </div>
                    </div>
                    <div class="adempimento-stats">
                        ${fasiBadge}
                        ${fasiScaduteBadge}
                        <span class="stat-badge totali">${totali} totali</span>
                        ${isCompletato ? '<span class="stat-badge" style="background:#10b981;color:white;padding:5px 12px;">âœ… COMPLETATO</span>' : ''}
                        ${daFare > 0 ? `<span class="stat-badge non-gestiti">ğŸ”´ ${daFare}</span>` : ''}
                        ${inCorso > 0 ? `<span class="stat-badge in-corso">ğŸŸ¡ ${inCorso}</span>` : ''}
                        ${completati > 0 ? `<span class="stat-badge completati">ğŸŸ¢ ${completati}</span>` : ''}
                        ${nonGestiti > 0 ? `<span class="stat-badge non-gestiti-grigio">âš« ${nonGestiti}</span>` : ''}
                        <div class="progress-mini" title="${progressPercentuale}%">
                            <div class="progress-mini-fill" style="width:${progressPercentuale}%"></div>
                        </div>
                        <div class="adempimento-actions">
                            <button class="icon-btn" onclick="event.stopPropagation();editAdempimento(${adempimento.ID})" title="Modifica">âœï¸</button>
                            <button class="icon-btn" onclick="event.stopPropagation();openDuplicaModal(${adempimento.ID})" title="Duplica" style="color:#3b82f6;">ğŸ“‹</button>
                            ${userRole !== 'Operatore' ? `<button class="icon-btn" onclick="event.stopPropagation();deleteAdempimento(${adempimento.ID})" title="Elimina" style="color:#ef4444;">ğŸ—‘ï¸</button>` : ''}
                        </div>
                        <span class="expand-icon">â–¼</span>
                    </div>
                </div>

                <div class="${innerClass}" id="${innerId}">
                    ${innerContent}
                </div>
            </div>`;
        }

        // ============================================================
        // SEZIONE COMUNI (adempimento senza fasi) - identica alla V19
        // ============================================================
        function createComuniSection(adempimento) {
            const enti = allEnti.filter(e => e.AdempimentoID == adempimento.ID).sort((a,b) => a.Comune.localeCompare(b.Comune));

            return `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 15px;background:#f0f9ff;border-radius:8px;margin-bottom:10px;">
                <span style="font-size:13px;font-weight:600;color:#1e40af;">ğŸ“ ${escapeHtml(adempimento.Title)}</span>
                <button class="btn btn-sm" onclick="tornaInAlto()" style="background:#3b82f6;">â¬†ï¸ Torna Su</button>
            </div>
            ${adempimento.Descrizione && adempimento.Descrizione.trim() !== '' ? `
            <div style="background:#fffbeb;border:2px solid #fde68a;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;"><span>ğŸ“‹</span><strong style="color:#92400e;">Istruzioni Operative:</strong></div>
                <div style="white-space:pre-wrap;font-family:'Courier New',monospace;font-size:12px;color:#78350f;line-height:1.6;">${escapeHtml(adempimento.Descrizione)}</div>
                ${adempimento.Allegato ? `<div style="margin-top:10px;"><a href="${escapeHtml(adempimento.Allegato)}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:#3b82f6;color:white;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none;">ğŸ“ Apri Guida Allegata â†—</a></div>` : ''}
            </div>` : (adempimento.Allegato ? `
            <div style="background:#eff6ff;border:2px solid #93c5fd;border-radius:8px;padding:12px;margin-bottom:15px;">
                <a href="${escapeHtml(adempimento.Allegato)}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:#3b82f6;color:white;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none;">ğŸ“ Apri Guida Allegata â†—</a>
            </div>` : '')}
            <div class="comuni-controls">
                <input type="text" class="search-box" placeholder="ğŸ” Cerca comune..." oninput="filterComuni(${adempimento.ID}, this.value)">
                <button class="btn btn-sm" onclick="toggleSelectAll(${adempimento.ID},'enti')" style="background:#8b5cf6;color:white;">â˜‘ï¸ Sel. Tutti</button>
                <button class="btn btn-sm" onclick="sortComuni(${adempimento.ID},'nome')">ğŸ”¤ Nome</button>
                <button class="btn btn-sm" onclick="sortComuni(${adempimento.ID},'stato')">ğŸš¦ Stato</button>
                <button class="btn btn-sm" onclick="sortComuni(${adempimento.ID},'progress')">ğŸ“Š Progress</button>
            </div>
            <div class="comuni-grid" id="comuni-grid-${adempimento.ID}">
                ${enti.length > 0 ? enti.map(e => createComuneCard(e, 'enti')).join('') : '<p style="text-align:center;padding:20px;color:#9ca3af;grid-column:1/-1;">Nessun comune assegnato</p>'}
            </div>`;
        }

        // ============================================================
        // SEZIONE FASI (adempimento con fasi) - NUOVO
        // ============================================================
        function createFasiSection(adempimento) {
            // Se c'Ã¨ filtro responsabile attivo, mostra solo le fasi di quel responsabile
            const tutteFasi = allFasi.filter(f => f.AdempimentoID == adempimento.ID).sort((a,b) => (a.OrdineFase||0) - (b.OrdineFase||0));
            const fasi = activeFilterResp 
                ? getFasiFiltratePerResp(adempimento.ID, activeFilterResp).sort((a,b) => (a.OrdineFase||0) - (b.OrdineFase||0))
                : tutteFasi;
            const oggi = new Date(); oggi.setHours(0,0,0,0);

            const headerText = activeFilterResp 
                ? `âš¡ ${escapeHtml(adempimento.Title)} â€” ${fasi.length}/${tutteFasi.length} Fasi (filtro: ${activeFilterResp})`
                : `âš¡ ${escapeHtml(adempimento.Title)} â€” ${fasi.length} Fasi`;

            return `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 15px;background:#f3e8ff;border-radius:8px;margin-bottom:12px;border:2px solid #ddd6fe;">
                <span style="font-size:13px;font-weight:700;color:#7c3aed;">${headerText}</span>
                <button class="btn btn-sm" onclick="tornaInAlto()" style="background:#9b59b6;">â¬†ï¸ Torna Su</button>
            </div>
            ${adempimento.Descrizione && adempimento.Descrizione.trim() ? `
            <div style="background:#fffbeb;border:2px solid #fde68a;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><span>ğŸ“‹</span><strong style="color:#92400e;">Istruzioni:</strong></div>
                <div style="white-space:pre-wrap;font-family:'Courier New',monospace;font-size:12px;color:#78350f;line-height:1.6;">${escapeHtml(adempimento.Descrizione)}</div>
                ${adempimento.Allegato ? `<div style="margin-top:10px;"><a href="${escapeHtml(adempimento.Allegato)}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:#3b82f6;color:white;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none;">ğŸ“ Apri Guida Allegata â†—</a></div>` : ''}
            </div>` : (adempimento.Allegato ? `
            <div style="background:#eff6ff;border:2px solid #93c5fd;border-radius:8px;padding:12px;margin-bottom:15px;">
                <a href="${escapeHtml(adempimento.Allegato)}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:#3b82f6;color:white;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none;">ğŸ“ Apri Guida Allegata â†—</a>
            </div>` : '')}
            ${fasi.length === 0 ? '<p style="text-align:center;padding:30px;color:#9ca3af;">Nessuna fase configurata</p>' :
                fasi.map((fase, idx) => createFaseCard(fase, idx + 1, oggi)).join('')
            }`;
        }

        // ============================================================
        // CARD FASE
        // ============================================================
        function createFaseCard(fase, ordine, oggi) {
            const comuniF = allComuniFasi
                .filter(c => c.FaseID == fase.ID && c.Attivo !== false)
                .sort((a,b) => a.Comune.localeCompare(b.Comune));

            const totali = comuniF.length;
            const completati = comuniF.filter(c => c.StatoEnte === 'Completato').length;
            const nonGestiti = comuniF.filter(c => !c.StatoEnte || c.StatoEnte === 'Non Gestito').length;
            const inCorso = comuniF.filter(c => c.StatoEnte === 'In Corso').length;
            const daFare = comuniF.filter(c => c.StatoEnte === 'Da Fare').length;
            const progressFase = totali > 0 ? Math.round(((completati + nonGestiti) / totali) * 100) : 0;
            const fasCompletata = totali > 0 && (completati + nonGestiti) === totali;

            // Scadenza fase
            let scadenzaFaseClass = 'scadenza-fase-ok';
            let scadenzaFaseText = '-';
            if (fase.DataScadenzaFase) {
                const scadFase = new Date(fase.DataScadenzaFase);
                scadenzaFaseText = scadFase.toLocaleDateString('it-IT');
                const diff = Math.floor((scadFase - oggi) / (1000*60*60*24));
                if (diff < 0 && !fasCompletata) { scadenzaFaseClass = 'scadenza-fase-danger'; scadenzaFaseText += ' âš ï¸'; }
                else if (diff >= 0 && diff <= 7 && !fasCompletata) { scadenzaFaseClass = 'scadenza-fase-warning'; scadenzaFaseText += ` (${diff}gg)`; }
            }

            const statoIcon = fasCompletata ? 'âœ…' : (inCorso > 0 ? 'ğŸŸ¡' : (daFare === totali ? 'âš«' : 'ğŸ”´'));

            // Responsabile fase
            const respFaseHtml = fase.ResponsabileFase 
                ? fase.ResponsabileFase.split('; ').filter(r => r.trim()).map(r => `<span class="fase-resp-badge">ğŸ‘¤ ${r}</span>`).join(' ')
                : '';

            // Classe CSS per fase scaduta/urgente
            let faseCardClass = 'fase-card';
            if (!fasCompletata && fase.DataScadenzaFase) {
                const scadCheck = new Date(fase.DataScadenzaFase); scadCheck.setHours(0,0,0,0);
                const diffCheck = Math.floor((scadCheck - oggi) / (1000*60*60*24));
                if (diffCheck < 0) faseCardClass += ' fase-scaduta';
                else if (diffCheck <= 7) faseCardClass += ' fase-warning';
            }

            return `
            <div class="${faseCardClass}">
                <div class="fase-header" onclick="toggleFaseComuni('fase-comuni-${fase.ID}', this)">
                    <div class="fase-ordine">${ordine}</div>
                    <div class="fase-info">
                        <div class="fase-title"><span>${statoIcon}</span> ${escapeHtml(fase.Title)}</div>
                        <div class="fase-meta">
                            <span class="${scadenzaFaseClass}">ğŸ“… ${scadenzaFaseText}</span>
                            ${respFaseHtml ? respFaseHtml : ''}
                            <span>${totali} comuni</span>
                            <span>${progressFase}%</span>
                            ${daFare > 0 ? `<span style="color:#991b1b;">ğŸ”´ ${daFare}</span>` : ''}
                            ${inCorso > 0 ? `<span style="color:#92400e;">ğŸŸ¡ ${inCorso}</span>` : ''}
                            ${completati > 0 ? `<span style="color:#065f46;">ğŸŸ¢ ${completati}</span>` : ''}
                        </div>
                    </div>
                    <div class="fase-actions">
                        <div class="fase-progress-bar">
                            <div class="fase-progress-fill" style="width:${progressFase}%"></div>
                        </div>
                        <span style="font-size:12px;font-weight:700;color:#9b59b6;min-width:36px;text-align:right;">${progressFase}%</span>
                        <button class="fase-expand-btn" type="button">â–¼ Comuni</button>
                    </div>
                </div>
                <div class="fase-comuni-container" id="fase-comuni-${fase.ID}">
                    <div style="display:flex;gap:6px;padding:6px 8px;align-items:center;">
                        <button class="btn btn-sm" onclick="toggleSelectAll('${fase.ID}','comuniFasi')" style="background:#8b5cf6;color:white;font-size:11px;padding:4px 10px;">â˜‘ï¸ Sel. Tutti</button>
                    </div>
                    <div class="comuni-grid" id="comuniFase-grid-${fase.ID}">
                        ${comuniF.length > 0
                            ? comuniF.map(c => createComuneCard(c, 'comuniFasi')).join('')
                            : '<p style="text-align:center;padding:20px;color:#9ca3af;grid-column:1/-1;">Nessun comune in questa fase</p>'
                        }
                    </div>
                </div>
            </div>`;
        }

        // Apri/chiudi comuni di una fase
        window.toggleFaseComuni = function(containerId, headerEl) {
            const container = document.getElementById(containerId);
            const btn = headerEl.querySelector('.fase-expand-btn');
            if (!container) return;
            const isOpen = container.classList.contains('open');
            container.classList.toggle('open');
            if (btn) btn.textContent = isOpen ? 'â–¼ Comuni' : 'â–² Chiudi';
        };

        // ============================================================
        // CARD COMUNE (condivisa tra enti e comuni_fasi)
        // ============================================================
        function createComuneCard(ente, listaSource) {
            const stato = ente.StatoEnte || 'Da Fare';
            const progress = ente.ProgressEnte || 0;

            let statoIcon = 'ğŸ”´', statoText = 'Da Fare', statoClass = 'status-btn-dafare';
            if (stato === 'In Corso')      { statoIcon = 'ğŸŸ¡'; statoText = 'In Corso';    statoClass = 'status-btn-incorso'; }
            else if (stato === 'Completato') { statoIcon = 'ğŸŸ¢'; statoText = 'Completato'; statoClass = 'status-btn-completato'; }
            else if (stato === 'Non Gestito'){ statoIcon = 'âš«'; statoText = 'Non Gestito';statoClass = 'status-btn-nongestito'; }

            const comuneEscaped = (ente.Comune || '').replace(/`/g, '').replace(/'/g, "\\'");

            return `
            <div class="comune-card" data-comune="${ente.Comune}" data-ente-id="${ente.ID}" data-lista="${listaSource}">
                <div style="display:flex;align-items:center;gap:6px;">
                    <input type="checkbox" class="comune-check" data-id="${ente.ID}" data-lista="${listaSource}" onclick="event.stopPropagation();updateBatchBar(this)" style="width:16px;height:16px;cursor:pointer;">
                    <div class="comune-nome">${ente.Comune}</div>
                </div>
                <div class="comune-status-display" onclick="openCambiaStatoModal(${ente.ID}, '${comuneEscaped}', '${stato}', '${listaSource}')">
                    <button class="status-btn-single ${statoClass}">${statoIcon} ${statoText}</button>
                </div>
                <div class="progress-bar-small">
                    <div class="progress-fill" style="width:${progress}%"></div>
                </div>
                <div class="comune-actions-small">
                    <span class="progress-text-small">${progress}%</span>
                    <button class="icon-btn-small" onclick="event.stopPropagation();openNoteModal(${ente.ID},'${comuneEscaped}','${listaSource}')" title="Note ${ente.NoteEnte && ente.NoteEnte.trim() ? '(presente)' : ''}">
                        ${ente.NoteEnte && ente.NoteEnte.trim() ? 'ğŸ“âœ…' : 'ğŸ“'}
                    </button>
                </div>
            </div>`;
        }

        // ============================================================
        // ATTACH EVENT LISTENERS
        // ============================================================
        function attachEventListeners() {
            document.querySelectorAll('.adempimento-toggle').forEach(el => {
                el.addEventListener('click', function(e) {
                    if (e.target.closest('.adempimento-actions')) return;
                    if (e.target.closest('button')) return;
                    const adempId = this.getAttribute('data-id');
                    const hasFasi = this.getAttribute('data-has-fasi') === 'true';
                    const containerId = hasFasi ? `fasi-container-${adempId}` : `comuni-list-${adempId}`;
                    const container = document.getElementById(containerId);
                    const icon = this.querySelector('.expand-icon');
                    if (container) container.classList.toggle('open');
                    if (icon) icon.classList.toggle('open');
                });
            });
        }

        // ============================================================
        // MULTI-SELECT COMUNI (BATCH)
        // ============================================================
        window.updateBatchBar = function(checkbox) {
            const checked = document.querySelectorAll('.comune-check:checked');
            const bar = document.getElementById('batchActionBar');
            if (checked.length > 0) {
                bar.style.display = 'block';
                document.getElementById('batchCount').textContent = `${checked.length} selezionati`;
            } else {
                bar.style.display = 'none';
            }
        };

        window.toggleSelectAll = function(id, listaSource) {
            // For fasi, the grid ID is comuniFase-grid-{faseId}
            // For enti, the grid ID is comuni-grid-{adempId}
            let grid;
            if (listaSource === 'comuniFasi') {
                grid = document.getElementById(`comuniFase-grid-${id}`);
            } else {
                grid = document.getElementById(`comuni-grid-${id}`);
            }
            if (!grid) return;
            const checks = grid.querySelectorAll('.comune-check');
            const allChecked = Array.from(checks).every(c => c.checked);
            checks.forEach(c => c.checked = !allChecked);
            updateBatchBar();
        };

        window.deselezionaTutti = function() {
            document.querySelectorAll('.comune-check:checked').forEach(c => c.checked = false);
            document.getElementById('batchActionBar').style.display = 'none';
        };

        window.applicaStatoBatch = async function(nuovoStato) {
            const checked = Array.from(document.querySelectorAll('.comune-check:checked'));
            if (checked.length === 0) return;
            if (!confirm(`Cambiare ${checked.length} comuni a "${nuovoStato}"?`)) return;

            let nuovoProgress = 0;
            if (nuovoStato === 'In Corso') nuovoProgress = 50;
            if (nuovoStato === 'Completato') nuovoProgress = 100;

            const scrollY = window.scrollY;
            const openFasi = [];
            document.querySelectorAll('.fase-comuni-container.open').forEach(el => openFasi.push(el.id));
            const openAdemp = [];
            document.querySelectorAll('.comuni-list.open, .fasi-container.open').forEach(el => openAdemp.push(el.id));

            showLoading(true);
            try {
                // Batch parallel update
                const promises = checked.map(cb => {
                    const id = cb.getAttribute('data-id');
                    const lista = cb.getAttribute('data-lista') === 'comuniFasi' ? LISTS.COMUNI_FASI : LISTS.ENTI;
                    return updateItem(lista, id, { StatoEnte: nuovoStato, ProgressEnte: nuovoProgress });
                });
                await Promise.all(promises);

                deselezionaTutti();
                await loadData();

                // Ripristina stato UI
                setTimeout(() => {
                    openAdemp.forEach(cId => {
                        const c = document.getElementById(cId);
                        if (c) {
                            c.classList.add('open');
                            const adempId = cId.replace('comuni-list-','').replace('fasi-container-','');
                            const header = document.querySelector(`.adempimento-toggle[data-id="${adempId}"]`);
                            const icon = header?.querySelector('.expand-icon');
                            if (icon) icon.classList.add('open');
                        }
                    });
                    openFasi.forEach(fId => {
                        const fc = document.getElementById(fId);
                        if (fc) {
                            fc.classList.add('open');
                            const btn = fc.previousElementSibling?.querySelector('.fase-expand-btn');
                            if (btn) btn.textContent = 'â–² Chiudi';
                        }
                    });
                    window.scrollTo(0, scrollY);
                }, 200);

                showAlert(`âœ… ${checked.length} comuni aggiornati a "${nuovoStato}"`, 'success');
            } catch (err) {
                showAlert('âŒ Errore batch: ' + err.message, 'error');
            }
        };

        // ============================================================
        // FILTRI E SORT COMUNI
        // ============================================================
        window.filterComuni = function(adempId, searchText) {
            const cards = document.querySelectorAll(`#comuni-grid-${adempId} .comune-card`);
            cards.forEach(card => {
                card.style.display = card.getAttribute('data-comune').toLowerCase().includes(searchText.toLowerCase()) ? '' : 'none';
            });
        };

        window.sortComuni = function(adempId, sortBy) {
            const container = document.getElementById(`comuni-grid-${adempId}`);
            if (!container) return;
            const cards = Array.from(container.querySelectorAll('.comune-card'));
            cards.sort((a, b) => {
                if (sortBy === 'nome') return a.getAttribute('data-comune').localeCompare(b.getAttribute('data-comune'));
                if (sortBy === 'stato') {
                    const ord = (c) => { const t = c.querySelector('.status-btn-single').textContent; return t.includes('Da Fare') ? 0 : t.includes('In Corso') ? 1 : t.includes('Completato') ? 2 : 3; };
                    return ord(a) - ord(b);
                }
                if (sortBy === 'progress') return parseInt(b.querySelector('.progress-text-small').textContent) - parseInt(a.querySelector('.progress-text-small').textContent);
                return 0;
            });
            cards.forEach(c => container.appendChild(c));
        };

        // ============================================================
        // MODAL CAMBIO STATO (ora gestisce sia enti che comuniFasi)
        // ============================================================
        window.openCambiaStatoModal = function(enteId, comune, statoAttuale, listaSource) {
            document.getElementById('statoRecordId').value = enteId;
            document.getElementById('statoComune').textContent = comune;
            document.getElementById('statoListaSource').value = listaSource || 'enti';
            document.querySelectorAll('.btn-stato').forEach(b => b.classList.remove('active'));
            const map = { 'Da Fare': 'dafare', 'In Corso': 'incorso', 'Completato': 'completato', 'Non Gestito': 'nongestito' };
            const cls = map[statoAttuale];
            if (cls) document.querySelector(`.btn-stato-${cls}`)?.classList.add('active');
            document.getElementById('cambiaStatoModal').classList.add('open');
        };

        window.applicaNuovoStato = async function(nuovoStato) {
            const enteId = document.getElementById('statoRecordId').value;
            const listaSource = document.getElementById('statoListaSource').value;
            const lista = listaSource === 'comuniFasi' ? LISTS.COMUNI_FASI : LISTS.ENTI;
            let nuovoProgress = 0;
            if (nuovoStato === 'In Corso') nuovoProgress = 50;
            if (nuovoStato === 'Completato') nuovoProgress = 100;

            // Salva posizione scroll e stato UI
            const scrollY = window.scrollY;
            const openFasi = [];
            document.querySelectorAll('.fase-comuni-container.open').forEach(el => openFasi.push(el.id));
            const openAdemp = [];
            document.querySelectorAll('.comuni-list.open, .fasi-container.open').forEach(el => openAdemp.push(el.id));

            // Aggiorna subito locale (ottimistico)
            const listaLocale = listaSource === 'comuniFasi' ? allComuniFasi : allEnti;
            const ente = listaLocale.find(e => e.ID == enteId);
            if (ente) { ente.StatoEnte = nuovoStato; ente.ProgressEnte = nuovoProgress; }

            document.getElementById('cambiaStatoModal').classList.remove('open');
            renderAdempimenti();

            // Ripristina stato UI
            openAdemp.forEach(cId => {
                const c = document.getElementById(cId);
                if (c) {
                    c.classList.add('open');
                    const adempId = cId.replace('comuni-list-','').replace('fasi-container-','');
                    const header = document.querySelector(`.adempimento-toggle[data-id="${adempId}"]`);
                    const icon = header?.querySelector('.expand-icon');
                    if (icon) icon.classList.add('open');
                }
            });
            openFasi.forEach(fId => {
                const fc = document.getElementById(fId);
                if (fc) {
                    fc.classList.add('open');
                    const btn = fc.previousElementSibling?.querySelector('.fase-expand-btn');
                    if (btn) btn.textContent = 'â–² Chiudi';
                }
            });
            window.scrollTo(0, scrollY);

            // Salva in background su SharePoint
            try {
                await updateItem(lista, enteId, { StatoEnte: nuovoStato, ProgressEnte: nuovoProgress });
            } catch (err) {
                showAlert('âš ï¸ Errore sync: ' + err.message + ' (ricarica per verificare)', 'error');
            }
        };

        // ============================================================
        // MODAL NOTE (ora gestisce sia enti che comuniFasi)
        // ============================================================
        window.openNoteModal = function(enteId, comune, listaSource) {
            const lista = listaSource === 'comuniFasi' ? allComuniFasi : allEnti;
            const ente = lista.find(e => e.ID == enteId);
            if (!ente) return;
            document.getElementById('noteRecordId').value = enteId;
            document.getElementById('noteListaSource').value = listaSource || 'enti';
            document.getElementById('noteComune').textContent = comune;
            document.getElementById('formNuovaNota').value = '';
            
            // Mostra storico
            const storico = ente.NoteEnte || '';
            document.getElementById('formNote').value = storico;
            if (storico.trim()) {
                document.getElementById('noteStoricoSection').style.display = 'block';
                document.getElementById('noteStoricoContent').textContent = storico;
            } else {
                document.getElementById('noteStoricoSection').style.display = 'none';
            }
            document.getElementById('noteModal').classList.add('open');
        };

        document.getElementById('noteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const enteId = document.getElementById('noteRecordId').value;
            const listaSource = document.getElementById('noteListaSource').value;
            const lista = listaSource === 'comuniFasi' ? LISTS.COMUNI_FASI : LISTS.ENTI;
            const nuovaNota = document.getElementById('formNuovaNota').value.trim();
            const storicoEsistente = document.getElementById('formNote').value;
            
            if (!nuovaNota) { showAlert('âš ï¸ Scrivi una nota prima di salvare', 'error'); return; }
            
            // Prepara nota con data
            const now = new Date();
            const dataStr = now.toLocaleDateString('it-IT') + ' ' + now.toLocaleTimeString('it-IT', {hour:'2-digit',minute:'2-digit'});
            const userName = window.currentUserName || 'Admin';
            const nuovaEntry = `[${dataStr} - ${userName}] ${nuovaNota}`;
            const noteFinali = storicoEsistente ? nuovaEntry + '\n---\n' + storicoEsistente : nuovaEntry;
            
            try {
                await updateItem(lista, enteId, { NoteEnte: noteFinali });
                showAlert('âœ… Nota salvata!', 'success');
                document.getElementById('noteModal').classList.remove('open');
                
                // Aggiorna locale senza reload completo
                const listaLocale = listaSource === 'comuniFasi' ? allComuniFasi : allEnti;
                const ente = listaLocale.find(e => e.ID == enteId);
                if (ente) ente.NoteEnte = noteFinali;
                renderAdempimenti();
            } catch (err) {
                showAlert('âŒ Errore: ' + err.message, 'error');
            }
        });

        // ============================================================
        // FORM FASI - toggle e aggiunta righe
        // ============================================================
        window.toggleFasiSection = function(checked) {
            const section = document.getElementById('fasiInputSection');
            if (checked) {
                section.classList.add('open');
                if (document.getElementById('fasiInputList').children.length === 0) {
                    // Prima apertura: aggiungi 3 fasi di default
                    aggiungiFaseInput();
                    aggiungiFaseInput();
                    aggiungiFaseInput();
                }
            } else {
                section.classList.remove('open');
            }
        };

        window.aggiungiFaseInput = function() {
            fasiInputCounter++;
            const n = fasiInputCounter;
            const list = document.getElementById('fasiInputList');
            const righe = list.querySelectorAll('.fase-input-row');
            const numFase = righe.length + 1;

            const respToggles = TEAM_MEMBERS.map(name => 
                `<span class="fase-resp-toggle" data-resp="${name}" onclick="this.classList.toggle('selected')">${name}</span>`
            ).join('');

            const row = document.createElement('div');
            row.className = 'fase-input-row';
            row.setAttribute('data-fase-n', n);
            row.innerHTML = `
                <span class="fase-num">${numFase}</span>
                <div style="display:flex;flex-direction:column;gap:2px;">
                    <button type="button" onclick="spostFase(this,-1)" style="background:none;border:1px solid #d1d5db;border-radius:4px;cursor:pointer;padding:1px 5px;font-size:11px;" title="Sposta su">â–²</button>
                    <button type="button" onclick="spostFase(this,1)" style="background:none;border:1px solid #d1d5db;border-radius:4px;cursor:pointer;padding:1px 5px;font-size:11px;" title="Sposta giÃ¹">â–¼</button>
                </div>
                <input type="text" placeholder="Nome fase (es: Raccolta dati)" data-tipo="nome" required>
                <input type="date" data-tipo="scadenza">
                <button type="button" class="remove-fase-btn" onclick="removeFaseInput(this)">âœ•</button>
                <div class="fase-resp-row">
                    <span class="fase-resp-label">ğŸ‘¤ Resp:</span>
                    ${respToggles}
                </div>
            `;
            list.appendChild(row);
            rinumeraFasi();
        };

        window.removeFaseInput = function(btn) {
            const row = btn.closest('.fase-input-row');
            if (row) row.remove();
            rinumeraFasi();
        };

        function rinumeraFasi() {
            document.querySelectorAll('#fasiInputList .fase-input-row .fase-num').forEach((el, i) => {
                el.textContent = i + 1;
            });
        }

        window.spostFase = function(btn, direction) {
            const row = btn.closest('.fase-input-row');
            const list = document.getElementById('fasiInputList');
            if (!row || !list) return;
            if (direction === -1 && row.previousElementSibling) {
                list.insertBefore(row, row.previousElementSibling);
            } else if (direction === 1 && row.nextElementSibling) {
                list.insertBefore(row.nextElementSibling, row);
            }
            rinumeraFasi();
        };

        // ============================================================
        // TEMPLATE FASI
        // ============================================================
        // Toggle nome template
        document.getElementById('chkSalvaTemplate')?.addEventListener('change', function() {
            document.getElementById('templateNameSection').style.display = this.checked ? 'block' : 'none';
        });

        function populateTemplateDropdown() {
            const select = document.getElementById('templateSelect');
            if (!select) return;
            select.innerHTML = '<option value="">â€” Carica da template â€”</option>';
            allTemplates.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.ID;
                opt.textContent = `ğŸ“‹ ${t.Title}`;
                select.appendChild(opt);
            });
        }

        window.caricaTemplate = function(templateId) {
            if (!templateId) return;
            const template = allTemplates.find(t => String(t.ID) === String(templateId));
            if (!template || !template.FasiJSON) return;

            let fasiData;
            try { fasiData = JSON.parse(template.FasiJSON); } catch(e) { showAlert('âŒ Template non valido', 'error'); return; }

            if (!confirm(`Caricare il template "${template.Title}"?\n\nLe fasi attuali nel form verranno sostituite.`)) {
                return;
            }

            // Pulisci fasi attuali e ricarica dal template
            document.getElementById('fasiInputList').innerHTML = '';
            fasiInputCounter = 0;

            fasiData.forEach(fase => {
                fasiInputCounter++;
                const list = document.getElementById('fasiInputList');
                const respToggles = TEAM_MEMBERS.map(name => {
                    const isSelected = fase.responsabile && fase.responsabile.split('; ').map(r => r.trim()).includes(name);
                    return `<span class="fase-resp-toggle${isSelected ? ' selected' : ''}" data-resp="${name}" onclick="this.classList.toggle('selected')">${name}</span>`;
                }).join('');

                const row = document.createElement('div');
                row.className = 'fase-input-row';
                row.setAttribute('data-fase-n', fasiInputCounter);
                row.innerHTML = `
                    <span class="fase-num">${fase.ordine}</span>
                    <div style="display:flex;flex-direction:column;gap:2px;">
                        <button type="button" onclick="spostFase(this,-1)" style="background:none;border:1px solid #d1d5db;border-radius:4px;cursor:pointer;padding:1px 5px;font-size:11px;" title="Sposta su">â–²</button>
                        <button type="button" onclick="spostFase(this,1)" style="background:none;border:1px solid #d1d5db;border-radius:4px;cursor:pointer;padding:1px 5px;font-size:11px;" title="Sposta giÃ¹">â–¼</button>
                    </div>
                    <input type="text" placeholder="Nome fase" data-tipo="nome" value="${escapeHtml(fase.nome)}" required>
                    <input type="date" data-tipo="scadenza">
                    <button type="button" class="remove-fase-btn" onclick="removeFaseInput(this)">âœ•</button>
                    <div class="fase-resp-row">
                        <span class="fase-resp-label">ğŸ‘¤ Resp:</span>
                        ${respToggles}
                    </div>
                `;
                list.appendChild(row);
            });
            rinumeraFasi();
            showAlert(`âœ… Template "${template.Title}" caricato (${fasiData.length} fasi)`, 'success');
            document.getElementById('templateSelect').value = '';
        };

        window.eliminaTemplate = async function() {
            const select = document.getElementById('templateSelect');
            const templateId = select?.value;
            if (!templateId) { 
                showAlert('âš ï¸ Prima seleziona un template dal menu a tendina, poi premi ğŸ—‘ï¸', 'error'); 
                return; 
            }
            const template = allTemplates.find(t => String(t.ID) === String(templateId));
            if (!template) { showAlert('âŒ Template non trovato', 'error'); return; }
            if (!confirm(`Eliminare definitivamente il template "${template.Title}"?\n\nQuesta azione non Ã¨ reversibile.`)) return;
            try {
                showLoading(true);
                await deleteItem(LISTS.TEMPLATES, templateId);
                allTemplates = allTemplates.filter(t => String(t.ID) !== String(templateId));
                populateTemplateDropdown();
                showLoading(false);
                showAlert(`âœ… Template "${template.Title}" eliminato con successo!`, 'success');
            } catch(err) {
                showLoading(false);
                console.error('Errore eliminazione template:', err);
                showAlert('âŒ Errore eliminazione template: ' + err.message, 'error');
            }
        };

        async function salvaTemplate(fasiDalForm) {
            const nome = document.getElementById('templateName')?.value?.trim();
            if (!nome) { showAlert('âŒ Inserisci un nome per il template!', 'error'); return; }
            // Salva solo nome e responsabile (no scadenze, si ricompilano ogni volta)
            const fasiPulite = fasiDalForm.map(f => ({ ordine: f.ordine, nome: f.nome, responsabile: f.responsabile }));
            try {
                await createItem(LISTS.TEMPLATES, {
                    Title: nome,
                    FasiJSON: JSON.stringify(fasiPulite)
                });
                allTemplates.push({ Title: nome, FasiJSON: JSON.stringify(fasiPulite) });
                showAlert(`ğŸ’¾ Template "${nome}" salvato!`, 'success');
            } catch(err) {
                showAlert('âš ï¸ Template non salvato (lista non trovata): ' + err.message, 'error');
            }
        }

        function getFasiDalForm() {
            const rows = document.querySelectorAll('#fasiInputList .fase-input-row');
            const fasi = [];
            rows.forEach((row, idx) => {
                const nome = row.querySelector('[data-tipo="nome"]')?.value?.trim();
                const scadenza = row.querySelector('[data-tipo="scadenza"]')?.value;
                const respSelezionati = Array.from(row.querySelectorAll('.fase-resp-toggle.selected')).map(el => el.getAttribute('data-resp'));
                const existingId = row.getAttribute('data-fase-id') || null; // ID SharePoint se fase esistente
                if (nome) fasi.push({ 
                    ordine: idx + 1, 
                    nome, 
                    scadenza: scadenza || null, 
                    responsabile: respSelezionati.join('; '),
                    existingId: existingId  // null = nuova fase, altrimenti = aggiorna
                });
            });
            return fasi;
        }

        // ============================================================
        // FORM ADEMPIMENTO - SUBMIT (crea/modifica con o senza fasi)
        // ============================================================
        document.getElementById('adempimentoForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const titolo = document.getElementById('formTitolo').value;
            const descrizione = document.getElementById('formDescrizione').value;
            const allegato = document.getElementById('formAllegato').value.trim();
            const tipologia = document.getElementById('formTipologia').value;
            const annoMese = document.getElementById('formAnnoMese').value;
            const dataScadenza = document.getElementById('formDataScadenza').value;
            const editId = document.getElementById('editAdempimentoId').value;
            const usaFasi = document.getElementById('chkUsaFasi').checked;

            const responsabiliSelezionati = Array.from(document.querySelectorAll('input[name="responsabili"]:checked')).map(cb => cb.value);
            if (responsabiliSelezionati.length === 0) { showAlert('âŒ Seleziona almeno un responsabile!', 'error'); return; }

            const comuniSelezionati = Array.from(document.querySelectorAll('input[name="comuni"]:checked')).map(cb => cb.value);
            if (comuniSelezionati.length === 0) { showAlert('âŒ Seleziona almeno un comune!', 'error'); return; }

            let faseDalForm = [];
            if (usaFasi) {
                faseDalForm = getFasiDalForm();
                if (faseDalForm.length === 0) { showAlert('âŒ Aggiungi almeno una fase!', 'error'); return; }
            }

            try {
                showLoading(true);
                const adempimentoData = {
                    Title: titolo, Descrizione: descrizione, Allegato: allegato, Tipologia: tipologia,
                    Responsabile: responsabiliSelezionati.join('; '),
                    AnnoMese: annoMese, DataScadenza: dataScadenza,
                    StatoMese: 'Aperto', HasFasi: usaFasi
                };

                let adempimentoId;

                if (editId) {
                    // MODIFICA
                    await updateItem(LISTS.ADEMPIMENTI, editId, adempimentoData);
                    adempimentoId = editId;

                    if (usaFasi) {
                        // ========== GESTIONE FASI IN MODIFICA ==========
                        const fasiEsistenti = allFasi.filter(f => f.AdempimentoID == editId);
                        const fasiEsistentiIDs = fasiEsistenti.map(f => String(f.ID));
                        const fasiFormIDs = faseDalForm.filter(f => f.existingId).map(f => String(f.existingId));

                        // 1. Elimina fasi rimosse dal form (e relativi comuni)
                        for (const faseOld of fasiEsistenti) {
                            if (!fasiFormIDs.includes(String(faseOld.ID))) {
                                // Elimina tutti i comuni di questa fase
                                const cfDaEliminare = allComuniFasi.filter(c => String(c.FaseID) == String(faseOld.ID));
                                for (const cf of cfDaEliminare) await deleteItem(LISTS.COMUNI_FASI, cf.ID);
                                // Elimina la fase
                                await deleteItem(LISTS.FASI, faseOld.ID);
                            }
                        }

                        // 2. Aggiorna fasi esistenti e crea nuove
                        for (const fase of faseDalForm) {
                            if (fase.existingId) {
                                // FASE ESISTENTE â†’ aggiorna solo metadati (NON tocca gli stati comuni!)
                                await updateItem(LISTS.FASI, fase.existingId, {
                                    Title: fase.nome,
                                    OrdineFase: fase.ordine,
                                    DataScadenzaFase: fase.scadenza,
                                    ResponsabileFase: fase.responsabile || ''
                                });

                                // Gestisci comuni: aggiungi nuovi, rimuovi deselezionati
                                const cfEsistenti = allComuniFasi.filter(c => String(c.FaseID) == String(fase.existingId));
                                const comuniEsistentiFase = cfEsistenti.map(c => c.Comune);

                                // Aggiungi comuni nuovi (selezionati ma non ancora presenti)
                                for (const comune of comuniSelezionati) {
                                    if (!comuniEsistentiFase.includes(comune)) {
                                        await createItem(LISTS.COMUNI_FASI, {
                                            Title: `${titolo} - F${fase.ordine} - ${comune}`,
                                            FaseID: parseInt(fase.existingId),
                                            AdempimentoID: parseInt(adempimentoId),
                                            Comune: comune, StatoEnte: 'Da Fare', ProgressEnte: 0, NoteEnte: '', Attivo: true
                                        });
                                    }
                                }
                                // Rimuovi comuni deselezionati
                                for (const cf of cfEsistenti) {
                                    if (!comuniSelezionati.includes(cf.Comune)) {
                                        await deleteItem(LISTS.COMUNI_FASI, cf.ID);
                                    }
                                }
                            } else {
                                // FASE NUOVA â†’ crea fase + crea tutti i comuni
                                const faseResult = await createItem(LISTS.FASI, {
                                    Title: fase.nome,
                                    AdempimentoID: parseInt(adempimentoId),
                                    OrdineFase: fase.ordine,
                                    DataScadenzaFase: fase.scadenza,
                                    ResponsabileFase: fase.responsabile || ''
                                });
                                const nuovaFaseId = faseResult.id;
                                for (const comune of comuniSelezionati) {
                                    await createItem(LISTS.COMUNI_FASI, {
                                        Title: `${titolo} - F${fase.ordine} - ${comune}`,
                                        FaseID: parseInt(nuovaFaseId),
                                        AdempimentoID: parseInt(adempimentoId),
                                        Comune: comune, StatoEnte: 'Da Fare', ProgressEnte: 0, NoteEnte: '', Attivo: true
                                    });
                                }
                            }
                        }
                    } else {
                        // Adempimento senza fasi: gestisci enti come prima
                        const entiEsistenti = allEnti.filter(e => e.AdempimentoID == editId);
                        const comuniEsistenti = entiEsistenti.map(e => e.Comune);
                        for (const c of comuniEsistenti.filter(c => !comuniSelezionati.includes(c))) {
                            const er = entiEsistenti.find(e => e.Comune === c);
                            if (er) await deleteItem(LISTS.ENTI, er.ID);
                        }
                        for (const c of comuniSelezionati.filter(c => !comuniEsistenti.includes(c))) {
                            await createItem(LISTS.ENTI, { Title: `${titolo} - ${c}`, AdempimentoID: parseInt(adempimentoId), Comune: c, StatoEnte: 'Da Fare', ProgressEnte: 0, NoteEnte: '' });
                        }
                    }
                    showAlert('âœ… Adempimento aggiornato!', 'success');
                } else {
                    // CREA NUOVO
                    const result = await createItem(LISTS.ADEMPIMENTI, adempimentoData);
                    adempimentoId = result.id;

                    if (usaFasi) {
                        // Crea fasi + comuni per ogni fase
                        for (const fase of faseDalForm) {
                            const faseResult = await createItem(LISTS.FASI, {
                                Title: fase.nome,
                                AdempimentoID: parseInt(adempimentoId),
                                OrdineFase: fase.ordine,
                                DataScadenzaFase: fase.scadenza,
                                ResponsabileFase: fase.responsabile || ''
                            });
                            const faseId = faseResult.id;
                            for (const comune of comuniSelezionati) {
                                await createItem(LISTS.COMUNI_FASI, {
                                    Title: `${titolo} - F${fase.ordine} - ${comune}`,
                                    FaseID: parseInt(faseId),
                                    AdempimentoID: parseInt(adempimentoId),
                                    Comune: comune, StatoEnte: 'Da Fare', ProgressEnte: 0, NoteEnte: '', Attivo: true
                                });
                            }
                        }
                    } else {
                        // Adempimento standard: crea enti
                        for (const comune of comuniSelezionati) {
                            await createItem(LISTS.ENTI, { Title: `${titolo} - ${comune}`, AdempimentoID: parseInt(adempimentoId), Comune: comune, StatoEnte: 'Da Fare', ProgressEnte: 0, NoteEnte: '' });
                        }
                    }
                    showAlert('âœ… Adempimento creato!', 'success');
                }

                // Salva come template se richiesto
                if (usaFasi && document.getElementById('chkSalvaTemplate')?.checked) {
                    await salvaTemplate(faseDalForm);
                }

                document.getElementById('adempimentoModal').classList.remove('open');
                await loadData();

            } catch (err) {
                showAlert('âŒ Errore: ' + err.message, 'error');
                showLoading(false);
            }
        });

        // ============================================================
        // APRI MODAL ADEMPIMENTO
        // ============================================================
        window.openAdempimentoModal = function() {
            document.getElementById('adempimentoModalTitle').textContent = 'â• Nuovo Adempimento';
            document.getElementById('adempimentoForm').reset();
            document.getElementById('editAdempimentoId').value = '';
            document.getElementById('chkUsaFasi').checked = false;
            document.getElementById('fasiInputSection').classList.remove('open');
            document.getElementById('fasiInputList').innerHTML = '';
            document.getElementById('chkSalvaTemplate').checked = false;
            document.getElementById('templateNameSection').style.display = 'none';
            fasiInputCounter = 0;
            populateTemplateDropdown();
            document.querySelectorAll('#responsabiliCheckboxes input[type="checkbox"]').forEach(cb => { cb.checked = false; cb.disabled = false; });
            populateComuniCheckboxes();
            document.getElementById('adempimentoModal').classList.add('open');
        };

        window.editAdempimento = async function(adempimentoId) {
            const adempimento = allAdempimenti.find(a => a.ID == adempimentoId);
            if (!adempimento) return;

            document.getElementById('adempimentoModalTitle').textContent = 'âœï¸ Modifica Adempimento';
            document.getElementById('editAdempimentoId').value = adempimentoId;
            document.getElementById('chkSalvaTemplate').checked = false;
            document.getElementById('templateNameSection').style.display = 'none';
            populateTemplateDropdown();
            document.getElementById('formTitolo').value = adempimento.Title || '';
            document.getElementById('formDescrizione').value = adempimento.Descrizione || '';
            document.getElementById('formAllegato').value = adempimento.Allegato || '';
            document.getElementById('formTipologia').value = adempimento.Tipologia || '';
            document.getElementById('formAnnoMese').value = adempimento.AnnoMese || '';
            if (adempimento.DataScadenza) document.getElementById('formDataScadenza').value = new Date(adempimento.DataScadenza).toISOString().split('T')[0];

            document.querySelectorAll('#responsabiliCheckboxes input[type="checkbox"]').forEach(cb => { cb.checked = false; cb.disabled = false; });
            if (Array.isArray(adempimento.Responsabile)) {
                adempimento.Responsabile.forEach(r => {
                    const cb = document.getElementById('resp_' + r.trim().toLowerCase());
                    if (cb) cb.checked = true;
                });
            }

            // Gestione fasi in modifica
            const hasFasi = adempimento.HasFasi === true || adempimento.HasFasi === 'true';
            document.getElementById('chkUsaFasi').checked = hasFasi;
            document.getElementById('fasiInputList').innerHTML = '';
            fasiInputCounter = 0;
            if (hasFasi) {
                document.getElementById('fasiInputSection').classList.add('open');
                const fasi = allFasi.filter(f => f.AdempimentoID == adempimentoId).sort((a,b) => (a.OrdineFase||0) - (b.OrdineFase||0));
                fasi.forEach(fase => {
                    fasiInputCounter++;
                    const list = document.getElementById('fasiInputList');
                    const respToggles = TEAM_MEMBERS.map(name => {
                        const isSelected = fase.ResponsabileFase && fase.ResponsabileFase.split('; ').map(r => r.trim()).includes(name);
                        return `<span class="fase-resp-toggle${isSelected ? ' selected' : ''}" data-resp="${name}" onclick="this.classList.toggle('selected')">${name}</span>`;
                    }).join('');
                    const row = document.createElement('div');
                    row.className = 'fase-input-row';
                    row.setAttribute('data-fase-n', fasiInputCounter);
                    row.setAttribute('data-fase-id', fase.ID); // ID esistente per aggiornamento
                    row.innerHTML = `
                        <span class="fase-num">${fase.OrdineFase}</span>
                        <div style="display:flex;flex-direction:column;gap:2px;">
                            <button type="button" onclick="spostFase(this,-1)" style="background:none;border:1px solid #d1d5db;border-radius:4px;cursor:pointer;padding:1px 5px;font-size:11px;" title="Sposta su">â–²</button>
                            <button type="button" onclick="spostFase(this,1)" style="background:none;border:1px solid #d1d5db;border-radius:4px;cursor:pointer;padding:1px 5px;font-size:11px;" title="Sposta giÃ¹">â–¼</button>
                        </div>
                        <input type="text" placeholder="Nome fase" data-tipo="nome" value="${escapeHtml(fase.Title)}" required>
                        <input type="date" data-tipo="scadenza" value="${fase.DataScadenzaFase ? new Date(fase.DataScadenzaFase).toISOString().split('T')[0] : ''}">
                        <button type="button" class="remove-fase-btn" onclick="removeFaseInput(this)">âœ•</button>
                        <div class="fase-resp-row">
                            <span class="fase-resp-label">ğŸ‘¤ Resp:</span>
                            ${respToggles}
                        </div>
                    `;
                    list.appendChild(row);
                });
            } else {
                document.getElementById('fasiInputSection').classList.remove('open');
            }

            const entiAdempimento = allEnti.filter(e => e.AdempimentoID == adempimentoId);
            const comuniFasiAdempimento = allComuniFasi.filter(c => c.AdempimentoID == adempimentoId);
            // Per adempimenti con fasi, prendi i comuni dalle fasi; altrimenti dagli enti
            const comuniSelEdit = hasFasi 
                ? [...new Set(comuniFasiAdempimento.map(c => c.Comune))]
                : entiAdempimento.map(e => e.Comune);
            populateComuniCheckboxes(comuniSelEdit);
            document.getElementById('adempimentoModal').classList.add('open');
        };

        function populateComuniCheckboxes(selected = []) {
            const container = document.getElementById('comuniCheckboxes');
            container.innerHTML = '';
            allComuni.forEach(comune => {
                const comuneNome = comune.Title || comune.Comune;
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `<input type="checkbox" name="comuni" id="comune_${comune.ID}" value="${comuneNome}" ${selected.includes(comuneNome) ? 'checked' : ''}><label for="comune_${comune.ID}">${comuneNome}</label>`;
                container.appendChild(div);
            });
        }

        window.selectAllComuni = function() { document.querySelectorAll('#comuniCheckboxes input').forEach(cb => cb.checked = true); };
        window.deselectAllComuni = function() { document.querySelectorAll('#comuniCheckboxes input').forEach(cb => cb.checked = false); };
        window.selectAllResponsabili = function() { document.querySelectorAll('#responsabiliCheckboxes input:not(:disabled)').forEach(cb => cb.checked = true); };
        window.deselectAllResponsabili = function() { document.querySelectorAll('#responsabiliCheckboxes input:not(:disabled)').forEach(cb => cb.checked = false); };

        // ============================================================
        // ELIMINA ADEMPIMENTO
        // ============================================================
        window.deleteAdempimento = async function(adempimentoId) {
            const adempimento = allAdempimenti.find(a => a.ID == adempimentoId);
            if (!adempimento) return;
            const hasFasi = adempimento.HasFasi === true || adempimento.HasFasi === 'true';
            const entiN = allEnti.filter(e => e.AdempimentoID == adempimentoId).length;
            const fasiN = allFasi.filter(f => f.AdempimentoID == adempimentoId).length;
            const cfN = allComuniFasi.filter(c => c.AdempimentoID == adempimentoId).length;

            const msg = hasFasi
                ? `âš ï¸ Elimina "${adempimento.Title}"?\n\nVerranno eliminati: ${fasiN} fasi e ${cfN} comuni collegati.\n\nSei sicuro?`
                : `âš ï¸ Elimina "${adempimento.Title}"?\n\nVerranno eliminati ${entiN} comuni collegati.\n\nSei sicuro?`;

            if (!confirm(msg)) return;
            try {
                showLoading(true);
                if (hasFasi) {
                    for (const cf of allComuniFasi.filter(c => c.AdempimentoID == adempimentoId)) await deleteItem(LISTS.COMUNI_FASI, cf.ID);
                    for (const f of allFasi.filter(f => f.AdempimentoID == adempimentoId)) await deleteItem(LISTS.FASI, f.ID);
                } else {
                    for (const e of allEnti.filter(e => e.AdempimentoID == adempimentoId)) await deleteItem(LISTS.ENTI, e.ID);
                }
                await deleteItem(LISTS.ADEMPIMENTI, adempimentoId);
                showAlert('âœ… Adempimento eliminato!', 'success');
                await loadData();
            } catch (err) {
                showAlert('âŒ Errore: ' + err.message, 'error');
                showLoading(false);
            }
        };

        // ============================================================
        // DUPLICA ADEMPIMENTO
        // ============================================================
        window.openDuplicaModal = function(adempimentoId) {
            const adempimento = allAdempimenti.find(a => a.ID == adempimentoId);
            if (!adempimento) return;
            const hasFasi = adempimento.HasFasi === true || adempimento.HasFasi === 'true';
            const entiN = hasFasi ? allComuniFasi.filter(c => c.AdempimentoID == adempimentoId).length : allEnti.filter(e => e.AdempimentoID == adempimentoId).length;
            const fasiN = hasFasi ? allFasi.filter(f => f.AdempimentoID == adempimentoId).length : 0;
            const respText = Array.isArray(adempimento.Responsabile) ? adempimento.Responsabile.join(', ') : (adempimento.Responsabile || 'N/A');

            document.getElementById('duplicaAdempimentoId').value = adempimentoId;
            document.getElementById('duplicaAdempimentoInfo').innerHTML = `
                <strong>"${escapeHtml(adempimento.Title)}"</strong><br>
                <span>${adempimento.Tipologia} | ğŸ‘¤ ${respText} | ${hasFasi ? `âš¡ ${fasiN} fasi - ` : ''}ğŸ›ï¸ ${entiN} comuni</span>`;
            document.getElementById('duplicaNuovoTitolo').value = adempimento.Title || '';
            document.getElementById('duplicaNuovaDescrizione').value = adempimento.Descrizione || '';
            document.getElementById('duplicaNuovoResponsabile').value = '';

            if (adempimento.AnnoMese) {
                const [y,m] = adempimento.AnnoMese.split('-');
                const ms = new Date(parseInt(y), parseInt(m) - 1);
                ms.setMonth(ms.getMonth() + 1);
                const msStr = `${ms.getFullYear()}-${String(ms.getMonth()+1).padStart(2,'0')}`;
                document.getElementById('duplicaNuovoMese').value = msStr;
                if (adempimento.DataScadenza) {
                    const sd = new Date(adempimento.DataScadenza);
                    const ns = new Date(ms.getFullYear(), ms.getMonth(), sd.getDate());
                    document.getElementById('duplicaNuovaScadenza').value = ns.toISOString().split('T')[0];
                }
            }
            document.getElementById('duplicaModal').classList.add('open');
        };

        document.getElementById('duplicaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const adempimentoId = document.getElementById('duplicaAdempimentoId').value;
            const nuovoMese = document.getElementById('duplicaNuovoMese').value;
            const nuovaScadenza = document.getElementById('duplicaNuovaScadenza').value;
            const nuovoResponsabile = document.getElementById('duplicaNuovoResponsabile').value;
            const nuovoTitolo = document.getElementById('duplicaNuovoTitolo').value;
            const nuovaDescrizione = document.getElementById('duplicaNuovaDescrizione').value;

            const adempimentoOrig = allAdempimenti.find(a => a.ID == adempimentoId);
            if (!adempimentoOrig) return;
            const hasFasi = adempimentoOrig.HasFasi === true || adempimentoOrig.HasFasi === 'true';

            let respDuplicato = nuovoResponsabile || (Array.isArray(adempimentoOrig.Responsabile) ? adempimentoOrig.Responsabile.join('; ') : adempimentoOrig.Responsabile);

            if (!confirm(`Duplicare "${adempimentoOrig.Title}" â†’ "${nuovoTitolo}" per ${formatMese(nuovoMese)}?`)) return;

            try {
                showLoading(true);
                const nuovoResult = await createItem(LISTS.ADEMPIMENTI, {
                    Title: nuovoTitolo, Descrizione: nuovaDescrizione,
                    Allegato: adempimentoOrig.Allegato || '',
                    Tipologia: adempimentoOrig.Tipologia, Responsabile: respDuplicato,
                    AnnoMese: nuovoMese, DataScadenza: nuovaScadenza,
                    StatoMese: 'Aperto', HasFasi: hasFasi
                });
                const nuovoAdempimentoId = nuovoResult.id;

                if (hasFasi) {
                    const fasiOrig = allFasi.filter(f => f.AdempimentoID == adempimentoId).sort((a,b) => (a.OrdineFase||0) - (b.OrdineFase||0));
                    for (const fase of fasiOrig) {
                        const nuovaFaseResult = await createItem(LISTS.FASI, {
                            Title: fase.Title,
                            AdempimentoID: parseInt(nuovoAdempimentoId),
                            OrdineFase: fase.OrdineFase,
                            DataScadenzaFase: null, // scadenze fasi resettate, da aggiornare manualmente
                            ResponsabileFase: fase.ResponsabileFase || ''
                        });
                        const nuovaFaseId = nuovaFaseResult.id;
                        const cfOrig = allComuniFasi.filter(c => c.FaseID == fase.ID && c.Attivo !== false);
                        for (const cf of cfOrig) {
                            await createItem(LISTS.COMUNI_FASI, {
                                Title: `${nuovoTitolo} - F${fase.OrdineFase} - ${cf.Comune}`,
                                FaseID: parseInt(nuovaFaseId),
                                AdempimentoID: parseInt(nuovoAdempimentoId),
                                Comune: cf.Comune, StatoEnte: 'Da Fare', ProgressEnte: 0, NoteEnte: '', Attivo: true
                            });
                        }
                    }
                } else {
                    const entiOrig = allEnti.filter(e => e.AdempimentoID == adempimentoId);
                    for (const ente of entiOrig) {
                        await createItem(LISTS.ENTI, { Title: `${nuovoTitolo} - ${ente.Comune}`, AdempimentoID: parseInt(nuovoAdempimentoId), Comune: ente.Comune, StatoEnte: 'Da Fare', ProgressEnte: 0, NoteEnte: '' });
                    }
                }

                showAlert(`âœ… Duplicato "${nuovoTitolo}" per ${formatMese(nuovoMese)}!`, 'success');
                document.getElementById('duplicaModal').classList.remove('open');
                document.getElementById('filterMese').value = nuovoMese;
                await loadData();
            } catch (err) {
                showAlert('âŒ Errore duplicazione: ' + err.message, 'error');
                showLoading(false);
            }
        });

        // ============================================================
        // FILTRI RAPIDI
        // ============================================================
        window.filtroRapido = function(tipo) {
            const oggi = new Date(); oggi.setHours(0,0,0,0);
            let filtered = [...allAdempimenti];
            activeFilterResp = document.getElementById('filterResponsabile')?.value || '';

            if (userRole === 'Operatore' && window.currentUserName)
                filtered = filtered.filter(a => isResponsabileInAdempimento(a, window.currentUserName));

            const isCompletato = (a) => {
                if (a.HasFasi === true || a.HasFasi === 'true') {
                    const cf = allComuniFasi.filter(c => c.AdempimentoID == a.ID && c.Attivo !== false);
                    return cf.length > 0 && cf.every(c => c.StatoEnte === 'Completato' || c.StatoEnte === 'Non Gestito');
                }
                const enti = allEnti.filter(e => e.AdempimentoID == a.ID);
                return enti.length > 0 && enti.every(e => e.StatoEnte === 'Completato' || e.StatoEnte === 'Non Gestito');
            };

            if (tipo === 'scaduti') filtered = filtered.filter(a => a.DataScadenza && new Date(a.DataScadenza) < oggi && !isCompletato(a));
            else if (tipo === 'urgenti') filtered = filtered.filter(a => {
                if (!a.DataScadenza) return false;
                const diff = Math.floor((new Date(a.DataScadenza) - oggi) / (1000*60*60*24));
                return diff >= 0 && diff <= 7 && !isCompletato(a);
            });
            else if (tipo === 'completati') filtered = filtered.filter(a => isCompletato(a));

            document.querySelectorAll('.filtro-rapido').forEach(b => b.classList.remove('active'));
            document.getElementById(`filtro-${tipo}`).classList.add('active');

            const container = document.getElementById('adempimentiContainer');
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><h3>Nessun adempimento trovato</h3></div>'; return; }
            filtered.sort((a,b) => { const dA = a.DataScadenza ? new Date(a.DataScadenza) : new Date('2099-12-31'); const dB = b.DataScadenza ? new Date(b.DataScadenza) : new Date('2099-12-31'); return dA - dB; });
            container.innerHTML = filtered.map(a => createAdempimentoCard(a)).join('');
            attachEventListeners();
        };

        // ============================================================
        // COMUNE - CREA NUOVO
        // ============================================================
        document.getElementById('comuneForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('formNomeComune').value;
            const provincia = document.getElementById('formProvincia').value.toUpperCase();
            try {
                showLoading(true);
                await createItem(LISTS.COMUNI, { Title: nome, Provincia: provincia, StatoEnte: 'Attivo' });
                showAlert('âœ… Comune creato!', 'success');
                document.getElementById('comuneModal').classList.remove('open');
                await loadData();
            } catch (err) { showAlert('âŒ Errore: ' + err.message, 'error'); showLoading(false); }
        });

        // ============================================================
        // UTILITY
        // ============================================================
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('adempimentiContainer').style.display = show ? 'none' : 'block';
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function formatMese(yearMonth) {
            if (!yearMonth) return '';
            const [y,m] = yearMonth.split('-');
            const mesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
            return `${mesi[parseInt(m)-1]} ${y}`;
        }

        function getIconaTipologia(t) {
            return { 'ContabilitÃ ': 'ğŸ’°', 'Tributi': 'âš–ï¸', 'Personale': 'ğŸ‘¥', 'Altro': 'ğŸ“‹' }[t] || 'ğŸ“‹';
        }

        window.tornaInAlto = function() { window.scrollTo({ top: 0, behavior: 'smooth' }); };

        // ============================================================
        // INIT
        // ============================================================
        window.addEventListener('load', async function() {
            console.log('ğŸš€ V22 Caricata');
            try {
                await msalInstance.initialize();
                const accounts = msalInstance.getAllAccounts();
                // Controlla se la sessione Ã¨ ancora valida
                const lastLogin = localStorage.getItem('lastLogin');
                const sessionValid = lastLogin && (Date.now() - parseInt(lastLogin)) < (10 * 24 * 60 * 60 * 1000);
                if (accounts.length > 0 && sessionValid) {
                    // Sessione ancora valida: auto-login
                    await handleAuth();
                } else if (accounts.length > 0 && !sessionValid) {
                    // Sessione scaduta: pulisci e mostra login
                    localStorage.removeItem('lastLogin');
                    accounts.forEach(() => msalInstance.setActiveAccount(null));
                }
            } catch (err) { console.error('Errore inizializzazione:', err); }

            // Event listeners
            document.getElementById('loginBtn')?.addEventListener('click', login);
            document.getElementById('logoutBtn')?.addEventListener('click', logout);
            document.getElementById('btnTestOperatore')?.addEventListener('click', async function() {
                testModeOperatore = !testModeOperatore;
                await handleAuth();
            });
            document.getElementById('selectTestOperatore')?.addEventListener('change', async function() {
                const val = this.value;
                if (val) {
                    testModeOperatore = true;
                    testOperatoreName = val;
                } else {
                    testModeOperatore = false;
                    testOperatoreName = '';
                }
                await handleAuth();
            });
            document.getElementById('btnSync')?.addEventListener('click', loadData);
            document.getElementById('btnAddAdempimento')?.addEventListener('click', openAdempimentoModal);
            document.getElementById('btnAddComune')?.addEventListener('click', () => { document.getElementById('comuneForm').reset(); document.getElementById('comuneModal').classList.add('open'); });
            document.getElementById('btnCloseAdempimentoModal')?.addEventListener('click', () => document.getElementById('adempimentoModal').classList.remove('open'));
            document.getElementById('btnCloseComuneModal')?.addEventListener('click', () => document.getElementById('comuneModal').classList.remove('open'));
            document.getElementById('btnCloseCambiaStatoModal')?.addEventListener('click', () => document.getElementById('cambiaStatoModal').classList.remove('open'));
            document.getElementById('btnCloseNoteModal')?.addEventListener('click', () => document.getElementById('noteModal').classList.remove('open'));
            document.getElementById('btnCloseDuplicaModal')?.addEventListener('click', () => document.getElementById('duplicaModal').classList.remove('open'));
            document.getElementById('filterMese')?.addEventListener('change', renderAdempimenti);
            document.getElementById('filterTipologia')?.addEventListener('change', renderAdempimenti);
            document.getElementById('filterStato')?.addEventListener('change', renderAdempimenti);
            document.getElementById('filterResponsabile')?.addEventListener('change', renderAdempimenti);
        });

    </script>
</body>
</html>
